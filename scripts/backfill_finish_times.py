"""Backfill missing finish_time values from scraped RUSA results.

For each rider_ride record with status='Yes' and no finish_time,
match against RUSA data by (rusa_id, date +-3 days, distance_km).
"""
import os
import sys
import psycopg2
import psycopg2.extras
from datetime import datetime, timedelta

DATABASE_URL = os.environ.get('DATABASE_URL')
if not DATABASE_URL:
    print("âŒ DATABASE_URL environment variable not set")
    sys.exit(1)

# Scraped RUSA results: {rusa_id: [(date_str, distance_km, finish_time), ...]}
# date_str format: 'YYYY/MM/DD' as returned by RUSA
RUSA_RESULTS = {
    14715: [  # Raja Aluri
        ('2023/02/18', 200, '10:52'),
        ('2023/03/04', 300, '18:21'),
        ('2023/09/17', 210, '11:33'),
        ('2022/09/24', 300, '17:32'),
        ('2022/10/15', 200, '10:53'),
        ('2021/11/06', 200, '10:16'),
    ],
    14686: [  # Venkatesh Iyengar
        ('2026/02/14', 200, '11:30'),
        ('2025/11/01', 200, '10:51'),
        ('2023/01/28', 200, '11:28'),
        ('2023/02/18', 200, '09:48'),
        ('2023/03/04', 300, '17:08'),
        ('2023/03/11', 400, '23:50'),
        ('2023/03/25', 400, '25:27'),
        ('2023/04/08', 300, '14:15'),
        ('2023/04/15', 300, '13:57'),
        ('2023/04/22', 600, '37:05'),
        ('2023/05/06', 600, '37:18'),
        ('2023/06/11', 600, '39:06'),
        ('2023/07/22', 400, '22:03'),
        ('2023/08/06', 200, '09:10'),
        ('2023/08/20', 1200, '86:11'),
        ('2023/09/16', 210, '09:50'),
        ('2023/10/14', 200, '10:20'),
        ('2023/11/20', 201, '10:44'),
        ('2023/12/09', 215, '12:32'),
        ('2022/01/29', 200, '11:48'),
        ('2022/02/19', 200, '10:24'),
        ('2022/03/12', 300, '18:08'),
        ('2022/04/02', 400, '23:18'),
        ('2022/04/30', 600, '39:28'),
        ('2022/06/11', 300, '18:46'),
        ('2022/06/18', 600, '39:38'),
        ('2022/10/08', 400, '25:05'),
        ('2021/10/09', 200, '11:27'),
        ('2021/11/06', 200, '10:13'),
    ],
    14694: [  # Naveen Kommareddi
        ('2023/01/28', 200, '11:15'),
        ('2023/02/18', 200, '10:10'),
        ('2023/03/04', 300, '16:23'),
        ('2023/03/25', 400, '25:27'),
        ('2023/04/15', 300, '14:16'),
        ('2023/04/22', 600, '37:52'),
        ('2023/05/20', 400, '20:00'),
        ('2023/06/11', 600, '39:06'),
        ('2023/08/20', 1200, '84:42'),
        ('2022/01/29', 200, '10:42'),
        ('2022/02/19', 200, '09:48'),
        ('2022/03/12', 300, '16:05'),
        ('2022/04/02', 400, '23:18'),
        ('2022/04/30', 600, '39:28'),
        ('2022/12/17', 200, '10:33'),
        ('2021/10/09', 200, '11:23'),
        ('2021/11/06', 200, '10:14'),
    ],
    14695: [  # Rohit Pillai
        ('2026/01/24', 200, '10:57'),
        ('2023/01/28', 200, '11:56'),
        ('2023/02/18', 200, '10:03'),
        ('2023/03/04', 300, '16:29'),
        ('2023/03/11', 400, '23:50'),
        ('2023/04/08', 300, '15:56'),
        ('2023/04/22', 600, '38:45'),
        ('2023/08/06', 200, '10:19'),
        ('2023/08/20', 1200, '89:16'),
        ('2022/01/29', 200, '11:09'),
        ('2022/02/19', 200, '10:26'),
        ('2022/06/11', 300, '18:03'),
        ('2022/06/18', 600, '39:52'),
        ('2022/12/03', 200, '13:06'),
        ('2021/10/09', 200, '11:25'),
        ('2021/12/04', 200, '12:10'),
    ],
    14716: [  # Suryanarayanan Rajagopalan
        ('2023/02/04', 200, '12:10'),
        ('2023/03/04', 300, '17:44'),
        ('2023/03/11', 400, '23:50'),
        ('2023/04/08', 300, '16:06'),
        ('2023/04/15', 400, '24:29'),
        ('2023/05/06', 600, '37:36'),
        ('2023/06/11', 600, '39:43'),
        ('2023/08/20', 1200, '89:02'),
        ('2022/01/29', 200, '12:40'),
        ('2022/04/02', 400, '25:58'),
        ('2022/06/11', 300, '18:03'),
        ('2022/08/13', 300, '17:43'),
        ('2022/08/27', 600, '39:09'),
        ('2022/10/08', 400, '25:32'),
        ('2022/10/15', 200, '13:17'),
        ('2022/10/22', 600, '39:26'),
        ('2022/12/03', 200, '13:06'),
        ('2022/12/17', 200, '11:43'),
        ('2021/10/09', 200, '12:06'),
        ('2021/11/06', 200, '11:27'),
        ('2021/12/04', 200, '12:35'),
    ],
    14680: [  # Mihir Sambhus
        ('2026/01/24', 200, '11:11'),
        ('2025/10/12', 200, '12:19'),
        ('2025/11/01', 200, '10:32'),
        ('2025/12/06', 200, '12:16'),
        ('2023/01/28', 200, '11:58'),
        ('2023/02/18', 200, '10:52'),
        ('2023/03/04', 300, '16:59'),
        ('2023/03/11', 400, '23:45'),
        ('2023/04/08', 300, '16:00'),
        ('2023/04/22', 600, '38:38'),
        ('2023/05/06', 600, '37:25'),
        ('2023/05/20', 400, '23:02'),
        ('2023/06/11', 600, '39:43'),
        ('2023/07/15', 300, '14:11'),
        ('2023/07/22', 400, '23:40'),
        ('2023/08/20', 1200, '89:27'),
        ('2023/09/17', 210, '11:25'),
        ('2023/10/21', 203, '12:44'),
        ('2023/11/20', 201, '10:44'),
        ('2023/12/09', 215, '12:16'),
        ('2022/01/29', 200, '10:40'),
        ('2022/02/19', 200, '09:48'),
        ('2022/03/12', 300, '17:31'),
        ('2022/04/02', 400, '25:58'),
        ('2022/06/18', 600, '39:38'),
        ('2022/10/15', 200, '13:17'),
        ('2022/12/03', 200, '13:02'),
        ('2021/10/09', 200, '11:26'),
        ('2021/11/06', 200, '10:13'),
        ('2021/12/04', 200, '12:17'),
    ],
    14692: [  # Shriram Vijayakumar
        ('2026/01/24', 200, '10:01'),
        ('2025/11/01', 200, '10:31'),
        ('2023/01/28', 200, '11:25'),
        ('2023/02/04', 200, '10:51'),
        ('2023/02/18', 200, '09:48'),
        ('2023/03/04', 300, '15:53'),
        ('2023/03/25', 400, '25:26'),
        ('2023/04/08', 300, '14:15'),
        ('2023/04/15', 300, '13:57'),
        ('2023/04/22', 600, '37:05'),
        ('2023/05/06', 600, '37:15'),
        ('2023/08/20', 1200, '86:08'),
        ('2022/01/29', 200, '10:13'),
        ('2022/02/19', 200, '09:35'),
        ('2022/03/12', 300, '16:05'),
        ('2022/04/02', 400, '23:17'),
        ('2022/04/30', 600, '39:28'),
        ('2021/10/09', 200, '11:24'),
        ('2021/11/06', 200, '10:13'),
    ],
    14751: [  # Sandeep Sukhija
        ('2023/02/18', 200, '12:18'),
        ('2022/01/29', 200, '11:45'),
        ('2022/02/19', 200, '10:24'),
        ('2022/03/12', 300, '18:01'),
        ('2021/11/06', 200, '10:52'),
        ('2021/12/04', 200, '12:25'),
    ],
    14795: [  # Anantha Subramanyam
        ('2023/02/18', 200, '10:03'),
        ('2023/03/11', 400, '23:45'),
        ('2023/04/08', 300, '15:56'),
        ('2023/05/06', 600, '37:30'),
        ('2023/06/11', 600, '39:43'),
        ('2023/08/20', 1200, '88:47'),
        ('2022/01/29', 200, '11:17'),
        ('2022/02/19', 200, '09:51'),
        ('2022/04/09', 400, '23:14'),
        ('2022/04/30', 600, '39:05'),
        ('2022/06/11', 300, '18:03'),
        ('2021/11/06', 200, '10:12'),
    ],
    14818: [  # Naresh Polavaram
        ('2023/02/18', 200, '12:24'),
        ('2022/02/19', 200, '10:24'),
    ],
    14829: [  # Kiron Vijayasankar
        ('2026/01/24', 200, '10:48'),
        ('2026/02/14', 200, '10:42'),
        ('2025/10/12', 200, '12:18'),
        ('2023/02/18', 200, '10:39'),
        ('2023/04/08', 300, '16:06'),
        ('2023/04/15', 400, '24:21'),
        ('2023/05/06', 600, '37:15'),
        ('2022/01/29', 200, '10:38'),
        ('2022/02/19', 200, '09:49'),
        ('2022/03/12', 300, '17:31'),
        ('2022/09/24', 300, '17:32'),
        ('2022/10/08', 400, '25:05'),
        ('2021/11/06', 200, '11:02'),
    ],
    14832: [  # Sriharsha Devineni
        ('2026/01/24', 200, '10:01'),
        ('2026/02/14', 200, '09:55'),
        ('2025/12/06', 200, '09:43'),
        ('2023/01/28', 200, '11:15'),
        ('2023/03/04', 300, '17:07'),
        ('2023/03/11', 400, '23:27'),
        ('2023/04/08', 300, '14:15'),
        ('2023/04/22', 600, '37:52'),
        ('2023/05/20', 400, '20:00'),
        ('2023/06/11', 600, '39:06'),
        ('2023/08/20', 1200, '86:08'),
        ('2022/01/29', 200, '10:39'),
        ('2022/02/19', 200, '09:38'),
        ('2022/02/26', 200, '11:36'),
        ('2022/03/12', 300, '16:05'),
        ('2022/04/02', 400, '23:18'),
        ('2022/04/30', 600, '39:28'),
        ('2022/06/11', 300, '18:44'),
        ('2022/09/24', 300, '17:32'),
        ('2022/10/08', 400, '25:04'),
        ('2022/10/22', 600, '38:38'),
        ('2022/11/05', 200, '08:45'),
        ('2022/11/12', 200, '11:25'),
        ('2022/12/17', 200, '10:33'),
        ('2021/11/06', 200, '10:13'),
        ('2021/12/04', 200, '12:19'),
    ],
    14873: [  # Ashok Natesan
        ('2026/01/30', 204, '10:42'),
        ('2025/11/01', 200, '10:20'),
        ('2025/12/06', 200, '12:16'),
        ('2023/01/28', 200, '12:11'),
        ('2023/02/18', 200, '10:19'),
        ('2023/03/04', 300, '17:41'),
        ('2023/03/11', 400, '23:45'),
        ('2023/04/15', 300, '17:38'),
        ('2023/05/20', 400, '23:25'),
        ('2023/06/11', 600, '38:05'),
        ('2022/01/29', 200, '11:43'),
        ('2022/02/19', 200, '09:48'),
        ('2022/03/12', 300, '17:40'),
        ('2022/05/14', 400, '24:41'),
        ('2022/06/18', 600, '39:41'),
        ('2022/11/05', 200, '11:42'),
    ],
    14923: [  # Vishal Powar
        ('2026/01/24', 200, '10:57'),
        ('2023/01/28', 200, '12:20'),
        ('2022/01/29', 200, '11:45'),
        ('2022/02/19', 200, '10:13'),
        ('2022/06/11', 300, '18:46'),
        ('2022/10/08', 400, '25:25'),
    ],
    14924: [  # Nikhil Mahajan
        ('2025/10/12', 200, '12:19'),
        ('2023/01/28', 200, '11:25'),
        ('2023/03/25', 400, '25:26'),
        ('2023/04/01', 300, '16:36'),
        ('2023/05/06', 600, '37:15'),
        ('2023/08/20', 1200, '81:01'),
        ('2022/01/29', 200, '11:15'),
        ('2022/02/19', 200, '11:47'),
        ('2022/03/12', 300, '17:29'),
        ('2022/04/02', 400, '23:20'),
        ('2022/04/30', 600, '39:47'),
        ('2022/06/11', 300, '18:46'),
    ],
    15124: [  # Nitin Shinde
        ('2023/02/18', 200, '11:18'),
        ('2023/03/04', 300, '18:21'),
        ('2023/03/11', 400, '26:12'),
        ('2023/05/06', 600, '38:08'),
        ('2023/08/20', 1200, '89:27'),
        ('2022/02/19', 200, '11:48'),
        ('2022/06/11', 300, '18:03'),
        ('2022/10/08', 400, '25:30'),
    ],
    15215: [  # Vijayshree Sundaram
        ('2025/11/01', 200, '10:08'),
        ('2023/01/28', 200, '13:22'),
        ('2023/02/18', 200, '11:18'),
        ('2023/03/04', 300, '18:21'),
        ('2023/03/11', 400, '26:12'),
        ('2023/05/06', 600, '38:08'),
        ('2023/06/10', 300, '16:09'),
        ('2023/08/20', 1200, '86:37'),
        ('2022/02/26', 200, '11:36'),
        ('2022/03/12', 300, '17:35'),
        ('2022/06/11', 300, '18:03'),
        ('2022/06/18', 600, '39:22'),
        ('2022/10/08', 400, '25:22'),
    ],
    14093: [  # Gokul Ramaswamy
        ('2023/03/11', 200, '11:33'),
        ('2023/09/10', 112, '05:37'),
        ('2022/01/29', 200, '11:44'),
        ('2022/02/19', 200, '10:56'),
        ('2022/03/12', 300, '17:39'),
        ('2022/04/09', 150, '07:00'),
        ('2022/05/14', 400, '26:49'),
        ('2022/09/10', 200, '12:17'),
    ],
    14745: [  # Siva Annamalai
        ('2026/02/14', 200, '11:09'),
        ('2023/02/18', 200, '10:06'),
        ('2023/03/04', 300, '16:29'),
        ('2023/03/11', 400, '23:45'),
        ('2023/05/06', 600, '38:21'),
        ('2022/02/19', 200, '09:59'),
        ('2022/03/12', 300, '16:12'),
        ('2022/06/18', 600, '39:00'),
        ('2022/10/08', 400, '25:27'),
        ('2021/10/09', 200, '12:25'),
        ('2021/11/06', 200, '10:36'),
    ],
    16018: [  # Amar Raghu
        ('2023/02/18', 200, '11:18'),
    ],
    18274: [  # Bharadwaj Ramesh
        ('2026/01/24', 200, '10:09'),
        ('2025/11/01', 200, '09:57'),
    ],
    14759: [  # Bhupendra Jain
        ('2026/01/24', 200, '10:38'),
        ('2025/11/01', 200, '10:41'),
        ('2025/12/06', 200, '09:43'),
        ('2021/10/09', 200, '11:26'),
    ],
    18646: [  # DJ More
        ('2026/02/14', 200, '09:39'),
    ],
    15573: [  # Gautam Reddy
        ('2026/01/24', 200, '09:25'),
        ('2026/02/14', 200, '08:27'),
        ('2025/11/01', 200, '09:00'),
        ('2024/02/24', 200, '10:21'),
        ('2023/11/04', 200, '10:25'),
        ('2022/08/20', 300, '16:58'),
    ],
    18575: [  # Jagjot Kaur
        ('2026/01/24', 200, '11:11'),
        ('2026/02/14', 200, '10:57'),
        ('2025/12/06', 200, '12:16'),
    ],
    18463: [  # Arjun Periasamy
        ('2026/01/24', 200, '12:15'),
        ('2026/02/14', 200, '11:30'),
        ('2025/11/01', 200, '10:48'),
    ],
    14850: [  # Murali Vijayaraghavan
        ('2022/01/29', 200, '10:18'),
        ('2022/02/19', 200, '09:43'),
        ('2022/03/12', 300, '15:59'),
        ('2022/04/09', 400, '23:14'),
        ('2022/04/30', 600, '39:05'),
        ('2021/11/06', 200, '11:24'),
        ('2021/12/04', 200, '12:19'),
    ],
    14696: [  # Saravana Vasudevan
        ('2023/02/04', 200, '11:46'),
        ('2023/02/18', 200, '09:48'),
        ('2023/03/04', 300, '15:53'),
        ('2022/01/29', 200, '10:13'),
        ('2022/02/19', 200, '09:35'),
        ('2022/03/12', 300, '16:05'),
        ('2022/04/02', 400, '23:19'),
        ('2022/10/22', 600, '38:38'),
        ('2022/11/05', 200, '08:45'),
        ('2022/12/17', 200, '10:33'),
        ('2021/10/09', 200, '11:21'),
        ('2021/11/06', 200, '10:13'),
    ],
}


def parse_rusa_date(d):
    """Convert RUSA date 'YYYY/MM/DD' to datetime.date."""
    return datetime.strptime(d, '%Y/%m/%d').date()


def parse_db_date(d):
    """Convert DB date to datetime.date. PostgreSQL returns date objects directly."""
    if not d:
        return None
    # PostgreSQL returns datetime.date objects directly
    if hasattr(d, 'year'):
        return d
    # Fallback for string formats
    for fmt in ('%Y-%m-%d', '%m/%d/%Y'):
        try:
            return datetime.strptime(d, fmt).date()
        except (ValueError, TypeError):
            continue
    return None


def distance_matches(db_km, rusa_km):
    """Check if distances match, with tolerance for slightly different values."""
    if db_km == 0 and rusa_km > 0:
        return False
    if db_km == rusa_km:
        return True
    # Allow tolerance for permanents (200km vs 201/203/210/215)
    if abs(db_km - rusa_km) <= 20:
        return True
    # PBP: 1200km
    if db_km >= 1000 and rusa_km >= 1000:
        return True
    return False


def find_rusa_finish_time(rusa_id, ride_date, distance_km):
    """Find matching RUSA result for a rider/date/distance."""
    results = RUSA_RESULTS.get(rusa_id, [])
    if not results or not ride_date:
        return None

    for rusa_date_str, rusa_km, finish_time in results:
        rusa_date = parse_rusa_date(rusa_date_str)
        if abs((ride_date - rusa_date).days) <= 5 and distance_matches(distance_km, rusa_km):
            return finish_time
    return None


def main():
    conn = psycopg2.connect(DATABASE_URL)
    cur = conn.cursor(cursor_factory=psycopg2.extras.RealDictCursor)

    # Get all records needing finish times
    cur.execute("""
        SELECT rr.id, rr.rider_id, rr.ride_id, rr.status, rr.finish_time,
               r.rusa_id, ri.date, ri.distance_km, ri.name as ride_name,
               r.first_name, r.last_name
        FROM rider_ride rr
        JOIN rider r ON rr.rider_id = r.id
        JOIN ride ri ON rr.ride_id = ri.id
        WHERE rr.status = 'FINISHED' AND (rr.finish_time IS NULL OR rr.finish_time = '')
        ORDER BY ri.date, r.first_name
    """)
    rows = cur.fetchall()

    updated = 0
    not_found = 0

    for row in rows:
        ride_date = parse_db_date(row['date'])
        rusa_id = row['rusa_id']
        distance_km = row['distance_km']

        finish_time = find_rusa_finish_time(rusa_id, ride_date, distance_km)

        if finish_time:
            cur.execute("UPDATE rider_ride SET finish_time = %s WHERE id = %s",
                        (finish_time, row['id']))
            print(f"  UPDATED: {row['first_name']} {row['last_name']} | "
                  f"{row['date']} {row['ride_name']} ({distance_km}km) -> {finish_time}")
            updated += 1
        else:
            print(f"  SKIP:    {row['first_name']} {row['last_name']} | "
                  f"{row['date']} {row['ride_name']} ({distance_km}km) - no RUSA match")
            not_found += 1

    conn.commit()
    conn.close()

    print(f"\n=== SUMMARY ===")
    print(f"Updated:   {updated}")
    print(f"No match:  {not_found}")
    print(f"Total:     {updated + not_found}")


if __name__ == '__main__':
    main()
