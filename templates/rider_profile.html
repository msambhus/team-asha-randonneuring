{% extends "base.html" %}
{% block title %}{{ rider.first_name }} {{ rider.last_name }} - Team Asha Randonneuring{% endblock %}

{% block content %}
<div class="hero" style="padding:30px 20px;">
{% if rider.photo_filename %}
<img src="{{ url_for('static', filename='riders/' + rider.photo_filename) }}" alt="{{ rider.first_name }} {{ rider.last_name }}" style="width:150px;height:150px;border-radius:50%;object-fit:cover;border:4px solid white;margin-bottom:15px;">
{% endif %}
<h1>{{ rider.first_name }} {{ rider.last_name }}</h1>
<p>RUSA# {{ rider.rusa_id }}</p>
</div>

<div class="stats-row">
<div class="stat-card"><div class="number">{{ career_rides }}</div><div class="label">Career Rides</div></div>
<div class="stat-card"><div class="number">{{ career_kms|commafy }}</div><div class="label">Career KMs</div></div>
{% if total_srs > 0 %}
<div class="stat-card"><div class="number" style="color:var(--accent);">{% if total_srs > 1 %}SR*{{ total_srs }}{% else %}SR{% endif %}</div><div class="label">Super Randonneur</div></div>
{% endif %}
{% if total_r12s > 0 %}
<div class="stat-card"><div class="number" style="color:#805ad5;">{% if total_r12s > 1 %}R-12*{{ total_r12s }}{% else %}R-12{% endif %}</div><div class="label">Randonneur 12</div></div>
{% endif %}
{% if rider.pbp_2023_status == 'Yes' %}
<div class="stat-card"><div class="number" style="font-size:1.4rem;"><span class="pbp-badge" style="font-size:1rem;">PBP 2023</span></div><div class="label">Paris-Brest-Paris</div></div>
{% endif %}
{% if fitness_score %}
<div class="stat-card"><div class="number" style="color:{% if fitness_score.total >= 70 %}#38a169{% elif fitness_score.total >= 40 %}#d69e2e{% else %}#e53e3e{% endif %};">{{ fitness_score.total }}</div><div class="label">Fitness Score</div></div>
{% endif %}
</div>

<div class="container section">
<a href="javascript:history.back()" class="back-link">&larr; Back</a>

{% if rider.bio %}
<div class="card">
<p>{{ rider.bio }}</p>
</div>
{% endif %}

{# ===== UPCOMING RIDES (COMPACT GRID) ===== #}
{% if upcoming_rides %}
<div style="margin-bottom:30px;">
    <h3 style="color:var(--primary); margin-bottom:12px;">Upcoming Rides</h3>
    <div style="display:grid; grid-template-columns:repeat(auto-fill, minmax(220px, 1fr)); gap:10px;">
    {% for ride in upcoming_rides %}
    <div style="padding:14px; background:white; border-radius:10px; border:1px solid #e2e8f0; border-top:3px solid {% if ride.readiness %}{{ ride.readiness.color }}{% else %}var(--primary){% endif %};">
        {# Ride name + maybe label #}
        <div style="font-weight:600; font-size:0.85rem; color:var(--text); margin-bottom:6px; line-height:1.3;">
            {{ ride.name }}
            {% if ride.signup_status == 'MAYBE' %}<span style="font-size:0.65rem; font-weight:500; color:#d69e2e;">(Maybe)</span>{% endif %}
        </div>
        {# Date + distance #}
        <div style="font-size:0.75rem; color:var(--text-light); margin-bottom:8px;">
            {{ ride.date }}
            {% if ride.distance_miles %} &bull; {{ ride.distance_miles|round(0)|int }} mi{% elif ride.distance_km %} &bull; {{ (ride.distance_km * 0.621371)|round(0)|int }} mi{% endif %}
            {% if ride.elevation_ft %} &bull; {{ "{:,}".format(ride.elevation_ft) }} ft{% endif %}
        </div>
        {# Readiness score + label #}
        {% if ride.readiness %}
        <div style="display:flex; align-items:center; gap:8px;">
            <div style="width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:0.9rem; font-weight:800; color:white; background:{{ ride.readiness.color }};">
                {{ ride.readiness.score }}
            </div>
            <div style="display:inline-block; padding:2px 8px; border-radius:10px; font-size:0.6rem; font-weight:700; text-transform:uppercase; letter-spacing:0.4px; color:white; background:{{ ride.readiness.color }};">
                {% if ride.readiness.level == 'ready' %}Ready{% elif ride.readiness.level == 'caution' %}Needs Work{% else %}Not Ready{% endif %}
            </div>
        </div>
        {% endif %}
        {% if ride.plan_slug %}
        <div style="margin-top:6px;"><a href="{{ url_for('riders.ride_plan_detail', slug=ride.plan_slug) }}" style="font-size:0.72rem; color:var(--primary);">Plan &rarr;</a></div>
        {% endif %}
    </div>
    {% endfor %}
    </div>
</div>
{% endif %}

{# ===== RECENT TRAINING (STRAVA) ===== #}
{% if has_strava and training_rides %}
<div style="margin-bottom:30px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:8px;">
        <h3 style="color:var(--primary); margin:0;">Recent Training</h3>
        <img src="{{ url_for('static', filename='img/powered_by_strava.svg') }}" alt="Powered by Strava" style="height:24px;">
    </div>

    {# Fitness Score Breakdown #}
    {% if fitness_score %}
    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(90px, 1fr)); gap:10px; margin-bottom:20px; padding:14px; background:#f7fafc; border-radius:8px; border:1px solid #e2e8f0;">
        <div style="text-align:center;">
            <div style="font-size:1.8rem; font-weight:800; color:{% if fitness_score.total >= 70 %}#38a169{% elif fitness_score.total >= 40 %}#d69e2e{% else %}#e53e3e{% endif %};">{{ fitness_score.total }}</div>
            <div style="font-size:0.65rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Overall</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">{{ fitness_score.frequency }}</div>
            <div style="font-size:0.65rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Freq /25</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">{{ fitness_score.volume }}</div>
            <div style="font-size:0.65rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Vol /35</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">{{ fitness_score.intensity }}</div>
            <div style="font-size:0.65rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Int /25</div>
        </div>
        <div style="text-align:center;">
            <div style="font-size:1.1rem; font-weight:700; color:var(--primary);">{{ fitness_score.recency }}</div>
            <div style="font-size:0.65rem; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Rec /15</div>
        </div>
    </div>
    {% endif %}

    {# Training Rides Table #}
    <div class="table-wrap">
    <table>
    <thead>
        <tr>
            <th>Date</th>
            <th>Activity</th>
            <th style="text-align:right;">Distance</th>
            <th style="text-align:right;">Elevation</th>
            <th style="text-align:right;">Duration</th>
            <th style="text-align:center;">HR</th>
            <th style="text-align:center;">Power</th>
            <th style="text-align:center;">Grade</th>
        </tr>
    </thead>
    <tbody>
    {% for ride in training_rides %}
        <tr>
            <td style="white-space:nowrap; font-size:0.85rem;">
                {% if ride.start_date_local %}
                    {{ ride.start_date_local.strftime('%b %d') if ride.start_date_local is not string else ride.start_date_local[:10] }}
                {% endif %}
            </td>
            <td>
                <a href="{{ ride.strava_url or ('https://www.strava.com/activities/' ~ ride.strava_activity_id) }}" target="_blank" rel="noopener" style="color:var(--primary); text-decoration:none; font-weight:500;" title="View on Strava">
                    {{ ride.name or 'Ride' }}
                </a>
            </td>
            <td style="text-align:right; white-space:nowrap;">{{ ((ride.distance or 0) / 1609.34)|round(1) }} mi</td>
            <td style="text-align:right; white-space:nowrap;">{{ "{:,}".format(((ride.total_elevation_gain or 0) * 3.28084)|round(0)|int) }} ft</td>
            <td style="text-align:right; white-space:nowrap; color:#666;">
                {% if ride.moving_time %}
                    {% set hrs = (ride.moving_time // 3600)|int %}
                    {% set mins = ((ride.moving_time % 3600) // 60)|int %}
                    {% if hrs > 0 %}{{ hrs }}h {{ mins }}m{% else %}{{ mins }}m{% endif %}
                {% endif %}
            </td>
            <td style="text-align:center; font-size:0.85rem;">
                {% if ride.has_heartrate and ride.average_heartrate %}
                    <span title="Avg HR">{{ ride.average_heartrate|round(0)|int }}</span>
                {% else %}
                    <span style="color:#cbd5e0;">&mdash;</span>
                {% endif %}
            </td>
            <td style="text-align:center; font-size:0.85rem;">
                {% if ride.device_watts and ride.average_watts %}
                    <span title="Avg Power">{{ ride.average_watts|round(0)|int }}W</span>
                {% else %}
                    <span style="color:#cbd5e0;">&mdash;</span>
                {% endif %}
            </td>
            <td style="text-align:center;">
                <span style="display:inline-block; min-width:42px; padding:3px 8px; border-radius:12px; font-size:0.75rem; font-weight:700; color:white; background:{{ ride.color }}; letter-spacing:0.3px;" title="Score: {{ ride.total }}/100">
                    {{ ride.grade }}
                    {% if ride.trend == 'building' %}&#x25B2;{% elif ride.trend == 'declining' %}&#x25BC;{% endif %}
                </span>
            </td>
        </tr>
    {% endfor %}
    </tbody>
    </table>
    </div>
</div>
{% endif %}

{# ===== BREVET SEASON HISTORY ===== #}
{% for sd in season_data %}
<div class="season-block">
<h3>{{ sd.season.name }} Season
{% if sd.sr_count > 0 %} &bull; <span class="sr-badge">{% if sd.sr_count > 1 %}SR*{{ sd.sr_count }}{% else %}SR{% endif %}</span>{% endif %}
{% set season_years = sd.season.name.split('-') %}
{% set r12_in_season = [] %}
{% for award in r12_awards %}{% if award.end_year|string in season_years %}{% if r12_in_season.append(1) %}{% endif %}{% endif %}{% endfor %}
{% if r12_in_season|length > 0 %} &bull; <span style="display:inline-block; padding:2px 10px; border-radius:12px; font-size:0.75rem; font-weight:700; color:white; background:#805ad5;">{% if r12_in_season|length > 1 %}R-12*{{ r12_in_season|length }}{% else %}R-12{% endif %}</span>{% endif %}
{% if sd.season.name == '2022-2023' and rider.pbp_2023_status == 'Yes' %} &bull; <span class="pbp-badge">PBP Finisher</span>{% endif %}
{% if sd.season.name == '2022-2023' and rider.pbp_2023_status == 'DNF' %} &bull; <span class="badge badge-dnf">PBP DNF</span>{% endif %}
</h3>
<p>Rides: <strong>{{ sd.rides }}</strong> &bull; Distance: <strong>{{ sd.kms|commafy }} km</strong></p>
<div class="table-wrap" style="margin-top:10px;">
<table>
<thead><tr><th>Date</th><th>Event</th><th>Distance</th><th>Elevation</th><th>Time</th></tr></thead>
<tbody>
{% for p in sd.participation %}
{% if p.status|lower == 'finished' or p.status|lower == 'dnf' %}
<tr>
<td>{{ p.date }}</td>
<td>{{ p.ride_name }}
{% if p.rwgps_url %} <a href="{{ p.rwgps_url }}" target="_blank" style="font-size:0.8rem;">view route</a>{% endif %}
{% if p.status|lower == 'dnf' %} <span class="badge badge-dnf">DNF</span>{% endif %}
</td>
<td>{{ p.distance_km }} km</td>
<td>{% if p.elevation_ft %}{{ "{:,}".format(p.elevation_ft) }} ft{% endif %}</td>
<td style="text-align:center;color:#666;">{{ p.finish_time or '' }}</td>
</tr>
{% endif %}
{% endfor %}
</tbody>
</table>
</div>
</div>
{% endfor %}


{% if session.get('logged_in') %}
<p style="margin-top:20px;"><a href="{{ url_for('riders.rider_edit', rusa_id=rider.rusa_id) }}" class="btn btn-primary btn-sm">Edit Profile</a></p>
{% endif %}

</div>
{% endblock %}
