{% extends "base.html" %}
{% block title %}{{ plan.name }} - Team Asha Randonneuring{% endblock %}

{% block extra_head %}
<style>
/* ===== JOURNEY STRIP ===== */
.journey-strip {
    display: flex;
    align-items: flex-start;
    overflow-x: auto;
    padding: 16px 0 8px;
    gap: 0;
    scrollbar-width: thin;
}
.journey-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 72px;
    max-width: 110px;
    position: relative;
    flex: 1;
}
.journey-node:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 9px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: var(--border);
    z-index: 0;
}
.journey-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2.5px solid white;
    z-index: 1;
    flex-shrink: 0;
}
.journey-node.start .journey-dot,
.journey-node.finish .journey-dot,
.journey-node.control .journey-dot {
    width: 16px;
    height: 16px;
}
.journey-label {
    font-size: 0.65rem;
    color: var(--text);
    text-align: center;
    margin-top: 6px;
    font-weight: 500;
    line-height: 1.2;
    word-break: break-word;
    padding: 0 2px;
}
.journey-dist {
    font-size: 0.6rem;
    color: var(--text-light);
    margin-top: 1px;
    font-variant-numeric: tabular-nums;
}
.journey-eta {
    font-size: 0.7rem;
    color: #0369a1;
    margin-top: 3px;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
}

/* ===== TERRAIN DIFFICULTY STRIP ===== */
.terrain-strip {
    display: flex;
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    background: var(--border);
}
.terrain-seg {
    height: 100%;
    transition: opacity 0.15s;
    position: relative;
    cursor: default;
}
.terrain-seg:hover { opacity: 0.7; }

/* ===== SEGMENT CARDS ===== */
.segment-cards {
    display: flex;
    flex-direction: column;
    gap: 0;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
}
.segment-card {
    padding: 14px 18px;
    border-left: 4px solid var(--border);
    position: relative;
    transition: background 0.12s;
    border-bottom: 1px solid #f1f5f9;
}
.segment-card:last-child { border-bottom: none; }
.segment-card:hover { background: #fafbfc; }

.segment-header {
    display: flex;
    align-items: center;
    gap: 10px;
}
.stop-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 0.75rem;
    flex-shrink: 0;
}
.stop-icon.start { background: #dcfce7; color: #166534; }
.stop-icon.finish { background: #fee2e2; color: #991b1b; }
.stop-icon.control { background: #dbeafe; color: #1e40af; }
.stop-icon.rest { background: #fef3c7; color: #92400e; }
.stop-icon.waypoint { background: #f1f5f9; color: #64748b; }

.segment-loc { flex: 1; min-width: 0; }
.segment-loc-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.3;
}
.segment-loc-notes {
    font-size: 0.78rem;
    color: var(--text-light);
    margin-top: 2px;
    line-height: 1.4;
}
.segment-metrics {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    margin-top: 14px;
    margin-left: 15px;
    padding-top: 14px;
    border-top: 1px solid #e2e8f0;
}
.metric { 
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 3px;
    min-width: 60px;
}
.metric-value {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--text);
    font-variant-numeric: tabular-nums;
}
.metric-value.elev { color: #dc2626; }
.metric-label {
    font-size: 0.65rem;
    color: #94a3b8;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-weight: 600;
}

/* Difficulty stripe on right edge */
.diff-stripe {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 3px;
}

/* ===== TIMELINE LAYOUT ===== */
.timeline-container {
    position: relative;
    padding-left: 0;
    border: none;
    border-radius: 0;
    overflow: visible;
}
/* Timeline node connector */
.timeline-container .segment-card {
    position: relative;
    z-index: 1;
    border-radius: 8px;
    margin-bottom: 4px;
    border: 1px solid var(--border);
    border-left: 4px solid var(--border);
    background: white;
}
/* Controls as section headers ‚Äî bold divider above */
.timeline-container .segment-card.level-control {
    margin-top: 18px;
    padding-top: 14px;
    border-top: 2px solid #e2e8f0;
}
.timeline-container .segment-card.level-control .stop-name {
    font-weight: 700;
    font-size: 1.02rem;
}
/* Waypoints ‚Äî subordinate, lighter styling */
.timeline-container .segment-card.level-waypoint .stop-name {
    color: #475569;
    font-weight: 500;
}
/* Start/Finish ‚Äî bold treatment */
.timeline-container .segment-card.level-start .stop-name,
.timeline-container .segment-card.level-finish .stop-name {
    font-weight: 700;
    font-size: 1.02rem;
}
/* Break chip pills */
.break-chips-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
    margin-left: 15px;
}
.break-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 12px;
    background: #fef3c7;
    color: #92400e;
    font-size: 0.73rem;
    font-weight: 600;
    white-space: nowrap;
    border: 1px solid #fcd34d;
}
.break-chip .break-icon { font-size: 0.7rem; }
/* Seg time combined annotation */
.seg-time-break-note {
    font-size: 0.65rem;
    color: #92400e;
    font-weight: 500;
    margin-left: 2px;
}
@media (max-width: 768px) {
    .timeline-container { padding-left: 0; }
}

/* ===== TIME-OF-DAY CHART (grid layout) ===== */
.tod-grid {
    display: grid;
    grid-template-columns: minmax(180px, 2.5fr) 75px 60px 70px 1fr;
    gap: 2px 10px;
    align-items: center;
    font-size: 0.8rem;
}
.tod-header {
    font-size: 0.65rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    font-weight: 600;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 2px;
}
.tod-label {
    font-weight: 500;
    color: var(--text);
    padding: 4px 0;
    line-height: 1.3;
}
.tod-time {
    font-weight: 600;
    color: var(--primary);
    font-variant-numeric: tabular-nums;
    text-align: right;
    padding: 4px 0;
}
.tod-dist {
    text-align: right;
    font-weight: 500;
    color: var(--text-light);
    font-variant-numeric: tabular-nums;
    font-size: 0.78rem;
    padding: 4px 0;
}
.tod-bank {
    text-align: right;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    padding: 4px 0;
}
.tod-bar-bg {
    height: 7px;
    background: #f1f5f9;
    border-radius: 4px;
    overflow: hidden;
}
.tod-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* ===== VIEW TOGGLE ===== */
.view-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-light);
    background: white;
    cursor: pointer;
    transition: all 0.15s;
}
.view-toggle:hover { border-color: var(--primary); color: var(--primary); }
.view-toggle.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ===== DATA TABLE ===== */
.plan-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.82rem;
}
.plan-table thead th {
    background: var(--primary);
    color: white;
    font-weight: 600;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 9px 10px;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
}
.plan-table thead th:first-child { border-radius: 8px 0 0 0; }
.plan-table thead th:last-child { border-radius: 0 8px 0 0; }
.plan-table tbody td {
    padding: 9px 10px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}
.plan-table tbody tr:last-child td { border-bottom: none; }
.plan-table tbody tr:hover { background: #f7fafc; }
.type-badge {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}
.type-badge.start { background: #dcfce7; color: #166534; }
.type-badge.finish { background: #fee2e2; color: #991b1b; }
.type-badge.control { background: #dbeafe; color: #1e40af; }
.type-badge.rest { background: #fef3c7; color: #92400e; }
.type-badge.waypoint { background: #f1f5f9; color: #475569; }
.num-cell {
    text-align: right;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
}
.num-cell.highlight { font-weight: 700; color: var(--primary); }
.plan-table tfoot td {
    padding: 10px;
    font-weight: 700;
    background: #f8fafc;
    border-top: 2px solid var(--border);
    font-size: 0.82rem;
}

/* Difficulty badge */
.diff-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* ===== LEGEND ===== */
.plan-legend {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    padding: 8px 14px;
    background: #f8fafc;
    border-radius: 8px;
    font-size: 0.75rem;
    color: var(--text-light);
}
.plan-legend-item { display: inline-flex; align-items: center; gap: 5px; }
.plan-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ===== ROUTE LINKS ===== */
.route-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    transition: box-shadow 0.15s, transform 0.15s;
}
.route-link:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}
.route-link img { width: 18px; height: 18px; }

/* ===== SECTION HEADERS ===== */
.section-label {
    font-size: 0.78rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    font-weight: 600;
    margin-bottom: 8px;
}

/* ===== WEATHER ===== */
.weather-section {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    padding: 12px 16px;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
}
.weather-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: #0284c7;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.15s;
}
.weather-btn:hover { background: #0369a1; }
.weather-btn:disabled { background: #94a3b8; cursor: not-allowed; }

/* ===== START TIME INPUT ===== */
.start-time-input {
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--primary);
    background: white;
}

/* ===== ELEVATION CHART ===== */
.elevation-chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid var(--border);
}
.elevation-chart {
    height: 180px;
    position: relative;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.elevation-profile {
    height: 100%;
    display: flex;
    align-items: flex-end;
    gap: 2px;
    min-width: 100%;
}
.elevation-bar {
    flex: 1;
    min-width: 8px;
    background: linear-gradient(to top, #3b82f6, #60a5fa);
    border-radius: 2px 2px 0 0;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}
.elevation-bar:hover {
    filter: brightness(1.2);
    transform: translateY(-4px);
}
.elevation-bar.control {
    background: linear-gradient(to top, #dc2626, #ef4444);
}
.elevation-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.7rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
}
.elevation-bar:hover .elevation-tooltip {
    opacity: 1;
}

/* ===== COLLAPSIBLE SECTIONS ===== */
.collapsible-section {
    margin-bottom: 20px;
}
.collapsible-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border);
    user-select: none;
}
.collapsible-header:hover {
    background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
}
.collapsible-title {
    font-weight: 700;
    color: var(--primary);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
}
.collapsible-icon {
    font-size: 1.2rem;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.collapsible-section.expanded .collapsible-icon {
    transform: rotate(180deg);
}
.collapsible-section.expanded .collapsible-content {
    max-height: 10000px;
}

/* ===== QUICK ACTION BUTTONS ===== */
.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.quick-action-btn {
    flex: 1;
    min-width: 140px;
    padding: 12px 16px;
    background: linear-gradient(135deg, white, #f9fafb);
    border: 2px solid var(--border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
}
.quick-action-btn:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* ===== ENHANCED CARD ANIMATIONS ===== */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.segment-card {
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
}
.segment-card:nth-child(1) { animation-delay: 0.05s; }
.segment-card:nth-child(2) { animation-delay: 0.1s; }
.segment-card:nth-child(3) { animation-delay: 0.15s; }
.segment-card:nth-child(4) { animation-delay: 0.2s; }
.segment-card:nth-child(5) { animation-delay: 0.25s; }
.segment-card:nth-child(n+6) { animation-delay: 0.3s; }

/* ===== SIGNUP MODAL ===== */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    animation: fadeIn 0.2s;
}
.modal-content {
    background: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    animation: slideIn 0.3s;
}
.modal-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0;
}
.modal-close {
    font-size: 2rem;
    font-weight: 700;
    color: #000;
    cursor: pointer;
    border: 2px solid #000;
    background: #fff;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
    transition: all 0.2s;
    flex-shrink: 0;
}
.modal-close:hover {
    background: #f3f4f6;
    border-color: #000;
    transform: rotate(90deg) scale(1.1);
}
.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}
.rider-list-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
}
.rider-list-item:last-child {
    border-bottom: none;
}
.rider-list-item:hover {
    background: #f8fafc;
}
.rider-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
    flex-shrink: 0;
}
.rider-info {
    flex: 1;
}
.rider-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
}
.rider-rusa {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 2px;
}
.rider-status-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.rider-status-badge.signed-up {
    background: #dcfce7;
    color: #166534;
}
.rider-status-badge.finished {
    background: #dbeafe;
    color: #1e40af;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* ===== CUSTOM PLAN BANNER ===== */
.custom-plan-banner {
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 2px solid #0ea5e9;
    border-radius: 12px;
    padding: 16px 20px;
    margin-bottom: 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
}

.custom-plan-banner h3 {
    margin: 0;
    color: #0369a1;
    font-size: 1rem;
    font-weight: 700;
}

.custom-plan-banner p {
    margin: 4px 0 0 0;
    color: #0284c7;
    font-size: 0.85rem;
}

.btn-custom-plan {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9rem;
}

.btn-custom-plan:hover {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-custom-plan.active {
    box-shadow: 0 0 0 3px rgba(255,255,255,0.9), 0 0 0 5px currentColor;
    transform: scale(1.05);
    font-weight: 700;
}

.btn-custom-plan.create {
    background: #22c55e;
}

.btn-custom-plan.create:hover {
    background: #16a34a;
}

.shared-plans-info {
    font-size: 0.8rem;
    color: #0284c7;
    display: flex;
    align-items: center;
    gap: 6px;
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .elevation-chart {
        height: 140px;
    }
    .elevation-chart-container {
        padding: 16px;
        margin-bottom: 20px;
    }
    .quick-action-btn {
        min-width: 120px;
        font-size: 0.8rem;
        padding: 10px 14px;
    }
    .collapsible-header {
        padding: 12px 14px;
    }
    .segment-card {
        padding: 14px 16px;
        border-radius: 10px;
    }
    .plan-table { font-size: 0.75rem; }
    .plan-table thead th, .plan-table tbody td { padding: 7px 6px; }
    .segment-metrics { gap: 10px; }
    .metric { min-width: 44px; }
    .metric-value { font-size: 0.85rem; }
    .tod-grid { grid-template-columns: minmax(100px, 2fr) 60px 50px 55px 1fr; font-size: 0.75rem; gap: 2px 6px; }
    .journey-node { min-width: 60px; }
    .modal-content {
        width: 95%;
        margin: 10% auto;
    }
}
@media (max-width: 480px) {
    .elevation-chart {
        height: 120px;
    }
}
</style>
{% endblock %}

{% block content %}
{# ===== A. ENHANCED HERO ===== #}
<div class="hero" style="padding:50px 20px 60px;" id="hero-section">
    <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:10px;">
        <svg viewBox="0 0 20 20" width="24" height="24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10 1C7.2 1 5 3.2 5 6c0 3.5 5 8 5 8s5-4.5 5-8c0-2.8-2.2-5-5-5z"/>
          <circle cx="10" cy="6" r="1.5" fill="white"/>
          <path d="M6 16h8" stroke-dasharray="2 2"/>
          <circle cx="6" cy="16" r="1" fill="white"/>
          <circle cx="14" cy="16" r="1" fill="white"/>
        </svg>
        {% if plan.distance_km %}
        <span style="background:rgba(255,255,255,0.2);padding:4px 14px;border-radius:20px;font-size:0.85rem;font-weight:600;">{{ plan.distance_km }}K Brevet</span>
        {% endif %}
    </div>
    <h1>{% if is_custom_view and plan.custom_name %}{{ plan.custom_name }}{% else %}{{ plan.name }}{% endif %}</h1>
    <p style="opacity:0.85;margin-top:8px;">{{ stops|length }} stops &middot; {{ "%.1f"|format(plan.total_distance_miles) }} miles &middot; {{ "{:,}".format(plan.total_elevation_ft) }} ft of climbing</p>
    {% if plan.cutoff_hours %}
    <p style="opacity:0.65;font-size:0.88rem;margin-top:4px;">ACP time limit: {{ plan.cutoff_hours }}h &middot; Start: <span id="hero-start-time">{{ plan.start_time }}</span></p>
    {% endif %}
</div>

{# ===== B. STATS ROW - Plan Summary ===== #}
<div class="stats-row">
<div class="stat-card" style="background:linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);border-color:#bfdbfe;">
    <div class="number" style="color:#1e40af;">{{ "%.1f"|format(plan.total_distance_miles) }}</div>
    <div class="label" style="color:#1e3a8a;">Miles</div>
</div>
<div class="stat-card" style="background:linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);border-color:#a5f3fc;">
    <div class="number" style="color:#0e7490;">{{ "{:,}".format(plan.total_elevation_ft) }}</div>
    <div class="label" style="color:#164e63;">Elevation (ft)</div>
</div>
<div class="stat-card" style="background:linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%);border-color:#99f6e4;">
    <div class="number" style="color:#0f766e;">{{ "%.0f"|format(overall_ft_per_mile) }}</div>
    <div class="label" style="color:#134e4a;">Ft / Mile</div>
</div>
{% if total_time > 0 %}
<div class="stat-card" style="background:linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);border-color:#e9d5ff;">
    <div class="number" style="color:#7c3aed;">{{ (total_time // 60) }}:{{ "%02d"|format(total_time % 60) }}</div>
    <div class="label" style="color:#5b21b6;">Elapsed Time</div>
</div>
{% endif %}
{% if total_moving_time > 0 %}
<div class="stat-card" style="background:linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);border-color:#ddd6fe;">
    <div class="number" style="color:#6d28d9;">{{ (total_moving_time // 60) }}:{{ "%02d"|format(total_moving_time % 60) }}</div>
    <div class="label" style="color:#4c1d95;">Moving Time</div>
</div>
{% endif %}
{% if total_break_time > 0 %}
<div class="stat-card" style="background:linear-gradient(135deg, #fdf4ff 0%, #fae8ff 100%);border-color:#f5d0fe;">
    <div class="number" style="color:#a21caf;">{{ (total_break_time // 60) }}:{{ "%02d"|format(total_break_time % 60) }}</div>
    <div class="label" style="color:#701a75;">Stop Time</div>
</div>
{% endif %}
{% if plan.cutoff_hours and total_time > 0 %}
{% set banked_min = (plan.cutoff_hours * 60) - total_time %}
<div class="stat-card" style="background:linear-gradient(135deg, {% if banked_min >= 0 %}#ecfdf5 0%, #d1fae5 100%);border-color:#a7f3d0{% else %}#fef2f2 0%, #fee2e2 100%);border-color:#fecaca{% endif %};">
    <div class="number" style="color:{% if banked_min >= 0 %}#047857{% else %}#b91c1c{% endif %};">
        {% if banked_min >= 0 %}+{% endif %}{{ (banked_min // 60)|int }}:{{ "%02d"|format((banked_min % 60)|abs|int) }}
    </div>
    <div class="label" style="color:{% if banked_min >= 0 %}#065f46{% else %}#7f1d1d{% endif %};">Time Bank</div>
</div>
{% endif %}
{% if avg_elapsed_speed %}
<div class="stat-card" style="background:linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);border-color:#a7f3d0;">
    <div class="number" style="color:#059669;">{{ "%.1f"|format(avg_elapsed_speed) }}</div>
    <div class="label" style="color:#047857;">Elapsed Speed</div>
</div>
{% endif %}
{% if avg_moving_speed %}
<div class="stat-card" style="background:linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);border-color:#bbf7d0;">
    <div class="number" style="color:#16a34a;">{{ "%.1f"|format(avg_moving_speed) }}</div>
    <div class="label" style="color:#166534;">Moving Speed</div>
</div>
{% endif %}
{% if weighted_difficulty %}
<div class="stat-card" style="background:linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);border-color:#fed7aa;">
    {% set diff_val = weighted_difficulty %}
    {% if diff_val >= 7 %}
        {% set diff_num_color = '#991b1b' %}
        {% set diff_label_color = '#7f1d1d' %}
    {% elif diff_val >= 4 %}
        {% set diff_num_color = '#92400e' %}
        {% set diff_label_color = '#78350f' %}
    {% elif diff_val >= 1.5 %}
        {% set diff_num_color = '#166534' %}
        {% set diff_label_color = '#14532d' %}
    {% else %}
        {% set diff_num_color = '#475569' %}
        {% set diff_label_color = '#334155' %}
    {% endif %}
    <div class="number" style="color:{{ diff_num_color }};">{{ "%.1f"|format(diff_val) }}</div>
    <div class="label" style="color:{{ diff_label_color }};">Difficulty</div>
</div>
{% endif %}
{% if upcoming_event %}
<div class="stat-card" style="background:linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);border-color:#c7d2fe;{% if signup_count and signup_count > 0 %}cursor:pointer;{% else %}opacity:0.5;cursor:not-allowed;{% endif %}" {% if signup_count and signup_count > 0 %}onclick="showSignupsModal()" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 8px 20px rgba(0,0,0,0.12)';" onmouseout="this.style.transform='';this.style.boxShadow='';"{% endif %}>
    <div class="number" style="color:#4338ca;">
        <svg viewBox="0 0 20 20" width="24" height="24" fill="currentColor" style="display:inline-block;vertical-align:middle;margin-right:4px;">
            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
        </svg>
        <span id="signup-count-display">{{ signup_count or 0 }}</span>
    </div>
    <div class="label" style="color:#312e81;">Riders Signed Up</div>
</div>
{% endif %}
</div>

<div class="container section">

{# ===== QUICK ACTION BUTTONS ===== #}
<div class="quick-actions">
    {# Team Asha Route (if available) - shown first #}
    {% if plan.rwgps_url_team %}
    <a href="{{ plan.rwgps_url_team }}" target="_blank" class="quick-action-btn">
        <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:20px;height:20px;">
        <span>Team Asha Route</span>
    </a>
    {% endif %}
    
    {# Weather using Team Asha route #}
    {% if upcoming_event and weather_route_id %}
    <a href="#" id="auto-weather-link" target="_blank" class="quick-action-btn" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fbbf24;color:#92400e;">
        <span>üå§Ô∏è</span>
        <span>Weather</span>
    </a>
    {% endif %}
    
    {# Official Route (if different from team route) - shown last and grayed if team route exists #}
    {% if plan.rwgps_url and plan.rwgps_url != plan.rwgps_url_team %}
    <a href="{{ plan.rwgps_url }}" target="_blank" class="quick-action-btn" style="{% if plan.rwgps_url_team %}background:#f1f5f9;border-color:#cbd5e1;color:#94a3b8;{% endif %}">
        <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:20px;height:20px;{% if plan.rwgps_url_team %}opacity:0.6;{% endif %}">
        <span>Official Route</span>
    </a>
    {% endif %}
    
    <a href="#time-bank-section" class="quick-action-btn" onclick="document.getElementById('time-bank-section').classList.add('expanded'); return true;">
        <span>‚è±Ô∏è</span>
        <span>Time Bank</span>
    </a>
    <a href="#journey-view" class="quick-action-btn">
        <span>üó∫Ô∏è</span>
        <span>Journey</span>
    </a>
</div>

{# ===== CUSTOM PLAN BANNER ===== #}
{% if session.user_id %}
<div class="custom-plan-banner">
    <div>
        {% if user_custom_plan %}
        <h3>‚úèÔ∏è You have a custom plan for this ride</h3>
        <p>{% if is_custom_view %}Viewing your personalized version ¬∑ {% endif %}Switch between views or edit your plan</p>
        {% else %}
        <h3>üõ†Ô∏è Create Your Own Plan</h3>
        <p>Personalize this ride plan with your own pace, timing, and stops</p>
        {% endif %}
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        {% if user_custom_plan %}
        <a href="{{ url_for('riders.ride_plan_detail', slug=plan.slug, view='custom') }}" 
           class="btn-custom-plan {% if is_custom_view %}active{% endif %}">
            üìã View My Custom Plan
        </a>
        <a href="{{ url_for('riders.ride_plan_detail', slug=plan.slug, view='base') }}" 
           class="btn-custom-plan {% if not is_custom_view %}active{% endif %}" style="background:#6366f1;">
            üìÑ Base Plan
        </a>
        <a href="{{ url_for('riders.compare_ride_plans', slug=plan.slug) }}" 
           class="btn-custom-plan" style="background:#f59e0b;">
            üìä Compare Plans
        </a>
        {% if is_custom_view %}
        <a href="{{ url_for('riders.custom_ride_plan_editor', slug=plan.slug) }}" 
           class="btn-custom-plan" style="background:#16a34a;">
            ‚úèÔ∏è Edit
        </a>
        {% elif is_admin %}
        <a href="{{ url_for('riders.base_plan_editor', slug=plan.slug) }}" 
           class="btn-custom-plan" style="background:#16a34a;">
            ‚úèÔ∏è Edit Base
        </a>
        {% endif %}
        {% else %}
        <a href="{{ url_for('riders.custom_ride_plan_editor', slug=plan.slug) }}" 
           class="btn-custom-plan create">
            ‚ûï Create Custom Plan
        </a>
        {% endif %}
    </div>
</div>
{% endif %}

{# ===== VISUAL ELEVATION CHART ===== #}
<div class="elevation-chart-container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div class="section-label" style="margin:0;">Elevation Profile</div>
        <div style="font-size:0.75rem;color:var(--text-light);">{{ "{:,}".format(plan.total_elevation_ft) }} ft total</div>
    </div>
    <div class="elevation-chart">
        <div class="elevation-profile">
            {% for s in stops %}
            {% if s.elevation_gain and s.elevation_gain > 0 %}
            {% set max_elev = 2000 %}
            {% set bar_height = [(s.elevation_gain / max_elev * 100), 100]|min %}
            <div class="elevation-bar {{ s.stop_type }}" style="height:{{ bar_height }}%;">
                <div class="elevation-tooltip">
                    <div style="font-weight:700;">{{ s.location[:20] }}{% if s.location|length > 20 %}...{% endif %}</div>
                    <div>{{ s.elevation_gain }}ft gain</div>
                    <div>{{ "%.1f"|format(s.distance_miles) }} mi</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:8px;font-size:0.7rem;color:var(--text-light);justify-content:center;">
        <span style="display:flex;align-items:center;gap:4px;">
            <span style="width:12px;height:12px;background:linear-gradient(to top, #3b82f6, #60a5fa);border-radius:2px;"></span>
            Waypoint
        </span>
        <span style="display:flex;align-items:center;gap:4px;">
            <span style="width:12px;height:12px;background:linear-gradient(to top, #dc2626, #ef4444);border-radius:2px;"></span>
            Control
        </span>
    </div>
</div>


{# ===== E. LEGEND ===== #}
<div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;">
<div class="plan-legend" style="flex:1;">
<span style="font-weight:600;color:var(--text);margin-right:4px;">Stop Types:</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#22c55e;"></span> Start</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#e53e3e;"></span> Finish</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#3b82f6;"></span> Control</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#f59e0b;"></span> Rest / Food / Water</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#94a3b8;"></span> Waypoint</span>
</div>
<div class="plan-legend" style="flex:1;">
<span style="font-weight:600;color:var(--text);margin-right:4px;">Difficulty (ft/mi):</span>
<div style="display:flex;align-items:center;gap:6px;flex:1;">
    <span style="font-size:0.7rem;color:var(--text-light);">0</span>
    <div style="flex:1;height:10px;border-radius:5px;background:linear-gradient(90deg, #94a3b8 0%, #22c55e 25%, #f59e0b 50%, #ef4444 75%, #991b1b 100%);"></div>
    <span style="font-size:0.7rem;color:var(--text-light);">100+</span>
</div>
</div>
</div>

{# ===== F. TERRAIN DIFFICULTY STRIP (gradient colors) ===== #}
{% if plan.total_distance_miles > 0 %}
<div class="section-label">Terrain Difficulty Profile</div>
<div class="terrain-strip" style="margin-bottom:24px;" title="Segments colored by difficulty (ft/mile gradient)">
{% for s in stops %}
{% if s.seg_dist and s.seg_dist > 0 %}
<div class="terrain-seg"
     style="width:{{ (s.seg_dist / plan.total_distance_miles * 100)|round(1) }}%;background:{{ s.difficulty_color }};"
     title="{{ s.location }}: {{ s.ft_per_mi or 0 }} ft/mi ‚Äî {{ s.difficulty_label }}{% if s.difficulty_score %} ({{ s.difficulty_score }}){% endif %}">
</div>
{% endif %}
{% endfor %}
</div>
{% endif %}

{# ===== G. ROUTE OVERVIEW / JOURNEY STRIP with ETA ===== #}
<div class="section-label">Route Overview</div>
<div class="journey-strip" style="margin-bottom:24px;">
{% for n in journey_nodes %}
<div class="journey-node {{ n.node_type }}">
    <div class="journey-dot" style="background:{{ n.difficulty_color }};box-shadow:0 0 0 2px {{ n.difficulty_color }};"></div>
    <div class="journey-label">{{ n.label }}</div>
    <div class="journey-dist">{{ "%.1f"|format(n.distance_miles) }} mi</div>
    <div class="journey-eta arrival-time" data-cum-min="{{ (n['arrival_time_min']|default(0))|int }}">{% if n.distance_miles > 0 %}--:--{% endif %}</div>
</div>
{% endfor %}
</div>

{# ===== H. TIME-OF-DAY & TIME BANK CHART (Collapsible) ===== #}
{% if plan.cutoff_hours %}
<div class="collapsible-section expanded" id="time-bank-section" style="margin-bottom:24px;">
    <div class="collapsible-header" onclick="toggleSection('time-bank-section')">
        <div class="collapsible-title">
            <span>‚è±Ô∏è</span>
            <span>Time Bank & Arrival Times</span>
        </div>
        <span class="collapsible-icon">‚ñº</span>
    </div>
    <div class="collapsible-content">
        <div class="card" style="margin-top:12px;padding:16px 20px;border-radius:10px;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
        <div class="section-label" style="margin-bottom:0;">Estimated Arrival Times & Time Bank</div>
        <div style="display:flex;align-items:center;gap:6px;">
            <label for="start-time-input" style="font-size:0.78rem;color:var(--text-light);font-weight:500;">Start Time:</label>
            <input type="time" id="start-time-input" value="{{ plan.start_time }}" class="start-time-input">
        </div>
    </div>
    <div id="tod-start-label" style="font-size:0.75rem;color:var(--text-light);margin-bottom:10px;">
        Based on {{ plan.start_time }} start. Time banked (+) or lost (&minus;) against {{ plan.cutoff_hours }}h cutoff.
    </div>
    {# Column headers #}
    <div class="tod-grid" style="margin-bottom:4px;">
        <span class="tod-header">Location</span>
        <span class="tod-header" style="text-align:right;">ETA</span>
        <span class="tod-header" style="text-align:right;">Dist</span>
        <span class="tod-header" style="text-align:right;">Time Bank</span>
        <span class="tod-header"></span>
    </div>
    {# Data rows #}
    {% for s in stops %}
    {% if s.time_bank_min is not none and s.stop_type in ['control', 'rest', 'finish', 'start'] and s.distance_miles and s.distance_miles > 0 %}
    <div class="tod-grid">
        <span class="tod-label">{{ s.location }}{% if s.stop_duration_min %} <span style="color:#94a3b8;font-size:0.75rem;">({{ s.stop_duration_min }}min stop)</span>{% endif %}</span>
        <span class="tod-time arrival-time" data-cum-min="{{ (s['arrival_time_min']|default(0))|int }}">
            &mdash;
        </span>
        <span class="tod-dist">{{ "%.1f"|format(s.distance_miles) }} mi</span>
        <span class="tod-bank" style="font-weight:600;color:{% if s.time_bank_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};">
            {% if s.time_bank_min >= 0 %}+{% endif %}{% set abs_min = s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min %}{{ (abs_min // 60)|int }}h{{ "%02d"|format(abs_min % 60) }}m
        </span>
    </div>
    {% endif %}
    {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{# ===== I. VIEW TOGGLE ===== #}
<div style="display:flex;gap:8px;margin-bottom:16px;">
    <button class="view-toggle active" data-view="cards" onclick="toggleView('cards')">
        <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><rect x="1" y="1" width="14" height="4" rx="1"/><rect x="1" y="7" width="14" height="4" rx="1"/><rect x="1" y="13" width="14" height="2" rx="1"/></svg>
        Journey View
    </button>
    <button class="view-toggle" data-view="table" onclick="toggleView('table')">
        <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><rect x="1" y="1" width="14" height="2"/><rect x="1" y="5" width="14" height="2"/><rect x="1" y="9" width="14" height="2"/><rect x="1" y="13" width="14" height="2"/></svg>
        Table View
    </button>
</div>

{# ===== J. SEGMENT CARDS (timeline layout with break merging) ===== #}
<div id="cards-view">
{% if use_timeline %}
<div class="segment-cards timeline-container">
{% for s in stops %}
{# Skip zero-distance rest stops ‚Äî they are merged as break chips on the preceding card #}
{% if s.get('_is_merged_break') %}
{% else %}
{% set level_class = 'level-start' if s.stop_type == 'start' else 'level-finish' if s.stop_type == 'finish' else 'level-control' if s.stop_type == 'control' else 'level-waypoint' %}
<div class="segment-card {{ level_class }}" style="border-left-color:{{ s.difficulty_color }};">
    {% if s.difficulty_label and s.difficulty_label != 'flat' %}<div class="diff-stripe" style="background:{{ s.difficulty_color }};"></div>{% endif %}
    <div class="segment-header">
        <div class="stop-icon {{ s.stop_type }}">
            {% if s.stop_type == 'start' %}&#x1F6A9;{% elif s.stop_type == 'finish' %}&#x1F3C1;{% elif s.stop_type == 'control' %}&#x25C6;{% else %}&#x2022;{% endif %}
        </div>
        <div class="segment-loc">
            <div class="segment-loc-name">{{ s.location }}</div>
            {% if s.notes %}<div class="segment-loc-notes">{{ s.notes }}</div>{% endif %}
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
            {% if s.difficulty_score and s.difficulty_score > 0 %}
            <span class="diff-badge" style="background:{{ s.difficulty_color }};color:white;">{{ s.difficulty_score }}</span>
            {% endif %}
            <span class="type-badge {{ s.stop_type }}">{{ s.stop_type }}</span>
        </div>
    </div>
    {% if s.seg_dist and s.seg_dist > 0 %}
    <div class="segment-metrics">
        <div class="metric">
            <div class="metric-value">{{ "%.1f"|format(s.seg_dist) }}</div>
            <div class="metric-label">Seg Mi</div>
        </div>
        <div class="metric">
            <div class="metric-value" style="color:var(--primary);">{{ "%.1f"|format(s.distance_miles) if s.distance_miles else '‚Äî' }}</div>
            <div class="metric-label">Cumul Mi</div>
        </div>
        {% if s.elevation_gain and s.elevation_gain > 0 %}
        <div class="metric">
            <div class="metric-value elev">{{ "{:,}".format(s.elevation_gain) }}</div>
            <div class="metric-label">Elev Ft</div>
        </div>
        {% endif %}
        {% if s.ft_per_mi %}
        <div class="metric">
            <div class="metric-value">{{ s.ft_per_mi }}</div>
            <div class="metric-label">Ft/Mi</div>
        </div>
        {% endif %}
        {% if s.segment_time_min and s.segment_time_min > 0 %}
        <div class="metric">
            <div class="metric-value">
                {% set break_time = s.get('_break_time_min', 0) %}
                {% set combined = s.segment_time_min + break_time %}
                {% if combined >= 60 %}{{ combined // 60 }}h{{ "%02d"|format(combined % 60) }}m{% else %}{{ combined }}m{% endif %}
                {% if break_time > 0 %}<span class="seg-time-break-note">(+{{ break_time }}m&nbsp;rest)</span>{% endif %}
            </div>
            <div class="metric-label">Seg Time</div>
        </div>
        {% endif %}
        {% if s.avg_speed %}
        <div class="metric">
            <div class="metric-value">{{ "%.1f"|format(s.avg_speed) }}</div>
            <div class="metric-label">Avg MPH</div>
        </div>
        {% endif %}
        {# Time Bank: use the last break's time_bank if breaks follow, else use this stop's #}
        {% set effective_bank = s.get('_next_breaks', [])[-1].time_bank_min if s.get('_next_breaks') and s.get('_next_breaks')[-1].get('time_bank_min') is not none else s.time_bank_min %}
        {% if effective_bank is not none %}
        <div class="metric">
            {% set abs_bank = effective_bank if effective_bank >= 0 else -effective_bank %}
            <div class="metric-value" style="color:{% if effective_bank >= 0 %}#16a34a{% else %}#dc2626{% endif %};">
                {% if effective_bank >= 0 %}+{% else %}&minus;{% endif %}{{ (abs_bank // 60)|int }}:{{ "%02d"|format(abs_bank % 60) }}
            </div>
            <div class="metric-label">Time Bank</div>
        </div>
        {% endif %}
    </div>
    {% endif %}
    {# Break chips ‚Äî merged rest stops #}
    {% if s.get('_next_breaks') %}
    <div class="break-chips-row">
        {% for brk in s._next_breaks %}
        <div class="break-chip" title="{{ brk.location }}{% if brk.notes %} ‚Äî {{ brk.notes }}{% endif %}">
            <span class="break-icon">&#x2615;</span>
            {{ brk.location[:30] }}
            {% if brk.segment_time_min %}({{ brk.segment_time_min }}min){% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}
{% endfor %}
</div>
{% else %}
{# Fallback: original flat card view when stop types are unknown #}
<div class="segment-cards">
{% for s in stops %}
<div class="segment-card" style="border-left-color:{{ s.difficulty_color }};">
    {% if s.difficulty_label and s.difficulty_label != 'flat' %}<div class="diff-stripe" style="background:{{ s.difficulty_color }};"></div>{% endif %}
    <div class="segment-header">
        <div class="stop-icon {{ s.stop_type }}">
            {% if s.stop_type == 'start' %}&#x1F6A9;{% elif s.stop_type == 'finish' %}&#x1F3C1;{% elif s.stop_type == 'control' %}&#x25C6;{% elif s.stop_type == 'rest' %}&#x2615;{% else %}&#x2022;{% endif %}
        </div>
        <div class="segment-loc">
            <div class="segment-loc-name">{{ s.location }}</div>
            {% if s.notes %}<div class="segment-loc-notes">{{ s.notes }}</div>{% endif %}
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
            {% if s.difficulty_score and s.difficulty_score > 0 %}
            <span class="diff-badge" style="background:{{ s.difficulty_color }};color:white;">{{ s.difficulty_score }}</span>
            {% endif %}
            <span class="type-badge {{ s.stop_type }}">{{ s.stop_type }}</span>
        </div>
    </div>
    {% if s.seg_dist and s.seg_dist > 0 %}
    <div class="segment-metrics">
        <div class="metric">
            <div class="metric-value">{{ "%.1f"|format(s.seg_dist) }}</div>
            <div class="metric-label">Seg Mi</div>
        </div>
        <div class="metric">
            <div class="metric-value" style="color:var(--primary);">{{ "%.1f"|format(s.distance_miles) if s.distance_miles else '‚Äî' }}</div>
            <div class="metric-label">Cumul Mi</div>
        </div>
        {% if s.elevation_gain and s.elevation_gain > 0 %}
        <div class="metric">
            <div class="metric-value elev">{{ "{:,}".format(s.elevation_gain) }}</div>
            <div class="metric-label">Elev Ft</div>
        </div>
        {% endif %}
        {% if s.ft_per_mi %}
        <div class="metric">
            <div class="metric-value">{{ s.ft_per_mi }}</div>
            <div class="metric-label">Ft/Mi</div>
        </div>
        {% endif %}
        {% if s.segment_time_min and s.segment_time_min > 0 %}
        <div class="metric">
            <div class="metric-value">
                {% if s.segment_time_min >= 60 %}{{ s.segment_time_min // 60 }}h{{ "%02d"|format(s.segment_time_min % 60) }}m{% else %}{{ s.segment_time_min }}m{% endif %}
            </div>
            <div class="metric-label">Seg Time</div>
        </div>
        {% endif %}
        {% if s.avg_speed %}
        <div class="metric">
            <div class="metric-value">{{ "%.1f"|format(s.avg_speed) }}</div>
            <div class="metric-label">Avg MPH</div>
        </div>
        {% endif %}
        {% if s.time_bank_min is not none %}
        <div class="metric">
            {% set abs_bank = s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min %}
            <div class="metric-value" style="color:{% if s.time_bank_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};">
                {% if s.time_bank_min >= 0 %}+{% else %}&minus;{% endif %}{{ (abs_bank // 60)|int }}:{{ "%02d"|format(abs_bank % 60) }}
            </div>
            <div class="metric-label">Time Bank</div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endfor %}
</div>
{% endif %}
</div>

{# ===== K. DATA TABLE (gradient difficulty colors) ===== #}
<div id="table-view" style="display:none;">
<div class="table-wrap">
<table class="plan-table">
<thead>
<tr>
    <th style="text-align:center;width:32px;">#</th>
    <th style="text-align:left;">Type</th>
    <th style="text-align:left;">Location</th>
    <th style="text-align:right;">Seg. Dist</th>
    <th style="text-align:right;">Cumul. Dist</th>
    <th style="text-align:right;">Elev. Gain</th>
    <th style="text-align:right;">Ft/Mi</th>
    <th style="text-align:right;">Seg. Time</th>
    <th style="text-align:right;">Avg Speed</th>
    {% if plan.cutoff_hours %}<th style="text-align:right;">Time Bank</th>{% endif %}
    <th style="text-align:center;">Diff.</th>
    <th style="text-align:left;">Notes</th>
</tr>
</thead>
<tbody>
{% for s in stops %}
<tr style="border-left:3px solid {{ s.difficulty_color }};">
    <td style="text-align:center;color:var(--text-light);font-size:0.72rem;">{{ loop.index }}</td>
    <td><span class="type-badge {{ s.stop_type }}">{{ s.stop_type }}</span></td>
    <td><div style="font-weight:600;color:var(--primary);font-size:0.82rem;">{{ s.location }}</div></td>
    <td class="num-cell">
        {% if s.seg_dist and s.seg_dist > 0 %}{{ "%.1f"|format(s.seg_dist) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell highlight">
        {% if s.distance_miles is not none %}{{ "%.1f"|format(s.distance_miles) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell" style="color:#dc2626;">
        {% if s.elevation_gain and s.elevation_gain > 0 %}{{ "{:,}".format(s.elevation_gain) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.ft_per_mi %}{{ s.ft_per_mi }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.segment_time_min and s.segment_time_min > 0 %}
            {% if s.segment_time_min >= 60 %}{{ (s.segment_time_min // 60) }}h {{ "%02d"|format(s.segment_time_min % 60) }}m{% else %}{{ s.segment_time_min }}m{% endif %}
        {% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.avg_speed %}{{ "%.1f"|format(s.avg_speed) }} mph{% else %}&mdash;{% endif %}
    </td>
    {% if plan.cutoff_hours %}
    <td class="num-cell">
        {% if s.time_bank_min is not none %}
        {% set abs_bank = s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min %}
        <span style="color:{% if s.time_bank_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};font-weight:600;">
            {% if s.time_bank_min >= 0 %}+{% else %}&minus;{% endif %}{{ (abs_bank // 60)|int }}:{{ "%02d"|format(abs_bank % 60) }}
        </span>
        {% else %}&mdash;{% endif %}
    </td>
    {% endif %}
    <td style="text-align:center;">
        {% if s.difficulty_score and s.difficulty_score > 0 %}
        <span class="diff-badge" style="background:{{ s.difficulty_color }};color:white;">{{ s.difficulty_score }}</span>
        {% else %}&mdash;{% endif %}
    </td>
    <td>
        {% if s.notes %}<div style="font-size:0.75rem;color:var(--text-light);max-width:240px;line-height:1.35;">{{ s.notes }}</div>{% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
<tfoot>
<tr>
    <td colspan="3" style="text-align:right;">Totals</td>
    <td class="num-cell">&mdash;</td>
    <td class="num-cell">{{ "%.1f"|format(plan.total_distance_miles) }} mi</td>
    <td class="num-cell" style="color:#dc2626;">{{ "{:,}".format(plan.total_elevation_ft) }} ft</td>
    <td class="num-cell">{{ "%.0f"|format(overall_ft_per_mile) }}</td>
    <td class="num-cell">
        {% if total_time > 0 %}
            {{ (total_time // 60) }}h {{ "%02d"|format(total_time % 60) }}m
        {% endif %}
    </td>
    <td class="num-cell">
        {% if avg_elapsed_speed %}
            {{ "%.1f"|format(avg_elapsed_speed) }} mph
        {% endif %}
    </td>
    {% if plan.cutoff_hours %}<td></td>{% endif %}
    <td></td>
    <td></td>
</tr>
</tfoot>
</table>
</div>
</div>

{# ===== L. BACK LINK ===== #}
<div style="margin-top:25px;">
<a href="javascript:history.back()" class="back-link">&larr; Back</a>
</div>

</div>

<!-- Signups Modal -->
{% if upcoming_event %}
<div id="signups-modal" class="modal" onclick="closeSignupsModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title" id="signups-modal-title">Riders List</h2>
            <button class="modal-close" onclick="closeSignupsModal()">&times;</button>
        </div>
        <div class="modal-body" id="signups-modal-body">
            <p style="text-align:center;color:var(--text-light);padding:20px;">Loading...</p>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function toggleView(view) {
    document.getElementById('cards-view').style.display = view === 'cards' ? 'block' : 'none';
    document.getElementById('table-view').style.display = view === 'table' ? 'block' : 'none';
    document.querySelectorAll('.view-toggle').forEach(function(b) {
        b.classList.toggle('active', b.dataset.view === view);
    });
}

// Shared function to recalculate all arrival times from a given start time
function recalcArrivalTimes(startTimeStr) {
    var parts = startTimeStr.split(':');
    var startHour = parseInt(parts[0]) || 6;
    var startMin = parseInt(parts[1]) || 0;

    // Update all .arrival-time elements (time bank chart + journey strip ETAs)
    document.querySelectorAll('.arrival-time').forEach(function(el) {
        var cumMin = parseInt(el.dataset.cumMin, 10);
        if (isNaN(cumMin)) cumMin = 0;
        var totalMin = startHour * 60 + startMin + cumMin;
        var h = Math.floor(totalMin / 60) % 24;
        var m = totalMin % 60;
        var ampm = h >= 12 ? 'PM' : 'AM';
        var displayH = h % 12 || 12;
        el.textContent = displayH + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
    });

    // Update hero start time display
    var heroEl = document.getElementById('hero-start-time');
    if (heroEl) heroEl.textContent = startTimeStr;

    // Update subtitle text
    var subtitleEl = document.getElementById('tod-start-label');
    if (subtitleEl) {
        subtitleEl.textContent = 'Based on ' + startTimeStr + ' start. Time banked (+) or lost (\u2212) against {{ plan.cutoff_hours or 0 }}h cutoff.';
    }
}

// Initial calculation on page load
recalcArrivalTimes('{{ plan.start_time }}');

// Start time input change handler
(function() {
    var startInput = document.getElementById('start-time-input');
    if (startInput) {
        startInput.addEventListener('change', function() {
            recalcArrivalTimes(this.value);
        });
    }

    // Auto weather link for upcoming events (using Team Asha route)
    // SAFETY: Only run if upcoming_event exists AND has a date attribute
    {% if upcoming_event and upcoming_event.date is defined %}
    var autoWeatherLink = document.getElementById('auto-weather-link');
    if (autoWeatherLink) {
        var routeId = '{{ weather_route_id or "" }}';
        var planName = '{{ plan.name|replace("'", "\\'") }}';
        var eventDate = '{{ upcoming_event.date if upcoming_event.date is defined else "" }}';
        var eventTime = '{{ upcoming_event.start_time if upcoming_event.start_time is defined else "07:00" }}';

        if (routeId && eventDate) {
            var parts = eventTime.split(':');
            var startHour = parseInt(parts[0]) || 7;
            var startMin = parseInt(parts[1]) || 0;
            var dt = new Date(eventDate + 'T' + (startHour < 10 ? '0' : '') + startHour + ':' + (startMin < 10 ? '0' : '') + startMin + ':00');
            var ts = Math.floor(dt.getTime() / 1000);
            var url = 'https://www.randoplan.com/?pace=B%2B&interval=1&metric=false'
                + '&rwgpsRoute=' + routeId
                + '&provider=weatherapi'
                + '&name=' + encodeURIComponent(planName)
                + '&startTimestamp=' + ts
                + '&zone=America%2FLos_Angeles';
            autoWeatherLink.href = url;
        }
    }
    {% endif %}
})();

// Toggle collapsible sections
function toggleSection(sectionId) {
    var section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('expanded');
    }
}

// Signups modal functions
{% if upcoming_event %}
function showSignupsModal() {
    var countElement = document.getElementById('signup-count-display');
    var count = parseInt(countElement.textContent);
    if (count === 0) return;
    
    var modal = document.getElementById('signups-modal');
    var modalTitle = document.getElementById('signups-modal-title');
    var modalBody = document.getElementById('signups-modal-body');
    
    modalTitle.innerHTML = '<span style="color:#fbbf24;">Riders List</span> <span style="margin-left:12px;background:#ffffff;color:#0369a1;padding:4px 12px;border-radius:20px;font-size:0.9rem;font-weight:700;">' + count + '</span>';
    modalBody.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">Loading...</p>';
    modal.style.display = 'block';
    
    fetch('/signup/api/{{ upcoming_event.id }}/signups')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update modal title with count
                modalTitle.innerHTML = '<span style="color:#fbbf24;">Riders List</span> <span style="margin-left:12px;background:#ffffff;color:#0369a1;padding:4px 12px;border-radius:20px;font-size:0.9rem;font-weight:700;">' + data.count + '</span>';
                
                if (data.count === 0) {
                    modalBody.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">No riders signed up yet.</p>';
                } else {
                    var html = '';
                    data.riders.forEach(rider => {
                        var initials = rider.first_name.charAt(0) + rider.last_name.charAt(0);
                        
                        html += '<div class="rider-list-item">' +
                                '<div class="rider-avatar">' + initials + '</div>' +
                                '<div class="rider-info">' +
                                '<div class="rider-name">' + rider.first_name + ' ' + rider.last_name + ' <span style="color:var(--text-light);font-weight:500;font-size:0.85rem;">(#' + rider.rusa_id + ')</span></div>' +
                                '</div>' +
                                '</div>';
                    });
                    modalBody.innerHTML = html;
                }
            } else {
                modalBody.innerHTML = '<p style="text-align:center;color:#dc2626;padding:20px;">Failed to load signups.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = '<p style="text-align:center;color:#dc2626;padding:20px;">Failed to load signups.</p>';
        });
}

function closeSignupsModal(event) {
    var modal = document.getElementById('signups-modal');
    if (!event || event.target === modal) {
        modal.style.display = 'none';
    }
}

// Close modal on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' || event.key === 'Esc') {
        var modal = document.getElementById('signups-modal');
        if (modal && modal.style.display === 'block') {
            modal.style.display = 'none';
        }
    }
});
{% endif %}
</script>
{% endblock %}
