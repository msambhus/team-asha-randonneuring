{% extends "base.html" %}
{% block title %}{{ plan.name }} - Team Asha Randonneuring{% endblock %}

{% block extra_head %}
<style>
/* ===== JOURNEY STRIP ===== */
.journey-strip {
    display: flex;
    align-items: flex-start;
    overflow-x: auto;
    padding: 16px 0 8px;
    gap: 0;
    scrollbar-width: thin;
}
.journey-node {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 72px;
    max-width: 110px;
    position: relative;
    flex: 1;
}
.journey-node:not(:last-child)::after {
    content: '';
    position: absolute;
    top: 9px;
    left: 50%;
    width: 100%;
    height: 2px;
    background: var(--border);
    z-index: 0;
}
.journey-dot {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 2.5px solid white;
    z-index: 1;
    flex-shrink: 0;
}
.journey-node.start .journey-dot,
.journey-node.finish .journey-dot,
.journey-node.control .journey-dot {
    width: 16px;
    height: 16px;
}
.journey-label {
    font-size: 0.65rem;
    color: var(--text);
    text-align: center;
    margin-top: 6px;
    font-weight: 500;
    line-height: 1.2;
    word-break: break-word;
    padding: 0 2px;
}
.journey-dist {
    font-size: 0.6rem;
    color: var(--text-light);
    margin-top: 1px;
    font-variant-numeric: tabular-nums;
}
.journey-eta {
    font-size: 0.55rem;
    color: var(--text-light);
    margin-top: 1px;
    font-variant-numeric: tabular-nums;
    opacity: 0.8;
}

/* ===== TERRAIN DIFFICULTY STRIP ===== */
.terrain-strip {
    display: flex;
    height: 10px;
    border-radius: 5px;
    overflow: hidden;
    background: var(--border);
}
.terrain-seg {
    height: 100%;
    transition: opacity 0.15s;
    position: relative;
    cursor: default;
}
.terrain-seg:hover { opacity: 0.7; }

/* ===== SEGMENT CARDS ===== */
.segment-cards {
    display: flex;
    flex-direction: column;
    gap: 0;
    border: 1px solid var(--border);
    border-radius: 10px;
    overflow: hidden;
}
.segment-card {
    padding: 14px 18px;
    border-left: 4px solid var(--border);
    position: relative;
    transition: background 0.12s;
    border-bottom: 1px solid #f1f5f9;
}
.segment-card:last-child { border-bottom: none; }
.segment-card:hover { background: #fafbfc; }

.segment-header {
    display: flex;
    align-items: center;
    gap: 10px;
}
.stop-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    font-size: 0.75rem;
    flex-shrink: 0;
}
.stop-icon.start { background: #dcfce7; color: #166534; }
.stop-icon.finish { background: #fee2e2; color: #991b1b; }
.stop-icon.control { background: #dbeafe; color: #1e40af; }
.stop-icon.rest { background: #fef3c7; color: #92400e; }
.stop-icon.waypoint { background: #f1f5f9; color: #64748b; }

.segment-loc { flex: 1; min-width: 0; }
.segment-loc-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.9rem;
    line-height: 1.3;
}
.segment-loc-notes {
    font-size: 0.78rem;
    color: var(--text-light);
    margin-top: 2px;
    line-height: 1.4;
}
.segment-metrics {
    display: flex;
    gap: 16px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #f1f5f9;
    flex-wrap: wrap;
}
.metric { text-align: center; min-width: 52px; }
.metric-value {
    font-size: 0.95rem;
    font-weight: 700;
    color: var(--primary);
    font-variant-numeric: tabular-nums;
}
.metric-value.elev { color: #dc2626; }
.metric-label {
    font-size: 0.6rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 1px;
}

/* Difficulty stripe on right edge */
.diff-stripe {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 3px;
}

/* ===== TIME-OF-DAY CHART (grid layout) ===== */
.tod-grid {
    display: grid;
    grid-template-columns: minmax(180px, 2.5fr) 75px 60px 70px 1fr;
    gap: 2px 10px;
    align-items: center;
    font-size: 0.8rem;
}
.tod-header {
    font-size: 0.65rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    font-weight: 600;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 2px;
}
.tod-label {
    font-weight: 500;
    color: var(--text);
    padding: 4px 0;
    line-height: 1.3;
}
.tod-time {
    font-weight: 600;
    color: var(--primary);
    font-variant-numeric: tabular-nums;
    text-align: right;
    padding: 4px 0;
}
.tod-dist {
    text-align: right;
    font-weight: 500;
    color: var(--text-light);
    font-variant-numeric: tabular-nums;
    font-size: 0.78rem;
    padding: 4px 0;
}
.tod-bank {
    text-align: right;
    font-weight: 700;
    font-variant-numeric: tabular-nums;
    padding: 4px 0;
}
.tod-bar-bg {
    height: 7px;
    background: #f1f5f9;
    border-radius: 4px;
    overflow: hidden;
}
.tod-bar {
    height: 100%;
    border-radius: 4px;
    transition: width 0.3s ease;
}

/* ===== VIEW TOGGLE ===== */
.view-toggle {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 500;
    color: var(--text-light);
    background: white;
    cursor: pointer;
    transition: all 0.15s;
}
.view-toggle:hover { border-color: var(--primary); color: var(--primary); }
.view-toggle.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}

/* ===== DATA TABLE ===== */
.plan-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.82rem;
}
.plan-table thead th {
    background: var(--primary);
    color: white;
    font-weight: 600;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 9px 10px;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
}
.plan-table thead th:first-child { border-radius: 8px 0 0 0; }
.plan-table thead th:last-child { border-radius: 0 8px 0 0; }
.plan-table tbody td {
    padding: 9px 10px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}
.plan-table tbody tr:last-child td { border-bottom: none; }
.plan-table tbody tr:hover { background: #f7fafc; }
.type-badge {
    display: inline-block;
    padding: 2px 7px;
    border-radius: 4px;
    font-size: 0.62rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}
.type-badge.start { background: #dcfce7; color: #166534; }
.type-badge.finish { background: #fee2e2; color: #991b1b; }
.type-badge.control { background: #dbeafe; color: #1e40af; }
.type-badge.rest { background: #fef3c7; color: #92400e; }
.type-badge.waypoint { background: #f1f5f9; color: #475569; }
.num-cell {
    text-align: right;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
}
.num-cell.highlight { font-weight: 700; color: var(--primary); }
.plan-table tfoot td {
    padding: 10px;
    font-weight: 700;
    background: #f8fafc;
    border-top: 2px solid var(--border);
    font-size: 0.82rem;
}

/* Difficulty badge */
.diff-badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 0.6rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

/* ===== LEGEND ===== */
.plan-legend {
    display: flex;
    gap: 14px;
    flex-wrap: wrap;
    padding: 8px 14px;
    background: #f8fafc;
    border-radius: 8px;
    font-size: 0.75rem;
    color: var(--text-light);
}
.plan-legend-item { display: inline-flex; align-items: center; gap: 5px; }
.plan-legend-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ===== ROUTE LINKS ===== */
.route-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    transition: box-shadow 0.15s, transform 0.15s;
}
.route-link:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}
.route-link img { width: 18px; height: 18px; }

/* ===== SECTION HEADERS ===== */
.section-label {
    font-size: 0.78rem;
    color: var(--text-light);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    font-weight: 600;
    margin-bottom: 8px;
}

/* ===== WEATHER ===== */
.weather-section {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
    padding: 12px 16px;
    background: #f0f9ff;
    border: 1px solid #bae6fd;
    border-radius: 8px;
}
.weather-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    background: #0284c7;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.15s;
}
.weather-btn:hover { background: #0369a1; }
.weather-btn:disabled { background: #94a3b8; cursor: not-allowed; }

/* ===== START TIME INPUT ===== */
.start-time-input {
    padding: 4px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--primary);
    background: white;
}

/* ===== STICKY RIDE HEADER ===== */
.sticky-ride-header {
    position: sticky;
    top: 60px;
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 12px 20px;
    z-index: 40;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    transform: translateY(-100%);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.sticky-ride-header.visible {
    transform: translateY(0);
    opacity: 1;
}
.sticky-ride-title {
    font-size: 0.9rem;
    font-weight: 700;
    margin: 0;
}
.sticky-ride-stats {
    font-size: 0.7rem;
    opacity: 0.9;
    margin-top: 2px;
}

/* ===== ELEVATION CHART ===== */
.elevation-chart-container {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid var(--border);
}
.elevation-chart {
    height: 180px;
    position: relative;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.elevation-profile {
    height: 100%;
    display: flex;
    align-items: flex-end;
    gap: 2px;
    min-width: 100%;
}
.elevation-bar {
    flex: 1;
    min-width: 8px;
    background: linear-gradient(to top, #3b82f6, #60a5fa);
    border-radius: 2px 2px 0 0;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
}
.elevation-bar:hover {
    filter: brightness(1.2);
    transform: translateY(-4px);
}
.elevation-bar.control {
    background: linear-gradient(to top, #dc2626, #ef4444);
}
.elevation-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-8px);
    background: rgba(0,0,0,0.9);
    color: white;
    padding: 6px 10px;
    border-radius: 6px;
    font-size: 0.7rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s;
    z-index: 10;
}
.elevation-bar:hover .elevation-tooltip {
    opacity: 1;
}

/* ===== COLLAPSIBLE SECTIONS ===== */
.collapsible-section {
    margin-bottom: 20px;
}
.collapsible-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    background: linear-gradient(135deg, #f8fafc, #f1f5f9);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border);
    user-select: none;
}
.collapsible-header:hover {
    background: linear-gradient(135deg, #f1f5f9, #e2e8f0);
}
.collapsible-title {
    font-weight: 700;
    color: var(--primary);
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
}
.collapsible-icon {
    font-size: 1.2rem;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
.collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.collapsible-section.expanded .collapsible-icon {
    transform: rotate(180deg);
}
.collapsible-section.expanded .collapsible-content {
    max-height: 10000px;
}

/* ===== QUICK ACTION BUTTONS ===== */
.quick-actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
}
.quick-action-btn {
    flex: 1;
    min-width: 140px;
    padding: 12px 16px;
    background: linear-gradient(135deg, white, #f9fafb);
    border: 2px solid var(--border);
    border-radius: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
}
.quick-action-btn:hover {
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

/* ===== ENHANCED CARD ANIMATIONS ===== */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
.segment-card {
    animation: fadeInUp 0.5s ease forwards;
    opacity: 0;
}
.segment-card:nth-child(1) { animation-delay: 0.05s; }
.segment-card:nth-child(2) { animation-delay: 0.1s; }
.segment-card:nth-child(3) { animation-delay: 0.15s; }
.segment-card:nth-child(4) { animation-delay: 0.2s; }
.segment-card:nth-child(5) { animation-delay: 0.25s; }
.segment-card:nth-child(n+6) { animation-delay: 0.3s; }

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
    .sticky-ride-header {
        top: 0;
        padding: 10px 16px;
    }
    .elevation-chart {
        height: 140px;
    }
    .elevation-chart-container {
        padding: 16px;
        margin-bottom: 20px;
    }
    .quick-action-btn {
        min-width: 120px;
        font-size: 0.8rem;
        padding: 10px 14px;
    }
    .collapsible-header {
        padding: 12px 14px;
    }
    .segment-card {
        padding: 14px 16px;
        border-radius: 10px;
    }
    .plan-table { font-size: 0.75rem; }
    .plan-table thead th, .plan-table tbody td { padding: 7px 6px; }
    .segment-metrics { gap: 10px; }
    .metric { min-width: 44px; }
    .metric-value { font-size: 0.85rem; }
    .tod-grid { grid-template-columns: minmax(100px, 2fr) 60px 50px 55px 1fr; font-size: 0.75rem; gap: 2px 6px; }
    .journey-node { min-width: 60px; }
}
@media (max-width: 480px) {
    .elevation-chart {
        height: 120px;
    }
}
</style>
{% endblock %}

{% block content %}
{# ===== STICKY RIDE HEADER (Shows on scroll) ===== #}
<div class="sticky-ride-header" id="sticky-header">
    <div class="sticky-ride-title">
        üìç {{ plan.name }}
    </div>
    <div class="sticky-ride-stats">
        {{ "%.1f"|format(plan.total_distance_miles) }} mi &middot; {{ "{:,}".format(plan.total_elevation_ft) }} ft
    </div>
</div>

{# ===== A. ENHANCED HERO ===== #}
<div class="hero" style="padding:50px 20px 60px;" id="hero-section">
    <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:10px;">
        <svg viewBox="0 0 20 20" width="24" height="24" fill="none" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M10 1C7.2 1 5 3.2 5 6c0 3.5 5 8 5 8s5-4.5 5-8c0-2.8-2.2-5-5-5z"/>
          <circle cx="10" cy="6" r="1.5" fill="white"/>
          <path d="M6 16h8" stroke-dasharray="2 2"/>
          <circle cx="6" cy="16" r="1" fill="white"/>
          <circle cx="14" cy="16" r="1" fill="white"/>
        </svg>
        {% if plan.distance_km %}
        <span style="background:rgba(255,255,255,0.2);padding:4px 14px;border-radius:20px;font-size:0.85rem;font-weight:600;">{{ plan.distance_km }}K Brevet</span>
        {% endif %}
    </div>
    <h1>{{ plan.name }}</h1>
    <p style="opacity:0.85;margin-top:8px;">{{ stops|length }} stops &middot; {{ "%.1f"|format(plan.total_distance_miles) }} miles &middot; {{ "{:,}".format(plan.total_elevation_ft) }} ft of climbing</p>
    {% if plan.cutoff_hours %}
    <p style="opacity:0.65;font-size:0.88rem;margin-top:4px;">ACP time limit: {{ plan.cutoff_hours }}h &middot; Start: <span id="hero-start-time">{{ plan.start_time }}</span></p>
    {% endif %}
</div>

{# ===== B. STATS ROW ===== #}
<div class="stats-row">
<div class="stat-card">
    <div class="number">{{ "%.1f"|format(plan.total_distance_miles) }}</div>
    <div class="label">Miles</div>
</div>
<div class="stat-card">
    <div class="number">{{ "{:,}".format(plan.total_elevation_ft) }}</div>
    <div class="label">Feet of Climbing</div>
</div>
<div class="stat-card">
    <div class="number">{{ "%.0f"|format(overall_ft_per_mile) }}</div>
    <div class="label">Ft / Mile</div>
</div>
{% if total_moving_time > 0 %}
<div class="stat-card">
    <div class="number">{{ (total_moving_time // 60) }}h{{ "%02d"|format(total_moving_time % 60) }}m</div>
    <div class="label">Moving Time</div>
</div>
{% endif %}
{% if total_time > 0 %}
<div class="stat-card">
    <div class="number">{{ (total_time // 60) }}h{{ "%02d"|format(total_time % 60) }}m</div>
    <div class="label">Elapsed Time</div>
</div>
{% endif %}
{% if avg_moving_speed %}
<div class="stat-card">
    <div class="number">{{ "%.1f"|format(avg_moving_speed) }}</div>
    <div class="label">Avg Moving MPH</div>
</div>
{% endif %}
{% if plan.cutoff_hours and total_time > 0 %}
{% set banked_min = (plan.cutoff_hours * 60) - total_time %}
<div class="stat-card">
    <div class="number" style="color:{% if banked_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};">
        {% if banked_min >= 0 %}+{% endif %}{{ "%.1f"|format(banked_min / 60) }}h
    </div>
    <div class="label">Time Banked</div>
</div>
{% endif %}
</div>

<div class="container section">

{# ===== QUICK ACTION BUTTONS ===== #}
<div class="quick-actions">
    {% if rwgps_url_display %}
    <a href="{{ rwgps_url_display }}" target="_blank" class="quick-action-btn">
        <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:20px;height:20px;">
        <span>View Route</span>
    </a>
    {% endif %}
    {% if upcoming_event and weather_route_id %}
    <a href="#" id="auto-weather-link" target="_blank" class="quick-action-btn" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fbbf24;color:#92400e;">
        <span>üå§Ô∏è</span>
        <span>Weather</span>
    </a>
    {% endif %}
    <a href="#time-bank-section" class="quick-action-btn" onclick="document.getElementById('time-bank-section').classList.add('expanded'); return true;">
        <span>‚è±Ô∏è</span>
        <span>Time Bank</span>
    </a>
    <a href="#journey-view" class="quick-action-btn">
        <span>üó∫Ô∏è</span>
        <span>Journey</span>
    </a>
</div>

{# ===== VISUAL ELEVATION CHART ===== #}
<div class="elevation-chart-container">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <div class="section-label" style="margin:0;">Elevation Profile</div>
        <div style="font-size:0.75rem;color:var(--text-light);">{{ "{:,}".format(plan.total_elevation_ft) }} ft total</div>
    </div>
    <div class="elevation-chart">
        <div class="elevation-profile">
            {% for s in stops %}
            {% if s.elevation_gain and s.elevation_gain > 0 %}
            {% set max_elev = 2000 %}
            {% set bar_height = (s.elevation_gain / max_elev * 100)|min(100) %}
            <div class="elevation-bar {{ s.stop_type }}" style="height:{{ bar_height }}%;">
                <div class="elevation-tooltip">
                    <div style="font-weight:700;">{{ s.location[:20] }}{% if s.location|length > 20 %}...{% endif %}</div>
                    <div>{{ s.elevation_gain }}ft gain</div>
                    <div>{{ "%.1f"|format(s.distance_miles) }} mi</div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:8px;font-size:0.7rem;color:var(--text-light);justify-content:center;">
        <span style="display:flex;align-items:center;gap:4px;">
            <span style="width:12px;height:12px;background:linear-gradient(to top, #3b82f6, #60a5fa);border-radius:2px;"></span>
            Waypoint
        </span>
        <span style="display:flex;align-items:center;gap:4px;">
            <span style="width:12px;height:12px;background:linear-gradient(to top, #dc2626, #ef4444);border-radius:2px;"></span>
            Control
        </span>
    </div>
</div>

{# ===== C. RWGPS LINK (single, team preferred) & WEATHER ===== #}
{% if rwgps_url_display %}
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
<a href="{{ rwgps_url_display }}" target="_blank" class="route-link" style="color:var(--primary);">
    <img src="https://ridewithgps.com/favicon.ico" alt="">
    {{ rwgps_url_label }}
</a>

{% if upcoming_event and weather_route_id %}
<a href="#" id="auto-weather-link" target="_blank" class="route-link" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fbbf24;color:#92400e;">
    üå§Ô∏è Weather
</a>
{% endif %}
</div>
{% endif %}

{# ===== E. LEGEND ===== #}
<div style="display:flex;gap:20px;flex-wrap:wrap;margin-bottom:20px;">
<div class="plan-legend" style="flex:1;">
<span style="font-weight:600;color:var(--text);margin-right:4px;">Stop Types:</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#22c55e;"></span> Start</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#e53e3e;"></span> Finish</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#3b82f6;"></span> Control</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#f59e0b;"></span> Rest / Food / Water</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#94a3b8;"></span> Waypoint</span>
</div>
<div class="plan-legend" style="flex:1;">
<span style="font-weight:600;color:var(--text);margin-right:4px;">Difficulty (ft/mi):</span>
<div style="display:flex;align-items:center;gap:6px;flex:1;">
    <span style="font-size:0.7rem;color:var(--text-light);">0</span>
    <div style="flex:1;height:10px;border-radius:5px;background:linear-gradient(90deg, #94a3b8 0%, #22c55e 25%, #f59e0b 50%, #ef4444 75%, #991b1b 100%);"></div>
    <span style="font-size:0.7rem;color:var(--text-light);">100+</span>
</div>
</div>
</div>

{# ===== F. TERRAIN DIFFICULTY STRIP (gradient colors) ===== #}
{% if plan.total_distance_miles > 0 %}
<div class="section-label">Terrain Difficulty Profile</div>
<div class="terrain-strip" style="margin-bottom:24px;" title="Segments colored by difficulty (ft/mile gradient)">
{% for s in stops %}
{% if s.seg_dist and s.seg_dist > 0 %}
<div class="terrain-seg"
     style="width:{{ (s.seg_dist / plan.total_distance_miles * 100)|round(1) }}%;background:{{ s.difficulty_color }};"
     title="{{ s.location }}: {{ s.ft_per_mi or 0 }} ft/mi ‚Äî {{ s.difficulty_label }}{% if s.difficulty_score %} ({{ s.difficulty_score }}){% endif %}">
</div>
{% endif %}
{% endfor %}
</div>
{% endif %}

{# ===== G. ROUTE OVERVIEW / JOURNEY STRIP with ETA ===== #}
<div class="section-label">Route Overview</div>
<div class="journey-strip" style="margin-bottom:24px;">
{% for n in journey_nodes %}
<div class="journey-node {{ n.node_type }}">
    <div class="journey-dot" style="background:{{ n.difficulty_color }};box-shadow:0 0 0 2px {{ n.difficulty_color }};"></div>
    <div class="journey-label">{{ n.label }}</div>
    <div class="journey-dist">{{ "%.1f"|format(n.distance_miles) }} mi</div>
    {% if n.cum_time_min %}
    <div class="journey-eta arrival-time" data-cum-min="{{ n.cum_time_min }}">~--:--</div>
    {% endif %}
</div>
{% endfor %}
</div>

{# ===== H. TIME-OF-DAY & TIME BANK CHART (Collapsible) ===== #}
{% if plan.cutoff_hours %}
<div class="collapsible-section expanded" id="time-bank-section" style="margin-bottom:24px;">
    <div class="collapsible-header" onclick="toggleSection('time-bank-section')">
        <div class="collapsible-title">
            <span>‚è±Ô∏è</span>
            <span>Time Bank & Arrival Times</span>
        </div>
        <span class="collapsible-icon">‚ñº</span>
    </div>
    <div class="collapsible-content">
        <div class="card" style="margin-top:12px;padding:16px 20px;border-radius:10px;">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:12px;">
        <div class="section-label" style="margin-bottom:0;">Estimated Arrival Times & Time Bank</div>
        <div style="display:flex;align-items:center;gap:6px;">
            <label for="start-time-input" style="font-size:0.78rem;color:var(--text-light);font-weight:500;">Start Time:</label>
            <input type="time" id="start-time-input" value="{{ plan.start_time }}" class="start-time-input">
        </div>
    </div>
    <div id="tod-start-label" style="font-size:0.75rem;color:var(--text-light);margin-bottom:10px;">
        Based on {{ plan.start_time }} start. Time banked (+) or lost (&minus;) against {{ plan.cutoff_hours }}h cutoff.
    </div>
    {# Column headers #}
    <div class="tod-grid" style="margin-bottom:4px;">
        <span class="tod-header">Location</span>
        <span class="tod-header" style="text-align:right;">ETA</span>
        <span class="tod-header" style="text-align:right;">Dist</span>
        <span class="tod-header" style="text-align:right;">Time Bank</span>
        <span class="tod-header"></span>
    </div>
    {# Data rows #}
    {% for s in stops %}
    {% if s.time_bank_min is not none and s.stop_type in ['control', 'rest', 'finish', 'start'] and s.distance_miles and s.distance_miles > 0 %}
    <div class="tod-grid">
        <span class="tod-label">{{ s.location }}</span>
        <span class="tod-time arrival-time" data-cum-min="{{ s.cum_time_min }}">
            &mdash;
        </span>
        <span class="tod-dist">{{ "%.1f"|format(s.distance_miles) }} mi</span>
        <span class="tod-bank" style="color:{% if s.time_bank_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};">
            {% if s.time_bank_min >= 0 %}+{% endif %}{% set abs_min = s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min %}{{ (abs_min // 60)|int }}h{{ "%02d"|format(abs_min % 60) }}m
        </span>
        <div class="tod-bar-bg">
            {% set bank_pct = [((s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min) / (plan.cutoff_hours * 60) * 100)|round(0)|int, 100]|min %}
            <div class="tod-bar" style="width:{{ bank_pct }}%;background:{% if s.time_bank_min >= 0 %}linear-gradient(90deg,#86efac,#22c55e){% else %}linear-gradient(90deg,#fca5a5,#dc2626){% endif %};"></div>
        </div>
    </div>
    {% endif %}
    {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{# ===== I. VIEW TOGGLE ===== #}
<div style="display:flex;gap:8px;margin-bottom:16px;">
    <button class="view-toggle active" data-view="cards" onclick="toggleView('cards')">
        <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><rect x="1" y="1" width="14" height="4" rx="1"/><rect x="1" y="7" width="14" height="4" rx="1"/><rect x="1" y="13" width="14" height="2" rx="1"/></svg>
        Journey View
    </button>
    <button class="view-toggle" data-view="table" onclick="toggleView('table')">
        <svg viewBox="0 0 16 16" width="14" height="14" fill="currentColor"><rect x="1" y="1" width="14" height="2"/><rect x="1" y="5" width="14" height="2"/><rect x="1" y="9" width="14" height="2"/><rect x="1" y="13" width="14" height="2"/></svg>
        Table View
    </button>
</div>

{# ===== J. SEGMENT CARDS (gradient difficulty colors) ===== #}
<div id="cards-view">
<div class="segment-cards">
{% for s in stops %}
<div class="segment-card" style="border-left-color:{{ s.difficulty_color }};">
    {% if s.difficulty_label and s.difficulty_label != 'flat' %}<div class="diff-stripe" style="background:{{ s.difficulty_color }};"></div>{% endif %}
    <div class="segment-header">
        <div class="stop-icon {{ s.stop_type }}">
            {% if s.stop_type == 'start' %}&#x1F6A9;{% elif s.stop_type == 'finish' %}&#x1F3C1;{% elif s.stop_type == 'control' %}&#x25C6;{% elif s.stop_type == 'rest' %}&#x2615;{% else %}&#x2022;{% endif %}
        </div>
        <div class="segment-loc">
            <div class="segment-loc-name">{{ s.location }}</div>
            {% if s.notes %}<div class="segment-loc-notes">{{ s.notes }}</div>{% endif %}
        </div>
        <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
            {% if s.difficulty_score and s.difficulty_score > 0 %}
            <span class="diff-badge" style="background:{{ s.difficulty_color }};color:white;">{{ s.difficulty_score }}</span>
            {% endif %}
            <span class="type-badge {{ s.stop_type }}">{{ s.stop_type }}</span>
        </div>
    </div>
    {% if s.seg_dist and s.seg_dist > 0 %}
    <div class="segment-metrics">
        <div class="metric">
            <div class="metric-value">{{ "%.1f"|format(s.seg_dist) }}</div>
            <div class="metric-label">Seg. Miles</div>
        </div>
        <div class="metric">
            <div class="metric-value" style="color:var(--primary);">{{ "%.1f"|format(s.distance_miles) if s.distance_miles else '&mdash;' }}</div>
            <div class="metric-label">Cumul. Mi</div>
        </div>
        {% if s.elevation_gain and s.elevation_gain > 0 %}
        <div class="metric">
            <div class="metric-value elev">{{ "{:,}".format(s.elevation_gain) }}</div>
            <div class="metric-label">Elev. Gain</div>
        </div>
        {% endif %}
        {% if s.ft_per_mi %}
        <div class="metric">
            <div class="metric-value">{{ s.ft_per_mi }}</div>
            <div class="metric-label">Ft/Mi</div>
        </div>
        {% endif %}
        {% if s.segment_time_min and s.segment_time_min > 0 %}
        <div class="metric">
            <div class="metric-value">
                {% if s.segment_time_min >= 60 %}{{ s.segment_time_min // 60 }}h{{ "%02d"|format(s.segment_time_min % 60) }}m{% else %}{{ s.segment_time_min }}m{% endif %}
            </div>
            <div class="metric-label">Seg. Time</div>
        </div>
        {% endif %}
        {% if s.avg_speed %}
        <div class="metric">
            <div class="metric-value">{{ "%.1f"|format(s.avg_speed) }}</div>
            <div class="metric-label">Avg MPH</div>
        </div>
        {% endif %}
        {% if s.time_bank_min is not none %}
        <div class="metric">
            {% set abs_bank = s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min %}
            <div class="metric-value" style="color:{% if s.time_bank_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};font-size:0.82rem;">
                {% if s.time_bank_min >= 0 %}+{% else %}&minus;{% endif %}{{ (abs_bank // 60)|int }}:{{ "%02d"|format(abs_bank % 60) }}
            </div>
            <div class="metric-label">Time Bank</div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endfor %}
</div>
</div>

{# ===== K. DATA TABLE (gradient difficulty colors) ===== #}
<div id="table-view" style="display:none;">
<div class="table-wrap">
<table class="plan-table">
<thead>
<tr>
    <th style="text-align:center;width:32px;">#</th>
    <th style="text-align:left;">Type</th>
    <th style="text-align:left;">Location</th>
    <th style="text-align:right;">Seg. Dist</th>
    <th style="text-align:right;">Cumul. Dist</th>
    <th style="text-align:right;">Elev. Gain</th>
    <th style="text-align:right;">Ft/Mi</th>
    <th style="text-align:right;">Seg. Time</th>
    <th style="text-align:right;">Avg Speed</th>
    {% if plan.cutoff_hours %}<th style="text-align:right;">Time Bank</th>{% endif %}
    <th style="text-align:center;">Diff.</th>
    <th style="text-align:left;">Notes</th>
</tr>
</thead>
<tbody>
{% for s in stops %}
<tr style="border-left:3px solid {{ s.difficulty_color }};">
    <td style="text-align:center;color:var(--text-light);font-size:0.72rem;">{{ loop.index }}</td>
    <td><span class="type-badge {{ s.stop_type }}">{{ s.stop_type }}</span></td>
    <td><div style="font-weight:600;color:var(--primary);font-size:0.82rem;">{{ s.location }}</div></td>
    <td class="num-cell">
        {% if s.seg_dist and s.seg_dist > 0 %}{{ "%.1f"|format(s.seg_dist) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell highlight">
        {% if s.distance_miles is not none %}{{ "%.1f"|format(s.distance_miles) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell" style="color:#dc2626;">
        {% if s.elevation_gain and s.elevation_gain > 0 %}{{ "{:,}".format(s.elevation_gain) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.ft_per_mi %}{{ s.ft_per_mi }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.segment_time_min and s.segment_time_min > 0 %}
            {% if s.segment_time_min >= 60 %}{{ (s.segment_time_min // 60) }}h {{ "%02d"|format(s.segment_time_min % 60) }}m{% else %}{{ s.segment_time_min }}m{% endif %}
        {% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.avg_speed %}{{ "%.1f"|format(s.avg_speed) }} mph{% else %}&mdash;{% endif %}
    </td>
    {% if plan.cutoff_hours %}
    <td class="num-cell">
        {% if s.time_bank_min is not none %}
        {% set abs_bank = s.time_bank_min if s.time_bank_min >= 0 else -s.time_bank_min %}
        <span style="color:{% if s.time_bank_min >= 0 %}#16a34a{% else %}#dc2626{% endif %};font-weight:600;">
            {% if s.time_bank_min >= 0 %}+{% else %}&minus;{% endif %}{{ (abs_bank // 60)|int }}:{{ "%02d"|format(abs_bank % 60) }}
        </span>
        {% else %}&mdash;{% endif %}
    </td>
    {% endif %}
    <td style="text-align:center;">
        {% if s.difficulty_score and s.difficulty_score > 0 %}
        <span class="diff-badge" style="background:{{ s.difficulty_color }};color:white;">{{ s.difficulty_score }}</span>
        {% else %}&mdash;{% endif %}
    </td>
    <td>
        {% if s.notes %}<div style="font-size:0.75rem;color:var(--text-light);max-width:240px;line-height:1.35;">{{ s.notes }}</div>{% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
<tfoot>
<tr>
    <td colspan="3" style="text-align:right;">Totals</td>
    <td class="num-cell">&mdash;</td>
    <td class="num-cell">{{ "%.1f"|format(plan.total_distance_miles) }} mi</td>
    <td class="num-cell" style="color:#dc2626;">{{ "{:,}".format(plan.total_elevation_ft) }} ft</td>
    <td class="num-cell">{{ "%.0f"|format(overall_ft_per_mile) }}</td>
    <td class="num-cell">
        {% if total_time > 0 %}
            {{ (total_time // 60) }}h {{ "%02d"|format(total_time % 60) }}m
        {% endif %}
    </td>
    <td class="num-cell">
        {% if avg_elapsed_speed %}
            {{ "%.1f"|format(avg_elapsed_speed) }} mph
        {% endif %}
    </td>
    {% if plan.cutoff_hours %}<td></td>{% endif %}
    <td></td>
    <td></td>
</tr>
</tfoot>
</table>
</div>
</div>

{# ===== L. BACK LINK ===== #}
<div style="margin-top:25px;">
<a href="javascript:history.back()" class="back-link">&larr; Back</a>
</div>

</div>
{% endblock %}

{% block extra_js %}
<script>
function toggleView(view) {
    document.getElementById('cards-view').style.display = view === 'cards' ? 'block' : 'none';
    document.getElementById('table-view').style.display = view === 'table' ? 'block' : 'none';
    document.querySelectorAll('.view-toggle').forEach(function(b) {
        b.classList.toggle('active', b.dataset.view === view);
    });
}

// Shared function to recalculate all arrival times from a given start time
function recalcArrivalTimes(startTimeStr) {
    var parts = startTimeStr.split(':');
    var startHour = parseInt(parts[0]) || 6;
    var startMin = parseInt(parts[1]) || 0;

    // Update all .arrival-time elements (time bank chart + journey strip ETAs)
    document.querySelectorAll('.arrival-time').forEach(function(el) {
        var cumMin = parseInt(el.dataset.cumMin) || 0;
        var totalMin = startHour * 60 + startMin + cumMin;
        var h = Math.floor(totalMin / 60) % 24;
        var m = totalMin % 60;
        var ampm = h >= 12 ? 'PM' : 'AM';
        var displayH = h % 12 || 12;
        // Journey strip ETAs get ~ prefix
        var prefix = el.classList.contains('journey-eta') ? '~' : '';
        el.textContent = prefix + displayH + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
    });

    // Update hero start time display
    var heroEl = document.getElementById('hero-start-time');
    if (heroEl) heroEl.textContent = startTimeStr;

    // Update subtitle text
    var subtitleEl = document.getElementById('tod-start-label');
    if (subtitleEl) {
        subtitleEl.textContent = 'Based on ' + startTimeStr + ' start. Time banked (+) or lost (\u2212) against {{ plan.cutoff_hours or 0 }}h cutoff.';
    }
}

// Initial calculation on page load
recalcArrivalTimes('{{ plan.start_time }}');

// Start time input change handler
(function() {
    var startInput = document.getElementById('start-time-input');
    if (startInput) {
        startInput.addEventListener('change', function() {
            recalcArrivalTimes(this.value);
        });
    }

    // Auto weather link for upcoming events (using Team Asha route)
    // SAFETY: Only run if upcoming_event exists AND has a date attribute
    {% if upcoming_event and upcoming_event.date is defined %}
    var autoWeatherLink = document.getElementById('auto-weather-link');
    if (autoWeatherLink) {
        var routeId = '{{ weather_route_id or "" }}';
        var planName = '{{ plan.name|replace("'", "\\'") }}';
        var eventDate = '{{ upcoming_event.date if upcoming_event.date is defined else "" }}';
        var eventTime = '{{ upcoming_event.start_time if upcoming_event.start_time is defined else "07:00" }}';

        if (routeId && eventDate) {
            var parts = eventTime.split(':');
            var startHour = parseInt(parts[0]) || 7;
            var startMin = parseInt(parts[1]) || 0;
            var dt = new Date(eventDate + 'T' + (startHour < 10 ? '0' : '') + startHour + ':' + (startMin < 10 ? '0' : '') + startMin + ':00');
            var ts = Math.floor(dt.getTime() / 1000);
            var url = 'https://www.randoplan.com/?pace=B%2B&interval=1&metric=false'
                + '&rwgpsRoute=' + routeId
                + '&provider=weatherapi'
                + '&name=' + encodeURIComponent(planName)
                + '&startTimestamp=' + ts
                + '&zone=America%2FLos_Angeles';
            autoWeatherLink.href = url;
        }
    }
    {% endif %}
})();

// Toggle collapsible sections
function toggleSection(sectionId) {
    var section = document.getElementById(sectionId);
    if (section) {
        section.classList.toggle('expanded');
    }
}

// Sticky header on scroll
(function() {
    var stickyHeader = document.getElementById('sticky-header');
    var heroSection = document.getElementById('hero-section');
    if (!stickyHeader || !heroSection) return;

    window.addEventListener('scroll', function() {
        var heroBottom = heroSection.getBoundingClientRect().bottom;
        if (heroBottom < 60) {
            stickyHeader.classList.add('visible');
        } else {
            stickyHeader.classList.remove('visible');
        }
    });
})();
</script>
{% endblock %}
