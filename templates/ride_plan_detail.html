{% extends "base.html" %}
{% block title %}{{ plan.name }} - Team Asha Randonneuring{% endblock %}

{% block extra_head %}
<style>
.plan-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 0.85rem;
}
.plan-table thead th {
    background: var(--primary);
    color: white;
    font-weight: 600;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 10px 12px;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 2;
}
.plan-table thead th:first-child { border-radius: 8px 0 0 0; }
.plan-table thead th:last-child { border-radius: 0 8px 0 0; }
.plan-table tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}
.plan-table tbody tr:last-child td { border-bottom: none; }
.plan-table tbody tr:hover { background: #f7fafc; }

/* Stop type row coloring */
.plan-table tbody tr.row-start { background: #f0fdf4; }
.plan-table tbody tr.row-start:hover { background: #dcfce7; }
.plan-table tbody tr.row-finish { background: #fef2f2; }
.plan-table tbody tr.row-finish:hover { background: #fee2e2; }
.plan-table tbody tr.row-control { background: #eff6ff; }
.plan-table tbody tr.row-control:hover { background: #dbeafe; }
.plan-table tbody tr.row-rest { background: #fffbeb; }
.plan-table tbody tr.row-rest:hover { background: #fef3c7; }

/* Type badges */
.type-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.65rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
}
.type-badge.start { background: #dcfce7; color: #166534; }
.type-badge.finish { background: #fee2e2; color: #991b1b; }
.type-badge.control { background: #dbeafe; color: #1e40af; }
.type-badge.rest { background: #fef3c7; color: #92400e; }
.type-badge.waypoint { background: #f1f5f9; color: #475569; }

.loc-name {
    font-weight: 600;
    color: var(--primary);
    font-size: 0.85rem;
    line-height: 1.3;
}
.loc-notes {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 3px;
    line-height: 1.35;
    max-width: 280px;
}
.num-cell {
    text-align: right;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
}
.num-cell.highlight {
    font-weight: 700;
    color: var(--primary);
}
.elev-cell {
    color: #dc2626;
}

/* Summary totals row */
.plan-table tfoot td {
    padding: 12px;
    font-weight: 700;
    background: #f8fafc;
    border-top: 2px solid var(--border);
    font-size: 0.85rem;
}

/* Legend */
.plan-legend {
    display: flex;
    gap: 16px;
    flex-wrap: wrap;
    margin-bottom: 16px;
    padding: 8px 14px;
    background: #f8fafc;
    border-radius: 8px;
    font-size: 0.75rem;
    color: var(--text-light);
}
.plan-legend-item {
    display: inline-flex;
    align-items: center;
    gap: 5px;
}
.plan-legend-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
}

/* Route links */
.route-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    text-decoration: none;
    font-size: 0.85rem;
    font-weight: 600;
    transition: box-shadow 0.15s, transform 0.15s;
}
.route-link:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateY(-1px);
}
.route-link img { width: 18px; height: 18px; }

/* Responsive: horizontal scroll on small screens */
@media (max-width: 768px) {
    .plan-table { font-size: 0.78rem; }
    .plan-table thead th, .plan-table tbody td { padding: 8px 8px; }
    .loc-notes { max-width: 180px; }
}
</style>
{% endblock %}

{% block content %}
<div class="hero" style="padding:40px 20px;">
<h1>{{ plan.name }}</h1>
<p>Ride plan with stops, timing, and terrain details</p>
</div>

{# ===== SUMMARY STATS ===== #}
<div class="stats-row">
<div class="stat-card">
    <div class="number">{{ "%.1f"|format(plan.total_distance_miles) }}</div>
    <div class="label">Miles</div>
</div>
<div class="stat-card">
    <div class="number">{{ "{:,}".format(plan.total_elevation_ft) }}</div>
    <div class="label">Feet of Climbing</div>
</div>
<div class="stat-card">
    <div class="number">{{ "%.0f"|format(plan.total_elevation_ft / plan.total_distance_miles) }}</div>
    <div class="label">Ft/Mile</div>
</div>
{% set total_time = stops|selectattr('segment_time_min')|map(attribute='segment_time_min')|sum %}
{% if total_time > 0 %}
<div class="stat-card">
    <div class="number">{{ "%.1f"|format(total_time / 60) }}h</div>
    <div class="label">Est. Total Time</div>
</div>
{% endif %}
</div>

<div class="container section">

{# ===== RWGPS LINKS ===== #}
{% if plan.rwgps_url or plan.rwgps_url_team %}
<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;">
{% if plan.rwgps_url %}
<a href="{{ plan.rwgps_url }}" target="_blank" class="route-link" style="color:var(--primary);">
    <img src="https://ridewithgps.com/favicon.ico" alt="">
    Official Route
</a>
{% endif %}
{% if plan.rwgps_url_team %}
<a href="{{ plan.rwgps_url_team }}" target="_blank" class="route-link" style="color:var(--accent);">
    <img src="https://ridewithgps.com/favicon.ico" alt="">
    Team Asha Route (with controls)
</a>
{% endif %}
</div>
{% endif %}

{# ===== LEGEND ===== #}
<div class="plan-legend">
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#22c55e;"></span> Start</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#e53e3e;"></span> Finish</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#3b82f6;"></span> Control</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#f59e0b;"></span> Rest / Food / Water</span>
<span class="plan-legend-item"><span class="plan-legend-dot" style="background:#94a3b8;"></span> Waypoint</span>
</div>

{# ===== TABLE VIEW ===== #}
<div class="table-wrap">
<table class="plan-table">
<thead>
<tr>
    <th style="text-align:center;width:36px;">#</th>
    <th style="text-align:left;">Type</th>
    <th style="text-align:left;">Location</th>
    <th style="text-align:right;">Seg. Dist</th>
    <th style="text-align:right;">Cumul. Dist</th>
    <th style="text-align:right;">Elev. Gain</th>
    <th style="text-align:right;">Ft/Mi</th>
    <th style="text-align:right;">Seg. Time</th>
    <th style="text-align:right;">Avg Speed</th>
    <th style="text-align:left;">Notes</th>
</tr>
</thead>
<tbody>
{% set cum_time = [0] %}
{% for s in stops %}
{% set prev_dist = stops[loop.index0 - 1].distance_miles if loop.index0 > 0 and stops[loop.index0 - 1].distance_miles is not none else 0.0 %}
{% set cur_dist = s.distance_miles if s.distance_miles is not none else 0.0 %}
{% set seg_dist = (cur_dist - prev_dist)|round(1) %}
{% set ft_per_mi = ((s.elevation_gain / seg_dist)|round(0)|int) if s.elevation_gain and seg_dist > 0 else None %}
{% set avg_speed = ((seg_dist / (s.segment_time_min / 60.0))|round(1)) if s.segment_time_min and s.segment_time_min > 0 and seg_dist > 0 else None %}
{% if s.segment_time_min %}{% set _ = cum_time.append(cum_time[-1] + s.segment_time_min) %}{% endif %}
<tr class="row-{{ s.stop_type }}">
    <td style="text-align:center;color:var(--text-light);font-size:0.75rem;">{{ loop.index }}</td>
    <td><span class="type-badge {{ s.stop_type }}">{{ s.stop_type }}</span></td>
    <td>
        <div class="loc-name">{{ s.location }}</div>
    </td>
    <td class="num-cell">
        {% if seg_dist and seg_dist > 0 %}{{ "%.1f"|format(seg_dist) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell highlight">
        {% if s.distance_miles is not none %}{{ "%.1f"|format(s.distance_miles) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell elev-cell">
        {% if s.elevation_gain and s.elevation_gain > 0 %}{{ "{:,}".format(s.elevation_gain) }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if ft_per_mi %}{{ ft_per_mi }}{% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if s.segment_time_min and s.segment_time_min > 0 %}
            {% if s.segment_time_min >= 60 %}
                {{ (s.segment_time_min // 60) }}h {{ "%02d"|format(s.segment_time_min % 60) }}m
            {% else %}
                {{ s.segment_time_min }}m
            {% endif %}
        {% else %}&mdash;{% endif %}
    </td>
    <td class="num-cell">
        {% if avg_speed %}{{ "%.1f"|format(avg_speed) }} mph{% else %}&mdash;{% endif %}
    </td>
    <td>
        {% if s.notes %}<div class="loc-notes">{{ s.notes }}</div>{% endif %}
    </td>
</tr>
{% endfor %}
</tbody>
<tfoot>
<tr>
    <td colspan="3" style="text-align:right;">Totals</td>
    <td class="num-cell">&mdash;</td>
    <td class="num-cell">{{ "%.1f"|format(plan.total_distance_miles) }} mi</td>
    <td class="num-cell" style="color:#dc2626;">{{ "{:,}".format(plan.total_elevation_ft) }} ft</td>
    <td class="num-cell">{{ "%.0f"|format(plan.total_elevation_ft / plan.total_distance_miles) }}</td>
    <td class="num-cell">
        {% if total_time > 0 %}
            {{ (total_time // 60) }}h {{ "%02d"|format(total_time % 60) }}m
        {% endif %}
    </td>
    <td class="num-cell">
        {% if total_time > 0 %}
            {{ "%.1f"|format(plan.total_distance_miles / (total_time / 60)) }} mph
        {% endif %}
    </td>
    <td></td>
</tr>
</tfoot>
</table>
</div>

{# ===== BACK LINK ===== #}
<div style="margin-top:25px;">
<a href="javascript:history.back()" class="back-link">&larr; Back</a>
</div>

</div>
{% endblock %}
