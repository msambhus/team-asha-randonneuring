{% extends "base.html" %}
{% block title %}{{ season_label }} - Team Asha Randonneuring{% endblock %}

{% macro badge(status, finish_time='') %}
{% set v = status|string|lower|trim %}
{% if v in ('yes', '1') %}
<span class="badge badge-yes">&#x2713;</span>
{% if finish_time %}<br><span style="font-size:0.7rem;color:#666;">{{ finish_time }}</span>{% endif %}
{% elif v == 'dnf' %}
{# empty #}
{% elif v == 'dns' %}
<span class="badge badge-dns">DNS</span>
{% elif v == 'maybe' %}
<span class="badge badge-maybe">Maybe</span>
{% elif v == 'otl' %}
<span class="badge badge-dnf">OTL</span>
{% elif v not in ('no', '0', '', 'nan', 'none') %}
<span class="badge">{{ status }}</span>
{% endif %}
{% endmacro %}

{% block content %}
<div class="hero" style="padding:40px 20px;">
<h1>{{ season_label }}</h1>
<p>{% if is_current %}Completed Brevets this season{% else %}Season brevet participation{% endif %}</p>
</div>

<div class="stats-row">
<div class="stat-card"><div class="number">{{ stats.active_riders }}</div><div class="label">Active Riders</div></div>
<div class="stat-card"><div class="number">{{ stats.total_rides }}</div><div class="label">Brevets Completed</div></div>
<div class="stat-card"><div class="number">{{ stats.total_kms|commafy }}</div><div class="label">Total Kilometers</div></div>
{% if stats.sr_rider_count > 0 %}
<div class="stat-card"><div class="number">{{ stats.sr_rider_count }}</div><div class="label">Super Randonneurs</div></div>
{% endif %}
{% if pbp_finishers %}
<div class="stat-card"><div class="number" style="font-size:1.6rem;"><span class="pbp-badge" style="font-size:1rem;">PBP 2023</span></div><div class="label">{{ pbp_finishers|length }} Finishers</div></div>
{% endif %}
{% if is_current and upcoming_count > 0 %}
<a href="{{ url_for('riders.upcoming_brevets', season_name=season.name) }}" class="stat-card" style="text-decoration:none;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;">
<div class="number">{{ upcoming_count }}</div><div class="label">Upcoming Brevets &rarr;</div>
</a>
{% endif %}
</div>

{# ===== PBP FINISHERS SECTION (2022-2023 only) ===== #}
{% if pbp_finishers %}
<div class="container section" style="padding-top:20px;padding-bottom:10px;">
<h2>Paris-Brest-Paris 2023 Finishers</h2>
<p style="margin-bottom:20px;color:var(--text-light);">11 Team Asha riders completed the legendary 1,200 km Paris-Brest-Paris randonn√©e in August 2023.</p>

<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;">
{% for f in pbp_finishers %}
<a href="{{ url_for('riders.rider_profile', rusa_id=f.rusa_id) }}" class="card" style="display:flex;align-items:center;gap:14px;padding:16px 18px;text-decoration:none;color:inherit;transition:transform 0.15s,box-shadow 0.15s;border-left:4px solid #805ad5;">
    {% if f.photo_filename %}
    <img src="{{ url_for('static', filename='riders/' + f.photo_filename) }}" alt="{{ f.first_name }}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;flex-shrink:0;">
    {% else %}
    <div style="width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#805ad5,#b794f4);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:1.1rem;flex-shrink:0;">{{ f.first_name[0] }}</div>
    {% endif %}
    <div style="flex:1;min-width:0;">
        <div style="font-weight:700;color:var(--primary);">{{ f.first_name }} {{ f.last_name }}</div>
        <div style="font-size:0.85rem;color:var(--text-light);">{{ f.finish_time }}h</div>
    </div>
    <span class="pbp-badge">PBP</span>
</a>
{% endfor %}
</div>
</div>
{% endif %}

{# ===== PER-RIDER SUMMARY (past seasons only) ===== #}
{% if not is_current %}
<div class="container section" style="padding-top:20px;">
<h2>Rider Summary</h2>

<div class="table-wrap" style="margin-top:15px;">
<table id="summary-table">
<thead>
<tr>
<th class="sortable" data-sort="rider" data-type="text" style="min-width:200px;">Rider <span class="sort-icon"></span></th>
<th class="sortable" data-sort="rusa" data-type="number" style="min-width:80px;">RUSA# <span class="sort-icon"></span></th>
<th class="sortable" data-sort="rides" data-type="number" style="min-width:70px;text-align:center;">Rides <span class="sort-icon"></span></th>
<th class="sortable" data-sort="kms" data-type="number" style="min-width:90px;text-align:center;">Kilometers <span class="sort-icon"></span></th>
<th style="min-width:80px;text-align:center;">SR</th>
</tr>
</thead>
<tbody>
{% for rd in riders %}
<tr>
<td data-sort-value="{{ rd.rider.first_name }} {{ rd.rider.last_name }}">
    <a href="{{ url_for('riders.rider_profile', rusa_id=rd.rider.rusa_id) }}" class="rider-link">{{ rd.rider.first_name }} {{ rd.rider.last_name }}</a>
</td>
<td data-sort-value="{{ rd.rider.rusa_id }}">{{ rd.rider.rusa_id }}</td>
<td data-sort-value="{{ rd.rides }}" style="text-align:center;font-weight:700;">{{ rd.rides }}</td>
<td data-sort-value="{{ rd.kms }}" style="text-align:center;font-weight:700;">{{ rd.kms|commafy }}</td>
<td style="text-align:center;">
    {% if rd.sr_count > 0 %}<span class="sr-badge">{% if rd.sr_count > 1 %}SR*{{ rd.sr_count }}{% else %}SR{% endif %}</span>{% endif %}
</td>
</tr>
{% endfor %}
{# Totals row #}
<tr style="background:var(--primary);color:white;font-weight:700;">
<td colspan="2" style="border-bottom:none;">Total ({{ riders|length }} riders)</td>
<td style="text-align:center;border-bottom:none;">{{ stats.total_rides }}</td>
<td style="text-align:center;border-bottom:none;">{{ stats.total_kms|commafy }}</td>
<td style="text-align:center;border-bottom:none;">{% if stats.sr_rider_count > 0 %}{{ stats.sr_rider_count }}{% endif %}</td>
</tr>
</tbody>
</table>
</div>
</div>
{% endif %}

{# ===== DETAILED RIDE PARTICIPATION GRID ===== #}
<div class="container section">
{% if not is_current %}
<h2>Ride Details</h2>
{% else %}
<h2>Rider Participation</h2>
{% endif %}

<div style="margin-top:15px;">
<div class="table-wrap">
<table class="frozen-table" id="riders-table">
<thead>
<tr>
<th class="frozen-col frozen-col-1 sortable" data-sort="rider" data-type="text">Rider <span class="sort-icon"></span></th><th class="frozen-col frozen-col-2 sortable" data-sort="rusa" data-type="number">RUSA# <span class="sort-icon"></span></th><th class="frozen-col frozen-col-3 sortable" data-sort="rides" data-type="number">Rides <span class="sort-icon"></span></th><th class="frozen-col frozen-col-4 sortable" data-sort="kms" data-type="number">KMs <span class="sort-icon"></span></th>
{% for ride in past_rides %}
<th style="min-width:70px;padding:6px 4px;line-height:1.3;">
    <div style="font-weight:700;font-size:0.75rem;">{{ ride.name }}</div>
    <div style="font-size:0.7rem;color:rgba(255,255,255,0.7);">{{ ride.date }}</div>
    {% if ride.elevation_ft %}<div style="font-size:0.65rem;color:var(--accent-light);margin-top:2px;">{{ "{:,}".format(ride.elevation_ft) }}ft</div>{% endif %}
    {% if ride.ft_per_mile %}<div style="font-size:0.65rem;color:rgba(255,255,255,0.7);">{{ ride.ft_per_mile }}ft/mi</div>{% endif %}
    {% if ride.rwgps_url %}<div style="min-height:18px;margin-top:2px;"><a href="{{ ride.rwgps_url }}" target="_blank" title="View route" style="color:var(--accent-light);text-decoration:none;">&#x1F5FA;</a></div>{% endif %}
</th>
{% endfor %}
</tr>
</thead>
<tbody>
{% for rd in riders %}
<tr>
<td class="frozen-col frozen-col-1" data-sort-value="{{ rd.rider.first_name }} {{ rd.rider.last_name }}"><a href="{{ url_for('riders.rider_profile', rusa_id=rd.rider.rusa_id) }}" class="rider-link">{{ rd.rider.first_name }} {{ rd.rider.last_name }}</a>
{% if rd.sr_count > 0 %} <span class="sr-badge">{% if rd.sr_count > 1 %}SR*{{ rd.sr_count }}{% else %}SR{% endif %}</span>{% endif %}
</td>
<td class="frozen-col frozen-col-2" data-sort-value="{{ rd.rider.rusa_id }}">{{ rd.rider.rusa_id }}</td>
<td class="frozen-col frozen-col-3" data-sort-value="{{ rd.rides }}" style="text-align:center;font-weight:700;">{{ rd.rides }}</td>
<td class="frozen-col frozen-col-4" data-sort-value="{{ rd.kms }}" style="text-align:center;font-weight:700;">{{ rd.kms|commafy }}</td>
{% for ride in past_rides %}
{% set p = rd.participation.get(ride.id, {}) %}
<td style="text-align:center;">{{ badge(p.get('status', ''), p.get('finish_time', '')) }}</td>
{% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<p style="margin-top:15px;color:var(--text-light);font-size:0.85rem;">Click on a rider's name to see their full history across all seasons.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    // Sortable table logic - works for both summary-table and riders-table
    function initSortable(tableId) {
        const table = document.getElementById(tableId);
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const headers = table.querySelectorAll('th.sortable');

        let currentSort = { column: null, direction: 'asc' };

        headers.forEach(header => {
            header.style.cursor = 'pointer';
            header.addEventListener('click', function() {
                const sortKey = this.getAttribute('data-sort');
                const sortType = this.getAttribute('data-type');

                if (currentSort.column === sortKey) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.direction = 'asc';
                }
                currentSort.column = sortKey;

                headers.forEach(h => {
                    const icon = h.querySelector('.sort-icon');
                    if (h === this) {
                        icon.textContent = currentSort.direction === 'asc' ? ' \u25B2' : ' \u25BC';
                        icon.style.opacity = '1';
                    } else {
                        icon.textContent = ' \u25B2';
                        icon.style.opacity = '0.3';
                    }
                });

                const rows = Array.from(tbody.querySelectorAll('tr'));
                // Exclude totals row (last row with colspan)
                const dataRows = rows.filter(r => !r.querySelector('td[colspan]'));
                const totalRow = rows.find(r => r.querySelector('td[colspan]'));

                dataRows.sort((a, b) => {
                    let aVal, bVal;
                    const aCells = a.querySelectorAll('[data-sort-value]');
                    const bCells = b.querySelectorAll('[data-sort-value]');

                    if (sortKey === 'rider') {
                        aVal = aCells[0] ? aCells[0].getAttribute('data-sort-value').toLowerCase() : '';
                        bVal = bCells[0] ? bCells[0].getAttribute('data-sort-value').toLowerCase() : '';
                    } else if (sortKey === 'rusa') {
                        aVal = parseInt(aCells[1] ? aCells[1].getAttribute('data-sort-value') : 0);
                        bVal = parseInt(bCells[1] ? bCells[1].getAttribute('data-sort-value') : 0);
                    } else if (sortKey === 'rides') {
                        aVal = parseInt(aCells[2] ? aCells[2].getAttribute('data-sort-value') : 0);
                        bVal = parseInt(bCells[2] ? bCells[2].getAttribute('data-sort-value') : 0);
                    } else if (sortKey === 'kms') {
                        aVal = parseInt(aCells[3] ? aCells[3].getAttribute('data-sort-value') : 0);
                        bVal = parseInt(bCells[3] ? bCells[3].getAttribute('data-sort-value') : 0);
                    }

                    if (sortType === 'number') {
                        return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    } else {
                        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                        return 0;
                    }
                });

                dataRows.forEach(row => tbody.appendChild(row));
                if (totalRow) tbody.appendChild(totalRow);
            });
        });

        headers.forEach(h => {
            const icon = h.querySelector('.sort-icon');
            icon.textContent = ' \u25B2';
            icon.style.opacity = '0.3';
        });
    }

    initSortable('summary-table');
    initSortable('riders-table');
})();
</script>
{% endblock %}
