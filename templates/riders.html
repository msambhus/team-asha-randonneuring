{% extends "base.html" %}
{% block title %}{{ season_label }} - Team Asha Randonneuring{% endblock %}

{% macro badge(status, finish_time='') %}
{% set v = status|string|lower|trim %}
{% if v in ('yes', '1') %}
<span class="badge badge-yes">&#x2713;</span>
{% if finish_time %}<br><span style="font-size:0.7rem;color:#666;">{{ finish_time }}</span>{% endif %}
{% elif v == 'dnf' %}
{# empty #}
{% elif v == 'dns' %}
<span class="badge badge-dns">DNS</span>
{% elif v == 'maybe' %}
<span class="badge badge-maybe">Maybe</span>
{% elif v == 'otl' %}
<span class="badge badge-dnf">OTL</span>
{% elif v not in ('no', '0', '', 'nan', 'none') %}
<span class="badge">{{ status }}</span>
{% endif %}
{% endmacro %}

{% block content %}
<div class="hero" style="padding:40px 20px;">
<h1>{{ season_label }}</h1>
<p>{% if is_current %}Completed Brevets this season{% else %}Season brevet participation{% endif %}</p>
</div>

<div class="stats-row">
<div class="stat-card"><div class="number">{{ stats.active_riders }}</div><div class="label">Active Riders</div></div>
<div class="stat-card"><div class="number">{{ stats.total_rides }}</div><div class="label">Brevets Completed</div></div>
<div class="stat-card"><div class="number">{{ stats.total_kms|commafy }}</div><div class="label">Total Kilometers</div></div>
{% if stats.sr_rider_count > 0 %}
<div class="stat-card"><div class="number">{{ stats.sr_rider_count }}</div><div class="label">Super Randonneurs</div></div>
{% endif %}
{% if is_current and upcoming_count > 0 %}
<a href="{{ url_for('riders.upcoming_brevets', season_name=season.name) }}" class="stat-card" style="text-decoration:none;cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;">
<div class="number">{{ upcoming_count }}</div><div class="label">Upcoming Brevets &rarr;</div>
</a>
{% endif %}
</div>

<div class="container section">
<h2>Rider Participation</h2>

<div style="margin-top:15px;">
<div class="table-wrap">
<table class="frozen-table" id="riders-table">
<thead>
<tr>
<th class="frozen-col frozen-col-1 sortable" data-sort="rider" data-type="text">Rider <span class="sort-icon"></span></th><th class="frozen-col frozen-col-2 sortable" data-sort="rusa" data-type="number">RUSA# <span class="sort-icon"></span></th><th class="frozen-col frozen-col-3 sortable" data-sort="rides" data-type="number">Rides <span class="sort-icon"></span></th><th class="frozen-col frozen-col-4 sortable" data-sort="kms" data-type="number">KMs <span class="sort-icon"></span></th>
{% for ride in past_rides %}
<th style="min-width:70px;padding:6px 4px;line-height:1.3;">
    <div style="font-weight:700;font-size:0.75rem;">{{ ride.name }}</div>
    <div style="font-size:0.7rem;color:rgba(255,255,255,0.7);">{{ ride.date }}</div>
    {% if ride.elevation_ft %}<div style="font-size:0.65rem;color:var(--accent-light);margin-top:2px;">{{ "{:,}".format(ride.elevation_ft) }}ft</div>{% endif %}
    {% if ride.ft_per_mile %}<div style="font-size:0.65rem;color:rgba(255,255,255,0.7);">{{ ride.ft_per_mile }}ft/mi</div>{% endif %}
    {% if ride.rwgps_url %}<div style="min-height:18px;margin-top:2px;"><a href="{{ ride.rwgps_url }}" target="_blank" title="View route" style="color:var(--accent-light);text-decoration:none;">&#x1F5FA;</a></div>{% endif %}
</th>
{% endfor %}
</tr>
</thead>
<tbody>
{% for rd in riders %}
<tr>
<td class="frozen-col frozen-col-1" data-sort-value="{{ rd.rider.first_name }} {{ rd.rider.last_name }}"><a href="{{ url_for('riders.rider_profile', rusa_id=rd.rider.rusa_id) }}" class="rider-link">{{ rd.rider.first_name }} {{ rd.rider.last_name }}</a>
{% if rd.sr_count > 0 %} <span class="sr-badge">{% if rd.sr_count > 1 %}SR*{{ rd.sr_count }}{% else %}SR{% endif %}</span>{% endif %}
</td>
<td class="frozen-col frozen-col-2" data-sort-value="{{ rd.rider.rusa_id }}">{{ rd.rider.rusa_id }}</td>
<td class="frozen-col frozen-col-3" data-sort-value="{{ rd.rides }}" style="text-align:center;font-weight:700;">{{ rd.rides }}</td>
<td class="frozen-col frozen-col-4" data-sort-value="{{ rd.kms }}" style="text-align:center;font-weight:700;">{{ rd.kms|commafy }}</td>
{% for ride in past_rides %}
{% set p = rd.participation.get(ride.id, {}) %}
<td style="text-align:center;">{{ badge(p.get('status', ''), p.get('finish_time', '')) }}</td>
{% endfor %}
</tr>
{% endfor %}
</tbody>
</table>
</div>
</div>

<p style="margin-top:15px;color:var(--text-light);font-size:0.85rem;">Click on a rider's name to see their full history across all seasons.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const table = document.getElementById('riders-table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('th.sortable');
    
    let currentSort = { column: null, direction: 'asc' };
    
    headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
            const sortKey = this.getAttribute('data-sort');
            const sortType = this.getAttribute('data-type');
            
            // Toggle direction if same column, otherwise reset to asc
            if (currentSort.column === sortKey) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.direction = 'asc';
            }
            currentSort.column = sortKey;
            
            // Update sort icons
            headers.forEach(h => {
                const icon = h.querySelector('.sort-icon');
                if (h === this) {
                    icon.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼';
                    icon.style.opacity = '1';
                } else {
                    icon.textContent = ' ▲';
                    icon.style.opacity = '0.3';
                }
            });
            
            // Get all rows
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;
                
                if (sortKey === 'rider') {
                    aVal = a.querySelector('[data-sort-value]').getAttribute('data-sort-value').toLowerCase();
                    bVal = b.querySelector('[data-sort-value]').getAttribute('data-sort-value').toLowerCase();
                } else if (sortKey === 'rusa') {
                    aVal = parseInt(a.querySelectorAll('[data-sort-value]')[1].getAttribute('data-sort-value'));
                    bVal = parseInt(b.querySelectorAll('[data-sort-value]')[1].getAttribute('data-sort-value'));
                } else if (sortKey === 'rides') {
                    aVal = parseInt(a.querySelectorAll('[data-sort-value]')[2].getAttribute('data-sort-value'));
                    bVal = parseInt(b.querySelectorAll('[data-sort-value]')[2].getAttribute('data-sort-value'));
                } else if (sortKey === 'kms') {
                    aVal = parseInt(a.querySelectorAll('[data-sort-value]')[3].getAttribute('data-sort-value'));
                    bVal = parseInt(b.querySelectorAll('[data-sort-value]')[3].getAttribute('data-sort-value'));
                }
                
                if (sortType === 'number') {
                    return currentSort.direction === 'asc' ? aVal - bVal : bVal - aVal;
                } else {
                    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                }
            });
            
            // Re-append rows in sorted order
            rows.forEach(row => tbody.appendChild(row));
        });
    });
    
    // Initialize sort icons
    headers.forEach(h => {
        const icon = h.querySelector('.sort-icon');
        icon.textContent = ' ▲';
        icon.style.opacity = '0.3';
    });
})();
</script>
{% endblock %}
