{% extends "base.html" %}
{% block title %}Upcoming Brevets - {{ season_label }} - Team Asha Randonneuring{% endblock %}

{% block extra_head %}
<style>
.filter-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--border);
}
.filter-label {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 12px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.filter-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.region-filter {
    cursor: pointer;
    padding: 10px 18px;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid var(--border);
    background: white;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.region-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--primary);
}
.region-filter.active {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
}
.region-filter.active .region-dot {
    background: white !important;
}
.region-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}
.month-section {
    margin-bottom: 40px;
}
.month-header {
    background: linear-gradient(135deg, #0891b2, #0e7490);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 1.3rem;
    font-weight: 800;
    margin-bottom: 20px;
    display: inline-block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}
.event-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}
.event-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    transition: transform 0.3s ease;
}
.event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border-color: var(--primary);
}
.event-card.hidden {
    display: none !important;
}
.event-date {
    position: absolute;
    top: 20px;
    right: 20px;
    text-align: center;
    background: linear-gradient(135deg, #1e40af, #1e3a8a);
    color: white;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.event-day {
    font-size: 1.8rem;
    font-weight: 800;
    line-height: 1;
    color: white;
}
.event-month {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 2px;
    color: #fb923c;
}
.event-region-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    color: white;
    margin-bottom: 12px;
}
.event-distance {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 8px;
}
.event-elevation {
    font-size: 0.8rem;
    color: var(--text-light);
    font-weight: 500;
}
.event-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--primary);
    margin: 12px 0 8px 0;
    line-height: 1.4;
    padding-right: 80px;
}
.event-links {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}
.event-link-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    border: 1px solid var(--border);
}
.event-link-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.event-details-info {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    font-size: 0.8rem;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    gap: 4px;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
    .events-grid {
        grid-template-columns: 1fr;
    }
    .filter-section {
        padding: 15px;
    }
    .filter-buttons {
        gap: 8px;
    }
    .region-filter {
        padding: 8px 14px;
        font-size: 0.85rem;
    }
    .event-card {
        padding: 16px;
    }
    .event-title {
        font-size: 0.95rem;
        padding-right: 70px;
    }
    .event-date {
        top: 16px;
        right: 16px;
        padding: 6px 10px;
    }
    .event-day {
        font-size: 1.5rem;
    }
    .month-header {
        font-size: 1.1rem;
        padding: 10px 16px;
    }
}

@media (max-width: 480px) {
    .region-filter {
        font-size: 0.8rem;
        padding: 7px 12px;
    }
    .event-distance {
        font-size: 1.3rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="hero" style="padding:40px 20px;">
<h1>Upcoming Brevets</h1>
<p>{{ season_label }} &mdash; RUSA events in the Bay Area</p>
</div>

<div class="container section">
<h2 style="margin-bottom:25px;">Ride Calendar</h2>

<div class="filter-section">
    <div class="filter-label">Filter by Club</div>
    <div class="filter-buttons">
        <span class="region-filter active" data-region="all" onclick="filterByRegion('all')">
            <span class="region-dot" style="background:#666;"></span>All Clubs
        </span>
        {% for region, color in region_colors.items() %}
        <span class="region-filter" data-region="{{ region }}" onclick="filterByRegion('{{ region }}')">
            <span class="region-dot" style="background:{{ color }};"></span>{{ region }}
        </span>
        {% endfor %}
    </div>

    {% if distances %}
    <div class="filter-label" style="margin-top:20px;">Filter by Distance</div>
    <div class="filter-buttons">
        <span class="region-filter active" data-distance="all" onclick="filterByDistance('all')">All Distances</span>
        {% for d in distances %}
        <span class="region-filter" data-distance="{{ d }}" onclick="filterByDistance('{{ d }}')">{{ d }}k</span>
        {% endfor %}
    </div>
    {% endif %}
</div>

<p style="font-size:0.85rem;color:var(--text-light);margin-bottom:30px;">Events sourced from <a href="https://rusa.org/cgi-bin/eventsearch_GF.pl" target="_blank" style="color:var(--accent);font-weight:600;">RUSA</a> for Davis, San Francisco &amp; Santa Cruz regions.</p>

<div id="events-container">
{% for event in rusa_events %}
<div class="event-card" data-region="{{ event.region }}" data-distance="{{ event.distance_km }}" data-event-date="{{ event.date }}" data-event-time="{{ event.start_time or '07:00' }}" data-rwgps-url="{{ event.rwgps_url or '' }}" data-route-name="{{ event.route_name }}" data-month="{{ event.date_str[0:7] }}" style="border-left-color:{{ region_colors.get(event.region, '#999') }};">

    <div class="event-date">
        <div class="event-day">{{ event.date_str[8:10] }}</div>
        <div class="event-month">{{ ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][event.date_str[5:7]|int] }}</div>
    </div>

    <div class="event-region-badge" style="background:{{ region_colors.get(event.region, '#999') }};">
        <span class="region-dot" style="background:white;"></span>{{ event.region }}
    </div>

    <div class="event-distance">
        {% if event.distance_miles %}
        {{ "%.1f"|format(event.distance_miles) }} mi
        {% else %}
        {{ event.distance_km }} km
        {% endif %}
        {% if event.elevation_ft %}
        {% set miles = event.distance_miles if event.distance_miles else (event.distance_km * 0.621371) %}
        <div class="event-elevation">
            {{ "{:,}".format(event.elevation_ft) }} ft{% if miles > 0 %} ({{ "%.0f"|format(event.elevation_ft / miles) }} ft/mi){% endif %}
        </div>
        {% endif %}
    </div>

    <div class="event-title" style="overflow-wrap:break-word;word-break:break-word;">
        {% if 'DART' in event.route_name or 'Dart' in event.route_name or 'Fleche' in event.route_name or (event.rwgps_url and ('dart' in event.rwgps_url.lower() or 'fleche' in event.rwgps_url.lower() or 'sfrandonneurs.org/fleche' in event.rwgps_url.lower())) %}
        <span style="color:var(--accent);font-weight:800;">[DART]</span>
        {% endif %}
        {{ event.route_name }}{% if event.ride_type %} <span style="color:var(--text-light);font-size:0.75rem;font-weight:600;white-space:nowrap;">[{{ event.ride_type }}]</span>{% endif %}
    </div>

    <div class="event-links">
        {% if event.rwgps_url %}
        <a href="{{ event.rwgps_url }}" target="_blank" class="event-link-btn" style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-color:#7dd3fc;color:#0369a1;">
            <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:16px;height:16px;">
            Route
        </a>
        {% endif %}

        <span class="weather-forecast-link" style="display:none;">
            <a href="#" target="_blank" class="event-link-btn" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fbbf24;color:#92400e;">
                üå§Ô∏è Weather
            </a>
        </span>

        {% if event.plan_rwgps_url_team %}
        <a href="{{ event.plan_rwgps_url_team }}" target="_blank" class="event-link-btn" style="background:linear-gradient(135deg,#fff7ed,#ffedd5);border-color:#ff6b00;color:#c2410c;">
            <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:16px;height:16px;">
            Team Asha Route
        </a>
        {% endif %}

        {% if event.plan_slug %}
        <a href="{{ url_for('riders.ride_plan_detail', slug=event.plan_slug) }}" class="event-link-btn" style="background:linear-gradient(135deg,#f0f4ff,#e8f0fe);border-color:#c7d2fe;color:#4338ca;">
            üìç Ride Plan
        </a>
        {% endif %}
    </div>

    {% if event.start_time or event.time_limit_hours or event.start_location %}
    <div class="event-details-info">
        {% if event.start_time %}
        <div><strong>Start:</strong> {{ event.start_time }}</div>
        {% endif %}
        {% if event.time_limit_hours %}
        <div><strong>Time Limit:</strong> {{ event.time_limit_hours }}h</div>
        {% endif %}
        {% if event.start_location %}
        <div><strong>Location:</strong> {{ event.start_location }}</div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endfor %}
</div>

{% if not rusa_events %}
<p style="padding:40px;color:var(--text-light);text-align:center;font-size:1.1rem;">No upcoming RUSA events found.</p>
{% endif %}

<p style="margin-top:15px;color:var(--text-light);font-size:0.85rem;">View <a href="{{ url_for('riders.season_riders', season_name=season.name) }}" style="color:var(--accent);font-weight:600;">completed brevets</a> for this season.</p>
</div>

{% block extra_js %}
<script>
var activeRegion = 'all';
var activeDistance = 'all';

// Group events by month
function groupEventsByMonth() {
    const container = document.getElementById('events-container');
    const events = Array.from(container.querySelectorAll('.event-card'));

    // Group events by month
    const eventsByMonth = {};
    events.forEach(event => {
        const month = event.dataset.month; // Format: YYYY-MM
        if (!eventsByMonth[month]) {
            eventsByMonth[month] = [];
        }
        eventsByMonth[month].push(event);
    });

    // Clear container
    container.innerHTML = '';

    // Create month sections
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];

    Object.keys(eventsByMonth).sort().forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        const monthName = months[parseInt(month) - 1];

        // Create month section
        const monthSection = document.createElement('div');
        monthSection.className = 'month-section';
        monthSection.dataset.month = monthKey;

        // Create month header
        const monthHeader = document.createElement('div');
        monthHeader.className = 'month-header';
        monthHeader.textContent = monthName + ' ' + year;
        monthSection.appendChild(monthHeader);

        // Create events grid
        const eventsGrid = document.createElement('div');
        eventsGrid.className = 'events-grid';
        eventsByMonth[monthKey].forEach(event => {
            eventsGrid.appendChild(event);
        });
        monthSection.appendChild(eventsGrid);

        container.appendChild(monthSection);
    });
}

function applyFilters() {
    document.querySelectorAll('.event-card').forEach(function(event) {
        var regionMatch = activeRegion === 'all' || event.dataset.region === activeRegion;
        var distanceMatch = activeDistance === 'all' || event.dataset.distance === activeDistance;
        if (regionMatch && distanceMatch) {
            event.classList.remove('hidden');
        } else {
            event.classList.add('hidden');
        }
    });

    // Hide empty month sections
    document.querySelectorAll('.month-section').forEach(function(section) {
        const visibleEvents = section.querySelectorAll('.event-card:not(.hidden)');
        if (visibleEvents.length === 0) {
            section.style.display = 'none';
        } else {
            section.style.display = 'block';
        }
    });
}

function filterByRegion(region) {
    activeRegion = region;
    document.querySelectorAll('[data-region].region-filter').forEach(function(f) { f.classList.remove('active'); });
    document.querySelector('[data-region="' + region + '"].region-filter').classList.add('active');
    applyFilters();
}

function filterByDistance(distance) {
    activeDistance = distance;
    document.querySelectorAll('[data-distance].region-filter').forEach(function(f) { f.classList.remove('active'); });
    document.querySelector('[data-distance="' + distance + '"].region-filter').classList.add('active');
    applyFilters();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    groupEventsByMonth();
});

// Highlight events within 4 days and add weather forecast links for events within 10 days
(function() {
    const now = new Date();
    const fourDaysFromNow = new Date(now.getTime() + (5 * 24 * 60 * 60 * 1000));
    const tenDaysFromNow = new Date(now.getTime() + (10 * 24 * 60 * 60 * 1000));
    
    document.querySelectorAll('.event-card').forEach(eventItem => {
        const eventDate = eventItem.dataset.eventDate; // format: YYYY-MM-DD
        const eventTime = eventItem.dataset.eventTime || '07:00'; // format: HH:MM
        const rwgpsUrl = eventItem.dataset.rwgpsUrl;
        const routeName = eventItem.dataset.routeName;
        
        if (!eventDate) return;
        
        // Parse event date and time
        const [year, month, day] = eventDate.split('-').map(Number);
        const [hours, minutes] = eventTime.split(':').map(Number);
        const eventDateTime = new Date(year, month - 1, day, hours, minutes);
        
        // Highlight events within 4 days with light green color
        if (eventDateTime <= fourDaysFromNow && eventDateTime >= now) {
            const eventDateElement = eventItem.querySelector('.event-date');
            if (eventDateElement) {
                eventDateElement.style.background = 'linear-gradient(135deg, #86efac, #4ade80)';
            }
        }
        
        // Add weather forecast link for events within 10 days
        if (rwgpsUrl && eventDateTime <= tenDaysFromNow && eventDateTime >= now) {
            // Extract route ID from rwgps URL
            const routeIdMatch = rwgpsUrl.match(/\/routes\/(\d+)/);
            if (!routeIdMatch) return;
            
            const routeId = routeIdMatch[1];
            const startTimestamp = Math.floor(eventDateTime.getTime() / 1000);
            const encodedName = encodeURIComponent(routeName);
            
            // Build weather forecast URL
            const weatherUrl = `https://www.randoplan.com/?pace=B%2B&interval=1&metric=false&rwgpsRoute=${routeId}&provider=weatherapi&name=${encodedName}&startTimestamp=${startTimestamp}&zone=America%2FLos_Angeles`;
            
            // Show and update the weather forecast link
            const weatherLinkContainer = eventItem.querySelector('.weather-forecast-link');
            if (weatherLinkContainer) {
                const weatherLink = weatherLinkContainer.querySelector('a');
                weatherLink.href = weatherUrl;
                weatherLinkContainer.style.display = 'inline-block';
            }
        }
    });
})();
</script>
{% endblock %}
{% endblock %}
