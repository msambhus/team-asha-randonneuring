{% extends "base.html" %}
{% block title %}Upcoming Brevets - {{ season_label }} - Team Asha Randonneuring{% endblock %}

{% block extra_head %}
<style>
.filter-section {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    border: 1px solid var(--border);
}
.filter-label {
    font-weight: 700;
    color: var(--primary);
    margin-bottom: 12px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
.filter-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
}
.region-filter {
    cursor: pointer;
    padding: 10px 18px;
    border-radius: 8px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 2px solid var(--border);
    background: white;
    font-weight: 600;
    font-size: 0.9rem;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.region-filter:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--primary);
}
.region-filter.active {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
    box-shadow: 0 4px 12px rgba(26, 54, 93, 0.3);
}
.region-filter.active .region-dot {
    background: white !important;
}
.region-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
}
.month-section {
    margin-bottom: 40px;
}
.month-header {
    background: linear-gradient(135deg, #0891b2, #0e7490);
    color: white;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 1.3rem;
    font-weight: 800;
    margin-bottom: 20px;
    display: inline-block;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 20px;
}
.event-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 300px;
}
.event-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    transition: transform 0.3s ease;
}
.event-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    border-color: var(--primary);
}
.event-card.hidden {
    display: none !important;
}
.event-date {
    position: absolute;
    top: 20px;
    right: 20px;
    text-align: center;
    background: linear-gradient(135deg, #1e40af, #1e3a8a);
    color: white;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
.event-day {
    font-size: 1.8rem;
    font-weight: 800;
    line-height: 1;
    color: white;
}
.event-month {
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-top: 2px;
    color: #fb923c;
}
.event-region-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 700;
    color: white;
    margin-bottom: 12px;
}
.event-distance {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--accent);
    margin-bottom: 8px;
}
.event-distance-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
    flex-wrap: wrap;
}
.popular-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border: 1.5px solid #fbbf24;
    color: #92400e;
    animation: pulse 2s ease-in-out infinite;
}
@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}
.event-elevation {
    font-size: 0.8rem;
    color: var(--text-light);
    font-weight: 500;
}
.event-title {
    font-size: 1.05rem;
    font-weight: 700;
    color: var(--primary);
    margin: 12px 0 8px 0;
    line-height: 1.4;
    padding-right: 80px;
}
.event-links {
    display: flex;
    gap: 8px;
    margin-top: 12px;
    flex-wrap: wrap;
}
.event-link-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s;
    border: 1px solid var(--border);
}
.event-link-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.event-details-info {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    font-size: 0.8rem;
    color: var(--text-light);
    display: flex;
    flex-direction: column;
    gap: 4px;
}
.signup-section {
    margin-top: auto;
    padding-top: 12px;
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: row;
    gap: 12px;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
}
.signup-actions {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
}
.signup-actions .signup-status {
    margin-right: auto;
}
.signup-count {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
    border: 1px solid #7dd3fc;
    color: #0369a1;
    cursor: pointer;
    transition: all 0.2s;
}
.signup-count:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-color: #0284c7;
}
.signup-count.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}
.signup-btn {
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    border: 2px solid var(--primary);
    background: white;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}
.signup-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(26, 54, 93, 0.2);
}
.signup-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
.signup-dropdown-container {
    position: relative;
    display: inline-block;
}
.signup-dropdown-btn {
    padding: 6px 14px;
    border-radius: 6px;
    font-size: 0.8rem;
    font-weight: 600;
    border: 2px solid var(--primary);
    background: white;
    color: var(--primary);
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}
.signup-dropdown-btn:hover {
    background: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(26, 54, 93, 0.2);
}
.signup-dropdown-btn.signed-up {
    background: linear-gradient(135deg, #dcfce7, #bbf7d0);
    color: #166534;
    border-color: #86efac;
}
.signup-dropdown-btn.signed-up:hover {
    background: linear-gradient(135deg, #bbf7d0, #86efac);
}
.signup-dropdown-btn.interested {
    background: linear-gradient(135deg, #fef9c3, #fef08a);
    color: #854d0e;
    border-color: #fde047;
}
.signup-dropdown-btn.interested:hover {
    background: linear-gradient(135deg, #fef08a, #fde68a);
}
.signup-dropdown-btn.maybe {
    background: linear-gradient(135deg, #ffedd5, #fed7aa);
    color: #9a3412;
    border-color: #fb923c;
}
.signup-dropdown-btn.maybe:hover {
    background: linear-gradient(135deg, #fed7aa, #fdba74);
}
.signup-dropdown-btn.withdraw {
    background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
    color: #374151;
    border-color: #9ca3af;
}
.signup-dropdown-btn.withdraw:hover {
    background: linear-gradient(135deg, #e5e7eb, #d1d5db);
}
.signup-dropdown-menu {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 4px;
    background: white;
    border: 2px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 100;
    min-width: 160px;
    overflow: hidden;
}
.signup-dropdown-menu.show {
    display: block;
    animation: dropdownSlide 0.2s ease-out;
}
@keyframes dropdownSlide {
    from { opacity: 0; transform: translateY(4px); }
    to { opacity: 1; transform: translateY(0); }
}
.signup-dropdown-item {
    padding: 10px 16px;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    border: none;
    background: none;
    width: 100%;
    text-align: left;
    color: var(--text);
}
.signup-dropdown-item:hover {
    background: #f8fafc;
}
.signup-dropdown-item.primary {
    color: var(--primary);
}
.signup-dropdown-item.danger {
    color: #dc2626;
    border-top: 1px solid var(--border);
}
.signup-dropdown-item.current {
    background: #f0f9ff;
    color: var(--primary);
    font-weight: 700;
}
.signup-status {
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
}
.signup-status.finished {
    background: linear-gradient(135deg, #dbeafe, #bfdbfe);
    color: #1e40af;
    border: 1px solid #93c5fd;
}
.uninterest-btn {
    background: none;
    border: none;
    color: var(--text-light);
    cursor: pointer;
    font-size: 0.85rem;
    padding: 2px 4px;
}
.uninterest-btn:hover { color: #dc2626; }
.signup-btn-sm { padding: 4px 10px; font-size: 0.75rem; }
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    animation: fadeIn 0.2s;
}
.modal-content {
    background: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    animation: slideIn 0.3s;
}
.modal-header {
    background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-title {
    font-size: 1.2rem;
    font-weight: 700;
    margin: 0;
}
.modal-close {
    font-size: 2rem;
    font-weight: 700;
    color: #000;
    cursor: pointer;
    border: 2px solid #000;
    background: #fff;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    padding: 0;
    transition: all 0.2s;
    flex-shrink: 0;
}
.modal-close:hover {
    background: #f3f4f6;
    border-color: #000;
    transform: rotate(90deg) scale(1.1);
}
.modal-body {
    padding: 20px;
    max-height: 60vh;
    overflow-y: auto;
}
.rider-list-item {
    display: grid;
    grid-template-columns: 40px 1fr auto auto;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
}
.rider-list-item:last-child {
    border-bottom: none;
}
.rider-list-item:hover {
    background: #f8fafc;
}
.rider-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
    flex-shrink: 0;
}
.rider-info {
    flex: 1;
}
.rider-name {
    font-weight: 600;
    color: var(--text);
    font-size: 0.95rem;
}
.rider-rusa {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 2px;
}
.rider-status-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}
.rider-status-badge.signed-up {
    background: #dcfce7;
    color: #166534;
}
.rider-status-badge.finished {
    background: #dbeafe;
    color: #1e40af;
}
.rider-status-badge.interested {
    background: #fef9c3;
    color: #854d0e;
    border: 1px solid #fde047;
}
.rider-status-badge.maybe {
    background: #ffedd5;
    color: #9a3412;
    border: 1px solid #fb923c;
}
.rider-status-badge.withdraw {
    background: #f3f4f6;
    color: #374151;
    border: 1px solid #9ca3af;
}
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}

/* Mobile-specific styles */
@media (max-width: 768px) {
    .events-grid {
        grid-template-columns: 1fr;
    }
    .filter-section {
        padding: 15px;
    }
    .filter-buttons {
        gap: 8px;
    }
    .region-filter {
        padding: 8px 14px;
        font-size: 0.85rem;
    }
    .event-card {
        padding: 16px;
    }
    .event-title {
        font-size: 0.95rem;
        padding-right: 70px;
    }
    .event-date {
        top: 16px;
        right: 16px;
        padding: 6px 10px;
    }
    .event-day {
        font-size: 1.5rem;
    }
    .month-header {
        font-size: 1.1rem;
        padding: 10px 16px;
    }
}

@media (max-width: 480px) {
    .region-filter {
        font-size: 0.8rem;
        padding: 7px 12px;
    }
    .event-distance {
        font-size: 1.3rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="hero" style="padding:40px 20px;">
<h1>Upcoming Brevets</h1>
<p>{{ season_label }} &mdash; RUSA events in the Bay Area</p>
</div>

<div class="container section">
<h2 style="margin-bottom:25px;">Ride Calendar</h2>

<div class="filter-section">
    <div class="filter-label">Filter by Club</div>
    <div class="filter-buttons">
        <span class="region-filter active" data-region="all" onclick="filterByRegion('all')">
            <span class="region-dot" style="background:#666;"></span>All Clubs
        </span>
        {% for region, color in region_colors.items() %}
        <span class="region-filter" data-region="{{ region }}" onclick="filterByRegion('{{ region }}')">
            <span class="region-dot" style="background:{{ color }};"></span>{{ region }}
        </span>
        {% endfor %}
    </div>

    {% if distances %}
    <div class="filter-label" style="margin-top:20px;">Filter by Distance</div>
    <div class="filter-buttons">
        <span class="region-filter active" data-distance="all" onclick="filterByDistance('all')">All Distances</span>
        {% for d in distances %}
        <span class="region-filter" data-distance="{{ d }}" onclick="filterByDistance('{{ d }}')">{{ d }}k</span>
        {% endfor %}
    </div>
    {% endif %}
</div>

<p style="font-size:0.85rem;color:var(--text-light);margin-bottom:30px;">Events sourced from <a href="https://rusa.org/cgi-bin/eventsearch_GF.pl" target="_blank" style="color:var(--accent);font-weight:600;">RUSA</a> for Davis, San Francisco &amp; Santa Cruz regions.</p>

<div id="events-container">
{% for event in rusa_events %}
<div class="event-card" data-event-card-id="{{ event.id }}" data-region="{{ event.region }}" data-distance="{{ event.distance_km }}" data-event-date="{{ event.date }}" data-event-time="{{ event.start_time or '07:00' }}" data-rwgps-url="{{ event.rwgps_url or '' }}" data-weather-rwgps-url="{{ event.plan_rwgps_url_team or event.rwgps_url or '' }}" data-route-name="{{ event.route_name }}" data-month="{{ event.date_str[0:7] }}" style="border-left-color:{{ region_colors.get(event.region, '#999') }};">

    <div class="event-date">
        <div class="event-day">{{ event.date_str[8:10] }}</div>
        <div class="event-month">{{ ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'][event.date_str[5:7]|int] }}</div>
    </div>

    <div class="event-region-badge" style="background:{{ region_colors.get(event.region, '#999') }};">
        <span class="region-dot" style="background:white;"></span>{{ event.region }}
    </div>

    <div class="event-distance">
        <div class="event-distance-row">
            <span>
                {% if event.distance_miles %}
                {{ "%.1f"|format(event.distance_miles) }} mi
                {% else %}
                {{ event.distance_km }} km
                {% endif %}
            </span>
            {% if event.signup_count and event.signup_count >= 5 %}
            <span class="popular-badge">
                üî•üî•
            </span>
            {% endif %}
        </div>
        {% if event.elevation_ft %}
        {% set miles = event.distance_miles if event.distance_miles else (event.distance_km * 0.621371) %}
        <div class="event-elevation">
            {{ "{:,}".format(event.elevation_ft) }} ft{% if miles > 0 %} ({{ "%.0f"|format(event.elevation_ft / miles) }} ft/mi){% endif %}
        </div>
        {% endif %}
    </div>

    <div class="event-title" style="overflow-wrap:break-word;word-break:break-word;display:flex;align-items:center;gap:10px;">
        <span style="flex:1;">
            {% if 'DART' in event.route_name or 'Dart' in event.route_name or 'Fleche' in event.route_name or (event.rwgps_url and ('dart' in event.rwgps_url.lower() or 'fleche' in event.rwgps_url.lower() or 'sfrandonneurs.org/fleche' in event.rwgps_url.lower())) %}
            <span style="color:var(--accent);font-weight:800;">[DART]</span>
            {% endif %}
            {{ event.route_name }}{% if event.ride_type %} <span style="color:var(--text-light);font-size:0.75rem;font-weight:600;white-space:nowrap;">[{{ event.ride_type }}]</span>{% endif %}
        </span>
        {% if can_edit_rides %}
        <button onclick="openEditModal({{ event.id }}, '{{ event.route_name|replace("'", "\\'") }}', '{{ event.rwgps_url|replace("'", "\\'")|default('', true) }}', {{ event.ride_plan_id|default('null', true) }}, '{{ event.start_time|replace("'", "\\'")|default('', true) }}', '{{ event.start_location|replace("'", "\\'")|default('', true) }}', {{ event.time_limit_hours|default('null', true) }})" 
                style="background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;color:#6d28d9;font-size:0.85rem;transition:transform 0.2s,color 0.2s;"
                onmouseover="this.style.transform='scale(1.15)';this.style.color='#5b21b6';"
                onmouseout="this.style.transform='scale(1)';this.style.color='#6d28d9';"
                title="Edit ride details">
            ‚úèÔ∏è
        </button>
        {% endif %}
    </div>

    <div class="event-links">
        {% if event.rwgps_url %}
        <a href="{{ event.rwgps_url }}" target="_blank" class="event-link-btn" style="background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-color:#7dd3fc;color:#0369a1;">
            <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:16px;height:16px;">
            Route
        </a>
        {% endif %}

        <span class="weather-forecast-link" style="display:none;">
            <a href="#" target="_blank" class="event-link-btn" style="background:linear-gradient(135deg,#fef3c7,#fde68a);border-color:#fbbf24;color:#92400e;">
                üå§Ô∏è Weather
            </a>
        </span>

        {% if event.plan_rwgps_url_team %}
        <a href="{{ event.plan_rwgps_url_team }}" target="_blank" class="event-link-btn" style="background:linear-gradient(135deg,#fff7ed,#ffedd5);border-color:#ff6b00;color:#c2410c;">
            <img src="https://ridewithgps.com/favicon.ico" alt="" style="width:16px;height:16px;">
            Team Asha Route
        </a>
        {% endif %}

        {% if event.plan_slug %}
        <a href="{% if event.has_custom_plan %}{{ url_for('riders.custom_ride_plan_view', slug=event.plan_slug) }}{% else %}{{ url_for('riders.ride_plan_detail', slug=event.plan_slug) }}{% endif %}" class="event-link-btn" style="background:linear-gradient(135deg,#f0f4ff,#e8f0fe);border-color:#c7d2fe;color:#4338ca;">
            üìç Ride Plan{% if event.has_custom_plan %} (Custom){% endif %}
        </a>
        {% endif %}
    </div>

    {% if event.start_time or event.time_limit_hours or event.start_location %}
    <div class="event-details-info">
        {% if event.start_time %}
        <div><strong>Start:</strong> {{ event.start_time }}</div>
        {% endif %}
        {% if event.time_limit_hours %}
        <div><strong>Time Limit:</strong> {{ event.time_limit_hours }}h</div>
        {% endif %}
        {% if event.start_location %}
        <div><strong>Location:</strong> {{ event.start_location }}</div>
        {% endif %}
    </div>
    {% endif %}

    <div class="signup-section">
        <div class="signup-count {% if not event.signup_count or event.signup_count == 0 %}disabled{% endif %}" {% if event.signup_count and event.signup_count > 0 %}onclick="showSignups({{ event.id }}, '{{ event.route_name|replace("'", "\\'") }}')"{% endif %}>
            <svg viewBox="0 0 20 20" width="16" height="16" fill="currentColor">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
            </svg>
            <span id="signup-count-{{ event.id }}">{{ event.signup_count or 0 }}</span> Riders
        </div>

        <div class="signup-actions">
        {% if current_rider_id %}
            {% set user_status = user_signups.get(event.id) %}
            {% if user_status in ['FINISHED', 'DNF', 'DNS', 'OTL'] %}
                <span class="signup-status finished">{{ user_status }}</span>
            {% else %}
                <div class="signup-dropdown-container" data-ride-id="{{ event.id }}" data-club-code="{{ event.club_code }}">
                    <button class="signup-dropdown-btn {% if user_status == 'GOING' %}signed-up{% elif user_status == 'INTERESTED' %}interested{% elif user_status == 'MAYBE' %}maybe{% elif user_status == 'WITHDRAW' %}withdraw{% endif %}" 
                            onclick="toggleSignupDropdown({{ event.id }}, event)">
                        {% if user_status == 'GOING' %}
                            <span>&#x2713; Going</span>
                        {% elif user_status == 'INTERESTED' %}
                            <span>&#x2605; Interested</span>
                        {% elif user_status == 'MAYBE' %}
                            <span>&#x003F; Maybe</span>
                        {% elif user_status == 'WITHDRAW' %}
                            <span>&#x229D; Withdraw</span>
                        {% else %}
                            <span>Going</span>
                        {% endif %}
                        <span style="font-size:0.7rem;">&#x25BE;</span>
                    </button>
                    <div class="signup-dropdown-menu" id="dropdown-{{ event.id }}">
                        <!-- Dropdown content will be generated by JavaScript -->
                    </div>
                </div>
            {% endif %}
        {% else %}
            <a href="{{ url_for('auth.login', next=request.path) }}" class="signup-btn" style="text-decoration:none;">
                Going
            </a>
        {% endif %}
        </div>
    </div>
</div>
{% endfor %}
</div>

{% if not rusa_events %}
<p style="padding:40px;color:var(--text-light);text-align:center;font-size:1.1rem;">No upcoming RUSA events found.</p>
{% endif %}

<p style="margin-top:15px;color:var(--text-light);font-size:0.85rem;">View <a href="{{ url_for('riders.season_riders', season_name=season.name) }}" style="color:var(--accent);font-weight:600;">completed brevets</a> for this season.</p>
</div>

<!-- Signups Modal -->
<div id="signups-modal" class="modal" onclick="closeModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 class="modal-title" id="modal-title">Riders List</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body" id="modal-body">
            <p style="text-align:center;color:var(--text-light);padding:20px;">Loading...</p>
        </div>
    </div>
</div>

<!-- External Club Registration Reminder Modal -->
<div id="external-club-modal" class="modal" onclick="closeExternalClubModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:500px;">
        <div class="modal-header">
            <h2 class="modal-title">‚ö†Ô∏è External Club Registration Required</h2>
            <button class="modal-close" onclick="closeExternalClubModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p style="margin-bottom:16px;color:var(--text);line-height:1.6;">
                This is an external club event. You must register on their official website:
            </p>
            <div id="club-registration-info" style="background:#f8fafc;border:2px solid var(--border);border-radius:8px;padding:16px;margin-bottom:16px;">
                <!-- Club-specific info will be inserted here -->
            </div>
            <p style="font-size:0.9rem;color:var(--text-light);margin-bottom:20px;">
                You can still sign up on Team Asha to show your interest and connect with other riders.
            </p>
            <div style="display:flex;gap:12px;">
                <button onclick="proceedWithSignup()" class="btn btn-primary" style="flex:1;">
                    Continue to Team Asha Sign Up
                </button>
                <button onclick="closeExternalClubModal()" class="btn" style="flex:1;background:var(--text-light);color:white;">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Ride Modal -->
<div id="edit-modal" class="modal" onclick="closeEditModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()" style="max-width:600px;">
        <div class="modal-header">
            <h2 class="modal-title" id="edit-modal-title">Edit Brevet</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="edit-ride-form" onsubmit="submitEditForm(event)">
                <input type="hidden" id="edit-ride-id" name="ride_id">
                
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--primary);">Route URL (RideWithGPS)</label>
                    <input type="url" id="edit-rwgps-url" name="rwgps_url" 
                           style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.9rem;"
                           placeholder="https://ridewithgps.com/routes/...">
                    <small style="color:var(--text-light);font-size:0.8rem;">Leave empty to remove</small>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--primary);">Team Asha Route (Ride Plan)</label>
                    <select id="edit-ride-plan" name="ride_plan_id" 
                            style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.9rem;">
                        <option value="">-- None --</option>
                        {% for plan in all_ride_plans %}
                        <option value="{{ plan.id }}">
                            {{ plan.name }} ({{ plan.distance_km }}km)
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color:var(--text-light);font-size:0.8rem;">Select from available ride plans</small>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--primary);">Start Time</label>
                    <input type="time" id="edit-start-time" name="start_time" 
                           style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.9rem;">
                    <small style="color:var(--text-light);font-size:0.8rem;">24-hour format (e.g., 07:00)</small>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--primary);">Start Location</label>
                    <input type="text" id="edit-start-location" name="start_location" 
                           style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.9rem;"
                           placeholder="e.g., Golden Gate Park">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block;font-weight:600;margin-bottom:8px;color:var(--primary);">Time Limit (hours)</label>
                    <input type="number" id="edit-time-limit" name="time_limit_hours" step="0.5" min="0"
                           style="width:100%;padding:10px;border:2px solid var(--border);border-radius:8px;font-size:0.9rem;"
                           placeholder="e.g., 13.5">
                </div>
                
                <div style="display:flex;gap:12px;margin-top:24px;">
                    <button type="submit" class="btn btn-primary" style="flex:1;">
                        Save Changes
                    </button>
                    <button type="button" onclick="closeEditModal()" class="btn" style="flex:1;background:var(--text-light);color:white;">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
var activeRegion = 'all';
var activeDistance = 'all';

// Edit Modal Functions
function openEditModal(rideId, rideName, rwgpsUrl, ridePlanId, startTime, startLocation, timeLimit) {
    document.getElementById('edit-modal-title').textContent = 'Edit: ' + rideName;
    document.getElementById('edit-ride-id').value = rideId;
    
    // Set all current values with proper null handling
    document.getElementById('edit-rwgps-url').value = rwgpsUrl && rwgpsUrl !== 'null' ? rwgpsUrl : '';
    document.getElementById('edit-ride-plan').value = ridePlanId && ridePlanId !== 'null' && ridePlanId !== null ? ridePlanId : '';
    
    // Format start time to HH:MM format (HTML5 time input requires leading zeros)
    let formattedTime = '';
    if (startTime && startTime !== 'null' && startTime.trim() !== '') {
        // If time is like "8:00", convert to "08:00"
        let timeParts = startTime.trim().split(':');
        if (timeParts.length === 2) {
            formattedTime = timeParts[0].padStart(2, '0') + ':' + timeParts[1].padStart(2, '0');
        } else {
            formattedTime = startTime;
        }
    }
    document.getElementById('edit-start-time').value = formattedTime;
    
    document.getElementById('edit-start-location').value = startLocation && startLocation !== 'null' ? startLocation : '';
    document.getElementById('edit-time-limit').value = timeLimit && timeLimit !== 'null' && timeLimit !== null ? timeLimit : '';
    
    document.getElementById('edit-modal').style.display = 'flex';
}

function closeEditModal(event) {
    if (event && event.target !== event.currentTarget) return;
    document.getElementById('edit-modal').style.display = 'none';
}

function submitEditForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('edit-ride-form');
    const formData = new FormData(form);
    const rideId = document.getElementById('edit-ride-id').value;
    
    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Saving...';
    submitBtn.disabled = true;
    
    fetch('/ride/' + rideId + '/edit', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeEditModal();
            // Reload the page to show updated data
            window.location.reload();
        } else {
            alert('Error updating ride: ' + (data.error || 'Unknown error'));
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating ride. Please try again.');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// Group events by month
function groupEventsByMonth() {
    const container = document.getElementById('events-container');
    const events = Array.from(container.querySelectorAll('.event-card'));

    // Group events by month
    const eventsByMonth = {};
    events.forEach(event => {
        const month = event.dataset.month; // Format: YYYY-MM
        if (!eventsByMonth[month]) {
            eventsByMonth[month] = [];
        }
        eventsByMonth[month].push(event);
    });

    // Clear container
    container.innerHTML = '';

    // Create month sections
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'];

    Object.keys(eventsByMonth).sort().forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        const monthName = months[parseInt(month) - 1];

        // Create month section
        const monthSection = document.createElement('div');
        monthSection.className = 'month-section';
        monthSection.dataset.month = monthKey;

        // Create month header
        const monthHeader = document.createElement('div');
        monthHeader.className = 'month-header';
        monthHeader.textContent = monthName + ' ' + year;
        monthSection.appendChild(monthHeader);

        // Create events grid
        const eventsGrid = document.createElement('div');
        eventsGrid.className = 'events-grid';
        eventsByMonth[monthKey].forEach(event => {
            eventsGrid.appendChild(event);
        });
        monthSection.appendChild(eventsGrid);

        container.appendChild(monthSection);
    });
}

function applyFilters() {
    document.querySelectorAll('.event-card').forEach(function(event) {
        var regionMatch = activeRegion === 'all' || event.dataset.region === activeRegion;
        var distanceMatch = activeDistance === 'all' || event.dataset.distance === activeDistance;
        if (regionMatch && distanceMatch) {
            event.classList.remove('hidden');
        } else {
            event.classList.add('hidden');
        }
    });

    // Hide empty month sections
    document.querySelectorAll('.month-section').forEach(function(section) {
        const visibleEvents = section.querySelectorAll('.event-card:not(.hidden)');
        if (visibleEvents.length === 0) {
            section.style.display = 'none';
        } else {
            section.style.display = 'block';
        }
    });
}

function filterByRegion(region) {
    activeRegion = region;
    document.querySelectorAll('[data-region].region-filter').forEach(function(f) { f.classList.remove('active'); });
    document.querySelector('[data-region="' + region + '"].region-filter').classList.add('active');
    applyFilters();
}

function filterByDistance(distance) {
    activeDistance = distance;
    document.querySelectorAll('[data-distance].region-filter').forEach(function(f) { f.classList.remove('active'); });
    document.querySelector('[data-distance="' + distance + '"].region-filter').classList.add('active');
    applyFilters();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    groupEventsByMonth();
});

// Dropdown menu management
function toggleSignupDropdown(rideId, event) {
    event.stopPropagation();
    
    const dropdown = document.getElementById('dropdown-' + rideId);
    const container = dropdown.closest('.signup-dropdown-container');
    const button = container.querySelector('.signup-dropdown-btn');
    const clubCode = container.getAttribute('data-club-code');
    
    // Close all other dropdowns
    document.querySelectorAll('.signup-dropdown-menu.show').forEach(menu => {
        if (menu.id !== 'dropdown-' + rideId) {
            menu.classList.remove('show');
        }
    });
    
    // Toggle this dropdown
    const isShowing = dropdown.classList.contains('show');
    if (isShowing) {
        dropdown.classList.remove('show');
        return;
    }
    
    // Determine current status
    const currentStatus = button.classList.contains('signed-up') ? 'GOING' : 
                         button.classList.contains('interested') ? 'INTERESTED' :
                         button.classList.contains('maybe') ? 'MAYBE' :
                         button.classList.contains('withdraw') ? 'WITHDRAW' : null;
    
    let menuHTML = '';
    
    // Workflow logic based on current status
    if (!currentStatus) {
        // Initial state: Show Interested, Maybe, Going
        menuHTML += `
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'INTERESTED', '${clubCode}', event)">
                <span>&#x2605;</span> Interested
            </button>
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'MAYBE', '${clubCode}', event)">
                <span>&#x003F;</span> Maybe
            </button>
            <button class="signup-dropdown-item primary" onclick="handleStatusChange(${rideId}, 'GOING', '${clubCode}', event)">
                <span>&#x2713;</span> Going
            </button>
        `;
    } else if (currentStatus === 'INTERESTED') {
        // From Interested: Maybe, Going, Clear
        menuHTML += `
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'MAYBE', '${clubCode}', event)">
                <span>&#x003F;</span> Maybe
            </button>
            <button class="signup-dropdown-item primary" onclick="handleStatusChange(${rideId}, 'GOING', '${clubCode}', event)">
                <span>&#x2713;</span> Going
            </button>
            <button class="signup-dropdown-item danger" onclick="handleStatusChange(${rideId}, 'CLEAR', '${clubCode}', event)">
                <span>&#x2715;</span> Clear Status
            </button>
        `;
    } else if (currentStatus === 'MAYBE') {
        // From Maybe: Interested, Going, Clear
        menuHTML += `
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'INTERESTED', '${clubCode}', event)">
                <span>&#x2605;</span> Interested
            </button>
            <button class="signup-dropdown-item primary" onclick="handleStatusChange(${rideId}, 'GOING', '${clubCode}', event)">
                <span>&#x2713;</span> Going
            </button>
            <button class="signup-dropdown-item danger" onclick="handleStatusChange(${rideId}, 'CLEAR', '${clubCode}', event)">
                <span>&#x2715;</span> Clear Status
            </button>
        `;
    } else if (currentStatus === 'GOING') {
        // From Going: Maybe, Withdraw
        menuHTML += `
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'MAYBE', '${clubCode}', event)">
                <span>&#x003F;</span> Maybe
            </button>
            <button class="signup-dropdown-item danger" onclick="handleStatusChange(${rideId}, 'WITHDRAW', '${clubCode}', event)">
                <span>&#x229D;</span> Withdraw
            </button>
        `;
    } else if (currentStatus === 'WITHDRAW') {
        // From Withdraw: Maybe, Going, Interested
        menuHTML += `
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'MAYBE', '${clubCode}', event)">
                <span>&#x003F;</span> Maybe
            </button>
            <button class="signup-dropdown-item primary" onclick="handleStatusChange(${rideId}, 'GOING', '${clubCode}', event)">
                <span>&#x2713;</span> Going
            </button>
            <button class="signup-dropdown-item" onclick="handleStatusChange(${rideId}, 'INTERESTED', '${clubCode}', event)">
                <span>&#x2605;</span> Interested
            </button>
        `;
    }
    
    dropdown.innerHTML = menuHTML;
    dropdown.classList.add('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.signup-dropdown-container')) {
        document.querySelectorAll('.signup-dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

function handleStatusChange(rideId, newStatus, clubCode, event) {
    event.stopPropagation();
    
    // Close dropdown
    const dropdown = document.getElementById('dropdown-' + rideId);
    dropdown.classList.remove('show');
    
    const container = dropdown.closest('.signup-dropdown-container');
    const button = container.querySelector('.signup-dropdown-btn');
    const currentStatus = button.classList.contains('signed-up') ? 'GOING' : 
                         button.classList.contains('interested') ? 'INTERESTED' :
                         button.classList.contains('maybe') ? 'MAYBE' :
                         button.classList.contains('withdraw') ? 'WITHDRAW' : null;
    
    if (newStatus === 'CLEAR') {
        // Clear status
        clearStatus(rideId, button, currentStatus);
    } else if (newStatus === 'GOING') {
        // Check if external club and show reminder (but skip if coming from WITHDRAW - they already registered)
        if (clubCode && clubCode !== 'TA' && currentStatus !== 'WITHDRAW') {
            showExternalClubReminder(clubCode, rideId, button, currentStatus);
        } else {
            performStatusChange(rideId, newStatus, button, currentStatus);
        }
    } else {
        // INTERESTED, MAYBE, or WITHDRAW
        performStatusChange(rideId, newStatus, button, currentStatus);
    }
}

function performStatusChange(rideId, newStatus, button, currentStatus) {
    // Map status to API endpoint
    const endpointMap = {
        'GOING': 'signup',
        'INTERESTED': 'interested',
        'MAYBE': 'maybe',
        'WITHDRAW': 'withdraw'
    };
    const endpoint = endpointMap[newStatus];
    
    if (!endpoint) {
        console.error('Unknown status:', newStatus);
        return;
    }
    
    // Update button text to loading
    const originalHTML = button.innerHTML;
    button.innerHTML = '<span>...</span>';
    button.disabled = true;
    
    fetch('/signup/api/' + rideId + '/' + endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => { throw data; });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update count based on status transitions
            const countEl = document.getElementById('signup-count-' + rideId);
            if (countEl) {
                let countChange = 0;
                
                // Increment count when: no status ‚Üí any status, or WITHDRAW ‚Üí any other status
                if (!currentStatus || currentStatus === 'WITHDRAW') {
                    countChange = 1;
                }
                // Decrement count when: any status ‚Üí WITHDRAW
                else if (newStatus === 'WITHDRAW') {
                    countChange = -1;
                }
                
                if (countChange !== 0) {
                    const newCount = Math.max(0, parseInt(countEl.textContent) + countChange);
                    countEl.textContent = newCount;
                    const countBadge = countEl.closest('.signup-count');
                    if (countBadge) {
                        if (newCount === 0) {
                            countBadge.classList.add('disabled');
                            countBadge.onclick = null;
                        } else {
                            countBadge.classList.remove('disabled');
                            const eventCard = button.closest('.event-card');
                            const routeName = eventCard ? eventCard.getAttribute('data-route-name') : '';
                            countBadge.onclick = function() { showSignups(rideId, routeName); };
                        }
                    }
                    updatePopularBadge(rideId, newCount);
                }
            }
            
            // Update button appearance
            updateButtonStatus(button, newStatus);
        } else if (data.redirect) {
            alert('Please log in to continue');
            window.location.href = data.redirect;
        } else {
            alert(data.error || 'Failed to update status');
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    })
    .catch(error => {
        if (error && error.redirect) {
            alert('Please log in to continue');
            window.location.href = error.redirect;
        } else {
            console.error('Error:', error);
            alert(error.error || 'Failed to update status. Please try again.');
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    });
}

function clearStatus(rideId, button, currentStatus) {
    if (!confirm('Are you sure you want to clear your status?')) {
        return;
    }
    
    const originalHTML = button.innerHTML;
    button.innerHTML = '<span>...</span>';
    button.disabled = true;
    
    fetch('/signup/api/' + rideId + '/unsignup', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Failed to clear status');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Decrement count only if had a status (and not WITHDRAW)
            const countEl = document.getElementById('signup-count-' + rideId);
            if (countEl && currentStatus && currentStatus !== 'WITHDRAW') {
                const newCount = Math.max(0, parseInt(countEl.textContent) - 1);
                countEl.textContent = newCount;
                const countBadge = countEl.closest('.signup-count');
                if (countBadge && newCount === 0) {
                    countBadge.classList.add('disabled');
                    countBadge.onclick = null;
                }
                updatePopularBadge(rideId, newCount);
            }
            
            // Reset button to initial state
            updateButtonStatus(button, null);
        } else {
            alert(data.error || 'Failed to clear status');
            button.innerHTML = originalHTML;
            button.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(error.message || 'Failed to clear status. Please try again.');
        button.innerHTML = originalHTML;
        button.disabled = false;
    });
}

function updateButtonStatus(button, status) {
    button.disabled = false;
    button.classList.remove('signed-up', 'interested', 'maybe', 'withdraw');
    
    if (status === 'GOING') {
        button.classList.add('signed-up');
        button.innerHTML = '<span>&#x2713; Going</span><span style="font-size:0.7rem;">&#x25BE;</span>';
    } else if (status === 'INTERESTED') {
        button.classList.add('interested');
        button.innerHTML = '<span>&#x2605; Interested</span><span style="font-size:0.7rem;">&#x25BE;</span>';
    } else if (status === 'MAYBE') {
        button.classList.add('maybe');
        button.innerHTML = '<span>&#x003F; Maybe</span><span style="font-size:0.7rem;">&#x25BE;</span>';
    } else if (status === 'WITHDRAW') {
        button.classList.add('withdraw');
        button.innerHTML = '<span>&#x229D; Withdraw</span><span style="font-size:0.7rem;">&#x25BE;</span>';
    } else {
        button.innerHTML = '<span>Going</span><span style="font-size:0.7rem;">&#x25BE;</span>';
    }
}

// Signup functions
function updatePopularBadge(rideId, count) {
    const eventCard = document.querySelector('[data-event-card-id="' + rideId + '"]');
    if (!eventCard) return;
    
    const distanceRow = eventCard.querySelector('.event-distance-row');
    if (!distanceRow) return;
    
    let popularBadge = distanceRow.querySelector('.popular-badge');
    
    if (count >= 5) {
        // Show popular badge
        if (!popularBadge) {
            popularBadge = document.createElement('span');
            popularBadge.className = 'popular-badge';
            popularBadge.innerHTML = 'üî•üî•';
            distanceRow.appendChild(popularBadge);
        }
    } else {
        // Remove popular badge
        if (popularBadge) {
            popularBadge.remove();
        }
    }
}

// Store ride info for signup after confirmation
let pendingSignup = null;

function showExternalClubReminder(clubCode, rideId, button, currentStatus) {
    const modal = document.getElementById('external-club-modal');
    const infoDiv = document.getElementById('club-registration-info');
    
    // Store for later
    pendingSignup = { rideId, button, currentStatus };
    
    // Set club-specific information
    let clubInfo = '';
    switch(clubCode) {
        case 'SFR':
            clubInfo = '<strong>San Francisco Randonneurs</strong><br><a href="https://sfrandonneurs.org/registration.htm" target="_blank" style="color:var(--primary);font-weight:600;">https://sfrandonneurs.org/registration.htm</a>';
            break;
        case 'SCR':
            clubInfo = '<strong>Santa Cruz Randonneurs</strong><br><a href="https://santacruzrandonneurs.org/pages/registration" target="_blank" style="color:var(--primary);font-weight:600;">https://santacruzrandonneurs.org/pages/registration</a>';
            break;
        case 'SRR':
            clubInfo = '<strong>Santa Rosa Randonneurs</strong><br><a href="https://www.santarosarandos.org/start-control-registration" target="_blank" style="color:var(--primary);font-weight:600;">https://www.santarosarandos.org/start-control-registration</a>';
            break;
        case 'DBC':
            clubInfo = '<strong>Davis Bike Club</strong><br><span style="color:var(--text);">Please sign up on the Davis Bike Club website.</span>';
            break;
        default:
            clubInfo = '<strong>External Club</strong><br><span style="color:var(--text);">Please register on the club\'s official website.</span>';
    }
    
    infoDiv.innerHTML = clubInfo;
    modal.style.display = 'flex';
}

function closeExternalClubModal(event) {
    const modal = document.getElementById('external-club-modal');
    if (!event || event.target === modal || event.target.classList.contains('modal-close')) {
        modal.style.display = 'none';
        pendingSignup = null;
    }
}

function proceedWithSignup() {
    if (pendingSignup) {
        // Store values before closing modal (which sets pendingSignup to null)
        const rideId = pendingSignup.rideId;
        const button = pendingSignup.button;
        const currentStatus = pendingSignup.currentStatus;
        
        // Close modal
        const modal = document.getElementById('external-club-modal');
        modal.style.display = 'none';
        pendingSignup = null;
        
        // Now proceed with signup
        performStatusChange(rideId, 'GOING', button, currentStatus);
    }
}

function showSignups(rideId, rideName) {
    const countElement = document.getElementById('signup-count-' + rideId);
    const count = parseInt(countElement.textContent);
    if (count === 0) return;
    
    const modal = document.getElementById('signups-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    
    modalTitle.innerHTML = '<span style="color:#fbbf24;">Riders List</span> <span style="margin-left:12px;background:#ffffff;color:#0369a1;padding:4px 12px;border-radius:20px;font-size:0.9rem;font-weight:700;">' + count + '</span>';
    modalBody.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">Loading...</p>';
    modal.style.display = 'block';
    
    fetch('/signup/api/' + rideId + '/signups')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update modal title with count
                modalTitle.innerHTML = '<span style="color:#fbbf24;">Riders List</span> <span style="margin-left:12px;background:#ffffff;color:#0369a1;padding:4px 12px;border-radius:20px;font-size:0.9rem;font-weight:700;">' + data.count + '</span>';
                
                if (data.count === 0) {
                    modalBody.innerHTML = '<p style="text-align:center;color:var(--text-light);padding:20px;">No riders signed up yet.</p>';
                } else {
                    // Sort: GOING first, then INTERESTED, then MAYBE, then WITHDRAW
                    const statusOrder = {'GOING': 1, 'INTERESTED': 2, 'MAYBE': 3, 'WITHDRAW': 4};
                    data.riders.sort((a, b) => {
                        return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
                    });
                    let html = '';
                    data.riders.forEach(rider => {
                        const initials = rider.first_name.charAt(0) + rider.last_name.charAt(0);
                        let badgeClass, badgeText;
                        
                        switch(rider.status) {
                            case 'GOING':
                                badgeClass = 'signed-up';
                                badgeText = '\u2713 Going';
                                break;
                            case 'INTERESTED':
                                badgeClass = 'interested';
                                badgeText = '\u2605 Interested';
                                break;
                            case 'MAYBE':
                                badgeClass = 'maybe';
                                badgeText = '\u003F Maybe';
                                break;
                            case 'WITHDRAW':
                                badgeClass = 'withdraw';
                                badgeText = '\u229D Withdraw';
                                break;
                            default:
                                badgeClass = 'signed-up';
                                badgeText = rider.status;
                        }
                        
                        html += `
                            <div class="rider-list-item">
                                <div class="rider-avatar">${initials}</div>
                                <div class="rider-name">${rider.first_name} ${rider.last_name}</div>
                                <div class="rider-rusa">RUSA #${rider.rusa_id}</div>
                                <span class="rider-status-badge ${badgeClass}">${badgeText}</span>
                            </div>
                        `;
                    });
                    modalBody.innerHTML = html;
                }
            } else {
                modalBody.innerHTML = '<p style="text-align:center;color:#dc2626;padding:20px;">Failed to load signups.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            modalBody.innerHTML = '<p style="text-align:center;color:#dc2626;padding:20px;">Failed to load signups.</p>';
        });
}

function closeModal(event) {
    const modal = document.getElementById('signups-modal');
    if (!event || event.target === modal) {
        modal.style.display = 'none';
    }
}

// Close modals and dropdowns on ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' || event.key === 'Esc') {
        // Close dropdowns
        document.querySelectorAll('.signup-dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
        
        const signupsModal = document.getElementById('signups-modal');
        if (signupsModal && signupsModal.style.display === 'flex') {
            signupsModal.style.display = 'none';
        }
        const editModal = document.getElementById('edit-modal');
        if (editModal && editModal.style.display === 'flex') {
            editModal.style.display = 'none';
        }
        const externalClubModal = document.getElementById('external-club-modal');
        if (externalClubModal && externalClubModal.style.display === 'flex') {
            closeExternalClubModal();
        }
    }
});

// Highlight events within 4 days and add weather forecast links for events within 10 days
(function() {
    const now = new Date();
    const fourDaysFromNow = new Date(now.getTime() + (5 * 24 * 60 * 60 * 1000));
    const tenDaysFromNow = new Date(now.getTime() + (10 * 24 * 60 * 60 * 1000));
    
    document.querySelectorAll('.event-card').forEach(eventItem => {
        const eventDate = eventItem.dataset.eventDate; // format: YYYY-MM-DD
        const eventTime = eventItem.dataset.eventTime || '07:00'; // format: HH:MM
        const rwgpsUrl = eventItem.dataset.rwgpsUrl;
        const weatherRwgpsUrl = eventItem.dataset.weatherRwgpsUrl; // Team Asha route preferred
        const routeName = eventItem.dataset.routeName;
        
        if (!eventDate) return;
        
        // Parse event date and time
        const [year, month, day] = eventDate.split('-').map(Number);
        const [hours, minutes] = eventTime.split(':').map(Number);
        const eventDateTime = new Date(year, month - 1, day, hours, minutes);
        
        // Highlight events within 4 days with light green color
        if (eventDateTime <= fourDaysFromNow && eventDateTime >= now) {
            const eventDateElement = eventItem.querySelector('.event-date');
            if (eventDateElement) {
                eventDateElement.style.background = 'linear-gradient(135deg, #86efac, #4ade80)';
            }
        }
        
        // Add weather forecast link for events within 10 days (use Team Asha route if available)
        if (weatherRwgpsUrl && eventDateTime <= tenDaysFromNow && eventDateTime >= now) {
            // Extract route ID from rwgps URL (prefer Team Asha route)
            const routeIdMatch = weatherRwgpsUrl.match(/\/routes\/(\d+)/);
            if (!routeIdMatch) return;
            
            const routeId = routeIdMatch[1];
            const startTimestamp = Math.floor(eventDateTime.getTime() / 1000);
            const encodedName = encodeURIComponent(routeName);
            
            // Build weather forecast URL
            const weatherUrl = `https://www.randoplan.com/?pace=B%2B&interval=1&metric=false&rwgpsRoute=${routeId}&provider=weatherapi&name=${encodedName}&startTimestamp=${startTimestamp}&zone=America%2FLos_Angeles`;
            
            // Show and update the weather forecast link
            const weatherLinkContainer = eventItem.querySelector('.weather-forecast-link');
            if (weatherLinkContainer) {
                const weatherLink = weatherLinkContainer.querySelector('a');
                weatherLink.href = weatherUrl;
                weatherLinkContainer.style.display = 'inline-block';
            }
        }
    });
})();
</script>
{% endblock %}
{% endblock %}
