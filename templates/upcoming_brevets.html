{% extends "base.html" %}
{% block title %}Upcoming Brevets - {{ season_label }} - Team Asha Randonneuring{% endblock %}

{% block extra_head %}
<style>
.region-filter {
    cursor: pointer;
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.2s;
    border: 2px solid transparent;
}
.region-filter:hover {
    background: rgba(0,0,0,0.05);
}
.region-filter.active {
    border-color: var(--primary);
    background: rgba(26, 54, 93, 0.1);
    font-weight: 700;
}
.event-item.hidden {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="hero" style="padding:40px 20px;">
<h1>Upcoming Brevets</h1>
<p>{{ season_label }} &mdash; RUSA events in the Bay Area</p>
</div>

<div class="container section">
<h2>Ride Calendar</h2>

<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:15px;">
<div style="display:flex;gap:8px;flex-wrap:wrap;font-size:0.85rem;">
    <span class="region-filter active" data-region="all" onclick="filterByRegion('all')" style="display:inline-flex;align-items:center;gap:4px;">
        <span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:#666;"></span>All Clubs
    </span>
    {% for region, color in region_colors.items() %}
    <span class="region-filter" data-region="{{ region }}" onclick="filterByRegion('{{ region }}')" style="display:inline-flex;align-items:center;gap:4px;">
        <span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:{{ color }};"></span>{{ region }}
    </span>
    {% endfor %}
</div>
</div>
<p style="font-size:0.8rem;color:var(--text-light);margin-bottom:15px;">Events sourced from <a href="https://rusa.org/cgi-bin/eventsearch_GF.pl" target="_blank" style="color:var(--accent);">RUSA</a> for Davis, San Francisco &amp; Santa Cruz regions.</p>

<div class="card">
{% for event in rusa_events %}
<div class="event-item" data-region="{{ event.region }}" data-event-date="{{ event.date }}" data-event-time="{{ event.start_time or '07:00' }}" data-rwgps-url="{{ event.rwgps_url or '' }}" data-route-name="{{ event.route_name }}" style="display:flex;align-items:flex-start;gap:12px;padding:12px 0;{% if not loop.last %}border-bottom:1px solid var(--border);{% endif %}">
<div style="min-width:48px;text-align:center;">
    <div style="font-size:0.75rem;color:var(--text-light);text-transform:uppercase;">{{ event.date[5:7] }}/{{ event.date[8:10] }}</div>
    <div style="font-size:1.4rem;font-weight:800;color:var(--primary);line-height:1;">{{ event.date[8:10] }}</div>
</div>
<div style="flex:1;min-width:0;">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <span style="display:inline-block;padding:2px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;color:white;background:{{ region_colors.get(event.region, '#999') }};">{{ event.region }}</span>
        <span style="font-weight:700;color:var(--accent);">
          {% if event.distance_miles %}
            {{ "%.1f"|format(event.distance_miles) }} mi
          {% else %}
            {{ event.distance_km }} km
          {% endif %}
        </span>
        {% if event.elevation_ft %}
        <span style="font-size:0.8rem;color:var(--text-light);">{{ "{:,}".format(event.elevation_ft) }} ft</span>
        {% endif %}
        <span style="font-size:0.8rem;color:var(--text-light);">{{ event.ride_type }}</span>
    </div>
    <div style="font-size:0.85rem;margin-top:4px;color:var(--text);">{% if 'DART' in event.route_name or 'Dart' in event.route_name or 'Fleche' in event.route_name or (event.rwgps_url and ('dart' in event.rwgps_url.lower() or 'fleche' in event.rwgps_url.lower() or 'sfrandonneurs.org/fleche' in event.rwgps_url.lower())) %}[DART] {% endif %}{{ event.route_name }}
    {% if event.climbing and not event.elevation_ft %}<span style="margin-left:8px;color:var(--text-light);font-size:0.75rem;">{{ event.climbing }}</span>{% endif %}
    {% if event.rwgps_url %}
    <a href="{{ event.rwgps_url }}" target="_blank" title="{% if 'Fleche' in event.route_name or (event.rwgps_url and ('fleche' in event.rwgps_url.lower() or 'sfrandonneurs.org/fleche' in event.rwgps_url.lower())) %}View Event on RideWithGPS{% else %}View Route on RideWithGPS{% endif %}" style="margin-left:8px;text-decoration:none;display:inline-flex;align-items:center;vertical-align:middle;">
      <img src="https://ridewithgps.com/favicon.ico" alt="RideWithGPS" style="width:20px;height:20px;vertical-align:middle;">
    </a>
    {% endif %}
    <span class="weather-forecast-link" style="margin-left:4px;display:none;">
      <a href="#" target="_blank" title="Weather Forecast" style="font-size:1.25rem;text-decoration:none;display:inline-flex;align-items:center;vertical-align:middle;line-height:1;">
        üå§Ô∏è
      </a>
    </span>
    </div>
    {% if event.start_time or event.time_limit_hours or event.start_location %}
    <div style="font-size:0.75rem;margin-top:6px;color:var(--text-light);display:flex;flex-wrap:wrap;gap:12px;">
      {% if event.start_time %}
      <span><strong>Start:</strong> {{ event.start_time }}</span>
      {% endif %}
      {% if event.time_limit_hours %}
      <span><strong>Time Limit:</strong> {{ event.time_limit_hours }}h</span>
      {% endif %}
      {% if event.start_location %}
      <span style="flex:1 1 100%;"><strong>Location:</strong> {{ event.start_location }}</span>
      {% endif %}
    </div>
    {% endif %}
</div>
</div>
{% endfor %}
{% if not rusa_events %}
<p style="padding:20px;color:var(--text-light);text-align:center;">No upcoming RUSA events found.</p>
{% endif %}
</div>

<p style="margin-top:15px;color:var(--text-light);font-size:0.85rem;">View <a href="{{ url_for('riders.season_riders', season_name=season.name) }}" style="color:var(--accent);font-weight:600;">completed brevets</a> for this season.</p>
</div>

{% block extra_js %}
<script>
function filterByRegion(region) {
    // Update active state on filters
    document.querySelectorAll('.region-filter').forEach(filter => {
        filter.classList.remove('active');
    });
    document.querySelector(`[data-region="${region}"]`).classList.add('active');
    
    // Show/hide events
    document.querySelectorAll('.event-item').forEach(event => {
        if (region === 'all') {
            event.classList.remove('hidden');
        } else {
            if (event.dataset.region === region) {
                event.classList.remove('hidden');
            } else {
                event.classList.add('hidden');
            }
        }
    });
}

// Add weather forecast links for events within 10 days
(function() {
    const now = new Date();
    const tenDaysFromNow = new Date(now.getTime() + (10 * 24 * 60 * 60 * 1000));
    
    document.querySelectorAll('.event-item').forEach(eventItem => {
        const eventDate = eventItem.dataset.eventDate; // format: YYYY-MM-DD
        const eventTime = eventItem.dataset.eventTime || '07:00'; // format: HH:MM
        const rwgpsUrl = eventItem.dataset.rwgpsUrl;
        const routeName = eventItem.dataset.routeName;
        
        if (!eventDate || !rwgpsUrl) return;
        
        // Parse event date and time
        const [year, month, day] = eventDate.split('-').map(Number);
        const [hours, minutes] = eventTime.split(':').map(Number);
        const eventDateTime = new Date(year, month - 1, day, hours, minutes);
        
        // Check if event is within 10 days
        if (eventDateTime <= tenDaysFromNow && eventDateTime >= now) {
            // Extract route ID from rwgps URL
            const routeIdMatch = rwgpsUrl.match(/\/routes\/(\d+)/);
            if (!routeIdMatch) return;
            
            const routeId = routeIdMatch[1];
            const startTimestamp = Math.floor(eventDateTime.getTime() / 1000);
            const encodedName = encodeURIComponent(routeName);
            
            // Build weather forecast URL
            const weatherUrl = `https://www.randoplan.com/?pace=B%2B&interval=1&metric=false&rwgpsRoute=${routeId}&provider=weatherapi&name=${encodedName}&startTimestamp=${startTimestamp}&zone=America%2FLos_Angeles`;
            
            // Show and update the weather forecast link
            const weatherLinkContainer = eventItem.querySelector('.weather-forecast-link');
            if (weatherLinkContainer) {
                const weatherLink = weatherLinkContainer.querySelector('a');
                weatherLink.href = weatherUrl;
                weatherLinkContainer.style.display = 'inline';
            }
        }
    });
})();
</script>
{% endblock %}
{% endblock %}
